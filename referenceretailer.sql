 1 PACKAGE BODY ReferenceRetailer AS
    2  
    3 
    4 
    5 
    6 
    7 
    8 
    9 
   10 
   11 
   12 
   13 
   14 
   15 
   16 
   17 
   18 
   19 
   20 
   21 
   22 
   23 
   24 
   25 
   26 
   27 
   28 
   29 
   30 
   31 
   32 
   33 
   34 
   35 
   36 
   37 
   38 
   39 
   40 
   41 
   42 
   43 
   44 
   45 
   46 
   47 
   48 
   49 
   50 
   51 
   52 
   53 
   54 
   55 
   56 
   57 
   58 
   59 
   60 
   61 
   62 
   63 
   64 
   65 
   66 
   67 
   68 
   69 
   70 
   71 
   72 
   73 
   74 
   75 
   76 
   77 
   78 
   79 
   80 
   81 
   82 
   83 
   84 
   85 
   86 
   87 
   88 
   89 
   90 
   91 
   92 
   93 
   94 
   95 
   96 
   97 
   98 
   99 
  100 
  101 
  102 
  103 
  104 
  105 
  106 
  107 
  108 
  109 
  110 
  111 
  112 
  113 
  114 
  115 
  116 
  117 
  118 
  119 
  120 
  121 
  122 
  123 
  124 
  125 
  126 
  127 
  128 
  129 
  130 
  131 
  132 
  133 
  134 
  135 
  136 
  137 
  138 
  139 
  140 
  141 
  142 
  143 
  144 
  145 
  146 
  147 
  148 
  149 
  150 
  151 
  152 
  153 
  154 
  155 
  156 
  157 
  158 
  159 
  160 
  161 
  162 
  163 
  164 
  165 
  166 
  167 
  168 
  169 
  170 
  171 
  172 
  173 
  174 
  175 
  176 
  177 
  178 
  179 
  180 
  181 
  182 
  183 
  184 
  185 
  186 
  187 
  188 
  189 
  190 
  191 
  192 
  193 
  194 
  195 
  196 
  197 
  198 
  199 
  200 
  201 
  202 
  203 
  204 
  205 
  206 
  207 
  208 
  209 
  210 
  211 
  212 
  213 
  214 
  215 
  216 
  217 
  218 
  219   
  220   CPACKAGENAME  CONSTANT VARCHAR2(64) := 'ReferenceRetailer';
  221 
  222   CBODYREVISION CONSTANT VARCHAR2(100) := '$Rev: 61956 $'; 
  223 
  224   TYPE TYPERETAILERRECORD IS RECORD
  225   (
  226     CODE           TREFERENCERETAILER.CODE%TYPE,
  227     IDENT          TREFERENCERETAILER.IDENT%TYPE,
  228     NAME           TREFERENCERETAILER.NAME%TYPE,
  229     FICODE         TREFERENCERETAILER.FICODE%TYPE,
  230     FINAME         TREFERENCEFI.NAME%TYPE,
  231     PARENTCODE     TREFERENCERETAILER.PARENTCODE%TYPE,
  232     INACTIVE       TREFERENCERETAILER.INACTIVE%TYPE,
  233     PARENTINACTIVE TREFERENCERETAILER.PARENTINACTIVE%TYPE,
  234     LEVEL          NUMBER,
  235     NODE           NUMBER,
  236     ITEM           VARCHAR(64),
  237     CAPTION        VARCHAR(128),
  238     ICON           VARCHAR(64)
  239   );
  240   TYPE TYPERETAILERLIST IS TABLE OF TYPERETAILERRECORD INDEX BY BINARY_INTEGER;
  241 
  242   SUBTYPE TYPERETAILERROW IS TREFERENCERETAILER % ROWTYPE;  
  243   CEMPTYROW TYPERETAILERROW;                                
  244 
  245   TYPE TYPERETAILERCONTACTS IS TABLE OF TYPERETAILERCONTACTROW INDEX BY BINARY_INTEGER; 
  246 
  247   SUBTYPE TYPEOBJECTPREFIX IS VARCHAR2(64);
  248   COPRETAILER CONSTANT TYPEOBJECTPREFIX := 'RETAILER';
  249 
  250   SUBTYPE TYPEDISPLAYMODE IS NUMBER;
  251   CDMACTIVE   CONSTANT TYPEDISPLAYMODE := CACTIVE;
  252   CDMINACTIVE CONSTANT TYPEDISPLAYMODE := CINACTIVE;
  253   
  254 
  255 
  256  
  257   
  258 
  259   
  260   SUBTYPE TYPEADDRESSVALUE IS NUMBER;
  261   CAVDEFAULT  CONSTANT TYPEADDRESSVALUE := 0;
  262   CAVLEGAL    CONSTANT TYPEADDRESSVALUE := 1;
  263   CAVCONTACT  CONSTANT TYPEADDRESSVALUE := 2;
  264   CAVPOSTAL   CONSTANT TYPEADDRESSVALUE := 3;
  265   CAVLIVING   CONSTANT TYPEADDRESSVALUE := 4;
  266   CAVREGISTER CONSTANT TYPEADDRESSVALUE := 5;
  267   
  268   
  269   
  270   CACCOUNTGROUPSETTLEMENT  CONSTANT CHAR := 'S';
  271   CACCOUNTGROUPACTIVE      CONSTANT CHAR := 'A';
  272   CACCOUNTGROUPPASSIVE     CONSTANT CHAR := 'P';
  273   
  274 
  275 
  276 
  277  SARRACCINFO TYPES.ARRSTR80;
  278 
  279  
  280 
  281  REG_NONE  CONSTANT TYPEALTERATIONMODE := CAMUNKNOWN;
  282  REG_ADD   CONSTANT TYPEALTERATIONMODE := CAMCREATE;
  283  REG_EDIT  CONSTANT TYPEALTERATIONMODE := CAMMODIFY;
  284 
  285  SREGIM           TYPEALTERATIONMODE:=REG_NONE;
  286  SREGIMCONTACT    TYPEALTERATIONMODE:=REG_NONE;
  287 
  288 
  289  SCONTACTS       TYPERETAILERCONTACTS;
  290  SCONTACTSCOUNT  NUMBER := 0;
  291  SCURCONTACT     NUMBER;
  292 
  293  SFINPAGE        NUMBER;
  294  SGRPPAGE        NUMBER;
  295  SPSPAGE         NUMBER;
  296  SMCCRANGESPAGE  NUMBER; 
  297 
  298  SUBTYPE TYPERETAILERROWTYPE IS TREFERENCERETAILER%ROWTYPE;  
  299 
  300  EMPTYRETAILERRECORD     APITYPES.TYPERETAILERRECORD;  
  301  SCURRENTRETAILERRECORD  APITYPES.TYPERETAILERRECORD;  
  302 
  303  SRETAILERLIST  TYPERETAILERLIST;                      
  304  
  305 
  306  SDSHANDLE NUMBER;  
  307 
  308  EMPTYUSERPROPLIST         APITYPES.TYPEUSERPROPLIST;                   
  309  SCURRENTUSERPROPLIST      APITYPES.TYPEUSERPROPLIST;                   
  310  SCURRENTDLGUSERATTRIBUTES APITYPES.TYPEUSERPROPLIST;                   
  311  SCURRENTEXTATTRIBUTELIST  APITYPES.TYPERETAILEREXTATTRIBUTELIST; 
  312  IDPAGEGENERAL        CONSTANT VARCHAR(16) := UPPER('General');         
  313 
  314  EXMOVALIDATION EXCEPTION; 
  315 
  316 
  317 
  318  PROCEDURE SETACCOUNT(PCANEDIT BOOLEAN); 
  319  PROCEDURE DELETEACC(PMAIN BOOLEAN);
  320  PROCEDURE SAVEOBJ (PMODE TYPEMODE, PALTERATIONMODE TYPEALTERATIONMODE, PUSEBLOCK BOOLEAN, PDIALOG NUMBER := NULL); 
  321  FUNCTION  DIALOGEDIT(PALTERATIONMODE NUMBER, PCANEDIT BOOLEAN, PFICODE NUMBER:=NULL, PDIALOGMODE TYPEDIALOGMODE := CDMREFERENCE) RETURN NUMBER;  
  322 
  323  FUNCTION  DIALOGCONTACT(PALTERATIONMODE NUMBER) RETURN NUMBER;
  324  PROCEDURE REFRESHCONTACTS(PDIALOG NUMBER);
  325  PROCEDURE REPOSCONTACTS(PDIALOG NUMBER);
  326 
  327  PROCEDURE SAVECONTACTSRETAIL (PCODE NUMBER); 
  328  PROCEDURE MAKECLIENTDIALOG(PDIALOG NUMBER, X NUMBER, Y NUMBER, DX NUMBER, PNAME VARCHAR:='Customer', PCLIENTTYPE NUMBER := CCLIENTCORPORATE); 
  329 
  330  
  331  FUNCTION  GETFREEHANDLE RETURN NUMBER;
  332  TYPE TYPEOBJECTMODEARRAY IS TABLE OF CHAR(1) INDEX BY BINARY_INTEGER;
  333  RETAILERMOD TYPEOBJECTMODEARRAY;
  334  BAD_THIS CONSTANT INTEGER := 0;
  335  
  336 
  337  
  338  PROCEDURE DELETEPROTOTYPE (PCODE NUMBER);
  339  
  340  PROCEDURE DELETERETAILER (PRETAILERROW TYPERETAILERROW, PLOG BOOLEAN); 
  341 
  342  PROCEDURE CONVERTROWTYPETOAPITYPES(PRETAILERROW IN TYPERETAILERROWTYPE,
  343                                     ORETAILERRECORD IN OUT NOCOPY APITYPES.TYPERETAILERRECORD,  
  344                                     PFILLGUID    IN BOOLEAN := FALSE); 
  345 
  346  PROCEDURE CONVERTAPITYPESTOROWTYPE(PRETAILERRECORD IN APITYPES.TYPERETAILERRECORD,
  347                                     ORETAILERROW IN OUT NOCOPY TYPERETAILERROWTYPE);  
  348 
  349  FUNCTION  INTERNALGETUID(PCODE NUMBER, PGUID TYPES.GUID := NULL) RETURN NUMBER;
  350  FUNCTION  UPDATEOBJECTUID(PCODE NUMBER, PGUID TYPES.GUID) RETURN NUMBER;  
  351 
  352  FUNCTION  HAVECHILDOBJECT(PPARENTCODE IN NUMBER) RETURN BOOLEAN;  
  353  FUNCTION  ISCHILDOBJECT(PPARENTCODE IN NUMBER, PCODE IN NUMBER) RETURN BOOLEAN;  
  354 
  355  FUNCTION  DIALOGCHILDLIST(PCODE IN NUMBER) RETURN NUMBER;  
  356  FUNCTION  DIALOGADDRESSCOPY(PPARENTDIALOGID IN NUMBER, PFICODE IN NUMBER, PIDCLIENT IN NUMBER, PCLIENTTYPE IN NUMBER) RETURN NUMBER;  
  357 
  358  PROCEDURE DELETERETAILER (PCODE NUMBER, PLOG BOOLEAN := TRUE); 
  359 
  360  PROCEDURE RUNSAVECONTROLBLOCK  (PMODE TYPEMODE, PALTERATIONMODE TYPEALTERATIONMODE); 
  361  PROCEDURE RUNUPDATEVALUESBLOCK (PMODE TYPEMODE, PALTERATIONMODE TYPEALTERATIONMODE); 
  362 
  363  PROCEDURE CLEARCURRENTUSERPROPLIST;                                               
  364  PROCEDURE SETCURRENTDLGUSERATTRIBUTES (PAUSERPROPLIST APITYPES.TYPEUSERPROPLIST); 
  365 
  366  PROCEDURE FILLCLIENTTYPEITEM(PDIALOG IN NUMBER, PITEM IN VARCHAR, PCMD IN NUMBER, PCLIENTTYPE IN NUMBER := CCLIENTCORPORATE); 
  367 
  368  
  369  PROCEDURE PUTPARAMLIST(PLOGLISTNO NUMBER, POLDROW TYPERETAILERROW := CEMPTYROW, PNEWROW TYPERETAILERROW := CEMPTYROW, PONLYMAINPARAMS BOOLEAN := FALSE); 
  370  PROCEDURE LOGCHANGES (PACTION A4MLOG.TYPEACTION,  POLDROW TYPERETAILERROW := CEMPTYROW, PNEWROW TYPERETAILERROW := CEMPTYROW, PREMARK VARCHAR2 := NULL, PONLYMAINPARAMS IN BOOLEAN := FALSE);  
  371  FUNCTION  GETLOGREMARK (POLDROW TYPERETAILERROW := CEMPTYROW, PNEWROW TYPERETAILERROW := CEMPTYROW) RETURN VARCHAR2;  
  372 
  373 
  374 
  375 FUNCTION GETVERSION RETURN VARCHAR2 IS
  376   BEGIN
  377     RETURN SERVICE.FORMATPACKAGEVERSION(CPACKAGENAME, CREVISION, CBODYREVISION);
  378   END;
  379 
  380 
  381 
  382 FUNCTION GETRIGHTKEY(PRIGHT IN NUMBER)
  383   RETURN VARCHAR IS
  384     CPROCNAME  CONSTANT VARCHAR2(80) := CPACKAGENAME || '.GetRightKey';
  385   BEGIN
  386     RETURN '|'||TO_CHAR(PRIGHT)||'|';
  387   EXCEPTION
  388     WHEN OTHERS THEN
  389       ERROR.SAVE(CPROCNAME);
  390       RAISE;
  391   END;
  392 
  393 
  394 
  395 FUNCTION CHECKRIGHT(PRIGHT IN NUMBER, PCODE IN NUMBER)  
  396   RETURN BOOLEAN IS
  397     CPROCNAME  CONSTANT VARCHAR2(80) := CPACKAGENAME || '.CheckRight';
  398   BEGIN
  399     
  400     IF PRIGHT = RIGHT_VIEW_ALL_BR AND NVL(GETBRANCHPART(PCODE), SEANCE.GETBRANCHPART) = SEANCE.GETBRANCHPART THEN
  401       RETURN TRUE;
  402     ELSE
  403     
  404       RETURN SECURITY.CHECKRIGHT(OBJECT_NAME, GETRIGHTKEY(PRIGHT));
  405     END IF;  
  406   EXCEPTION
  407     WHEN OTHERS THEN
  408       ERROR.SAVE(CPROCNAME);
  409       RAISE;
  410   END;
  411 
  412 
  413 
  414 FUNCTION GETTREEITEM(POBJECTPREFIX IN TYPEOBJECTPREFIX,
  415                      POBJECTCODE IN NUMBER)
  416   RETURN VARCHAR IS
  417     CPROCNAME  CONSTANT VARCHAR2(80) := CPACKAGENAME || '.GetTreeItem';
  418   BEGIN
  419     RETURN POBJECTPREFIX || TO_CHAR(POBJECTCODE);
  420   EXCEPTION
  421     WHEN OTHERS THEN
  422       ERROR.SAVE(CPROCNAME);
  423       RAISE;
  424   END;
  425 
  426 
  427 
  428 PROCEDURE FILLRETAILERLIST(PFICODE IN NUMBER,
  429                            PCODE IN NUMBER,
  430                            PPARENTCODE IN NUMBER)
  431   IS
  432     CPROCNAME CONSTANT VARCHAR2(80) := CPACKAGENAME || '.FillRetailerList';
  433     CBRANCH   CONSTANT NUMBER := SEANCE.GETBRANCH();
  434 
  435     VCOUNT    NUMBER;
  436 
  437     CURSOR CRETAILER IS
  438       SELECT LEVEL, T1.CODE, T1.IDENT, T1.NAME, T1.FICODE, T1.PARENTCODE, T1.INACTIVE, T1.PARENTINACTIVE
  439         FROM  (
  440                 SELECT
  441                   /*+ ordered
  442                     use_nl(T3)
  443                     INDEX_ASC(T3 RETAILER_SKEY)
  444                   */
  445                   T3.*
  446                   FROM TREFERENCERETAILER T3
  447                   WHERE T3.BRANCH = CBRANCH
  448                     AND T3.FICODE = PFICODE
  449                     AND T3.IDENT != ' '
  450                   START WITH T3.CODE = PPARENTCODE
  451                   CONNECT BY PRIOR T3.PARENTCODE = T3.CODE
  452                 UNION ALL
  453                 SELECT
  454                   /*+ ordered
  455                     use_nl(T4)
  456                     INDEX_ASC(T4 RETAILER_SKEY)
  457                   */
  458                   T4.*
  459                   FROM TREFERENCERETAILER T4
  460                   WHERE T4.BRANCH = CBRANCH
  461                     AND T4.FICODE = PFICODE
  462                     AND T4.IDENT != ' '
  463                     AND T4.PARENTCODE = PPARENTCODE
  464                     AND T4.CODE != PCODE
  465                 UNION ALL
  466                 SELECT
  467                   /*+ ordered
  468                     use_nl(T5)
  469                     INDEX_ASC(T5 RETAILER_SKEY)
  470                   */
  471                   T5.*
  472                   FROM TREFERENCERETAILER T5
  473                   WHERE T5.BRANCH = CBRANCH
  474                     AND T5.FICODE = PFICODE
  475                     AND T5.IDENT != ' '
  476                   START WITH T5.CODE = PCODE
  477                   CONNECT BY PRIOR T5.CODE = T5.PARENTCODE
  478               ) T1
  479         START WITH T1.PARENTCODE IS NULL
  480         CONNECT BY PRIOR T1.CODE = T1.PARENTCODE
  481         ORDER SIBLINGS BY T1.IDENT;
  482 
  483   BEGIN
  484 
  485 
  486     SRETAILERLIST.DELETE();
  487 
  488     SRETAILERLIST(1).CODE    := 0;
  489     SRETAILERLIST(1).NAME    := REFERENCEFI.GETNAME(PFICODE);
  490     SRETAILERLIST(1).LEVEL   := 0;
  491     SRETAILERLIST(1).ITEM    := GETTREEITEM(COPRETAILER, 0);
  492     SRETAILERLIST(1).CAPTION := REFERENCEFI.GETNAME(PFICODE) || '(' || REFERENCEFI.GETFIID(PFICODE) || ')';
  493     SRETAILERLIST(1).ICON    := UPPER('Disk_Fld.bmp');
  494 
  495     FOR I IN CRETAILER LOOP
  496       VCOUNT := SRETAILERLIST.COUNT + 1;
  497 
  498       SRETAILERLIST(VCOUNT).CODE           := I.CODE;
  499       SRETAILERLIST(VCOUNT).IDENT          := I.IDENT;
  500       SRETAILERLIST(VCOUNT).NAME           := I.NAME;
  501       SRETAILERLIST(VCOUNT).FICODE         := I.FICODE;
  502       SRETAILERLIST(VCOUNT).PARENTCODE     := I.PARENTCODE;
  503       SRETAILERLIST(VCOUNT).INACTIVE       := I.INACTIVE;
  504       SRETAILERLIST(VCOUNT).PARENTINACTIVE := I.PARENTINACTIVE;
  505       SRETAILERLIST(VCOUNT).LEVEL          := I.LEVEL;
  506       SRETAILERLIST(VCOUNT).ITEM           := GETTREEITEM(COPRETAILER, I.CODE);
  507       SRETAILERLIST(VCOUNT).CAPTION        := I.NAME || '(' || I.IDENT || ')';
  508     END LOOP;
  509 
  510   EXCEPTION
  511     WHEN OTHERS THEN
  512       ERROR.SAVE(CPROCNAME);
  513       RAISE;
  514   END;
  515 
  516 
  517 
  518 FUNCTION GETNODEID (PCODE IN NUMBER,
  519                     PINDEX IN NUMBER)
  520   RETURN NUMBER IS
  521     CPROCNAME    CONSTANT VARCHAR2(80) := CPACKAGENAME || '.GetNodeId';
  522   BEGIN
  523     FOR I IN REVERSE 1..PINDEX LOOP
  524       IF (SRETAILERLIST(I).CODE = PCODE) THEN
  525         RETURN SRETAILERLIST(I).NODE;
  526       END IF;
  527     END LOOP;
  528 
  529     RETURN NULL;
  530 
  531   EXCEPTION
  532     WHEN OTHERS THEN
  533       ERROR.SAVE(CPROCNAME);
  534       RAISE;
  535   END;
  536 
  537 
  538 
  539 
  540 PROCEDURE FILLTREE(PTREEID IN NUMBER,
  541                    PFICODE IN NUMBER,
  542                    PCODE IN NUMBER,
  543                    PPARENTCODE IN NUMBER)
  544   IS
  545     CPROCNAME      CONSTANT VARCHAR2(80) := CPACKAGENAME || '.FillTree';
  546     VDIALOGID      NUMBER;  
  547     I              PLS_INTEGER;
  548     VNODEID        NUMBER;
  549   BEGIN
  550     VDIALOGID := DIALOG.GETDIALOG(PTREEID);  
  551 
  552     FILLRETAILERLIST(PFICODE, PCODE, PPARENTCODE);
  553 
  554     I := SRETAILERLIST.FIRST();
  555 
  556     DIALOG.CLEARCONTAINER(PTREEID);
  557 
  558     SRETAILERLIST(I).NODE := DIALOG.TREEITEM(PTREEID, SRETAILERLIST(I).ITEM, SRETAILERLIST(I).CAPTION, SRETAILERLIST(I).ICON);
  559     VNODEID := SRETAILERLIST(I).NODE;
  560 
  561     I := SRETAILERLIST.NEXT(I);
  562 
  563     WHILE (I IS NOT NULL) LOOP
  564 
  565        VNODEID := NVL(GETNODEID(SRETAILERLIST(I).PARENTCODE, I), VNODEID);
  566 
  567        SRETAILERLIST(I).NODE := DIALOG.TREEITEM(VNODEID, SRETAILERLIST(I).ITEM, SRETAILERLIST(I).CAPTION);
  568 
  569        
  570        IF (SRETAILERLIST(I).LEVEL > 0 AND
  571             (SRETAILERLIST(I).INACTIVE = CINACTIVE OR
  572              SRETAILERLIST(I).PARENTINACTIVE = CINACTIVE OR
  573              (SRETAILERLIST(I).INACTIVE = CINACTIVE AND
  574              SRETAILERLIST(I).PARENTINACTIVE = CINACTIVE))) THEN
  575          DIALOG.SETFONTITALIC(VDIALOGID, SRETAILERLIST(I).ITEM, TRUE);     
  576          DIALOG.SETFONTCOLOR(VDIALOGID, SRETAILERLIST(I).ITEM, '808080');  
  577        END IF;
  578        
  579 
  580        IF (SRETAILERLIST(I).CODE = PCODE) THEN
  581          DIALOG.SETTREECURRENT(PTREEID, SRETAILERLIST(I).NODE);
  582        END IF;
  583 
  584       I := SRETAILERLIST.NEXT(I);
  585     END LOOP;
  586 
  587   EXCEPTION
  588     WHEN OTHERS THEN
  589       ERROR.SAVE(CPROCNAME);
  590       RAISE;
  591   END;
  592 
  593 
  594 
  595 
  596 
  597 
  598 
  599 
  600 
  601 
  602 
  603 
  604 
  605 
  606 
  607 
  608 
  609 
  610 
  611 
  612 
  613 
  614 
  615 
  616 
  617 
  618 
  619 
  620 
  621 FUNCTION GETNULLRETAILERCOUNT
  622   RETURN NUMBER IS
  623     CPROCNAME  CONSTANT VARCHAR2(80) := CPACKAGENAME || '.GetNullRetailerCount';
  624     VCOUNT     NUMBER;
  625     VBRANCH    NUMBER;  
  626   BEGIN
  627     VBRANCH := SEANCE.GETBRANCH();  
  628 
  629     SELECT COUNT(*) INTO VCOUNT
  630       FROM TREFERENCERETAILER
  631       WHERE BRANCH = VBRANCH  
  632         AND IDENT  = ' ';
  633 
  634     RETURN VCOUNT;
  635   EXCEPTION
  636     WHEN OTHERS THEN
  637       ERROR.SAVE(CPROCNAME);
  638       RAISE;
  639   END;
  640 
  641 
  642 
  643 
  644 
  645 
  646 
  647 
  648 
  649 
  650 
  651 
  652 
  653 
  654 
  655 
  656 
  657 
  658 
  659 
  660 
  661 
  662 
  663 
  664 
  665 
  666 
  667 
  668 
  669 
  670 
  671 
  672 
  673 
  674 
  675 
  676 
  677 
  678 
  679 
  680 
  681 
  682 
  683 
  684 
  685 
  686 
  687 
  688 
  689 
  690 
  691 
  692 
  693 
  694 
  695 
  696 
  697 
  698 
  699 
  700 
  701 
  702 
  703 
  704 
  705 
  706 
  707 
  708 
  709 
  710 
  711 
  712 
  713 
  714 
  715 
  716 
  717 
  718 
  719 
  720 
  721 
  722 
  723 
  724 
  725 
  726 
  727 
  728 
  729 
  730 
  731 
  732 
  733 
  734 
  735 
  736 
  737 
  738 
  739 
  740 
  741 
  742 
  743 
  744 
  745 
  746 
  747 
  748 
  749 
  750 
  751 
  752 
  753 
  754 
  755 
  756 
  757 
  758 
  759 
  760 
  761 
  762 
  763 
  764 
  765 
  766 
  767 
  768 
  769 
  770 
  771 
  772 
  773 
  774 
  775 
  776 
  777 
  778 
  779 
  780 
  781 
  782 
  783 FUNCTION DIALOGTREE(PFICODE IN NUMBER,
  784                     PCODE IN NUMBER,
  785                     PPARENTCODE IN NUMBER)
  786   RETURN NUMBER IS
  787     CPROCNAME      CONSTANT VARCHAR2(80) := CPACKAGENAME || '.DialogTree';
  788     CDIALOGEH      CONSTANT VARCHAR2(80) := CPACKAGENAME || '.DialogTreeEH';
  789     CDIALOGWIDTH   CONSTANT NUMBER := 80;
  790     CDIALOGHEIGHT  CONSTANT NUMBER := 18;
  791     CBUTTONWIDTH   CONSTANT NUMBER := 10;
  792     VDIALOGID      NUMBER;
  793     VTREEID        NUMBER;
  794   BEGIN
  795 
  796     VDIALOGID := DIALOG.NEW('Hierarchical structure', 0, 0, CDIALOGWIDTH, CDIALOGHEIGHT, PEXTID => CPROCNAME); 
  797       DIALOG.SETDIALOGPRE(VDIALOGID, CDIALOGEH);
  798       DIALOG.SETDIALOGPOST(VDIALOGID, CDIALOGEH);
  799 
  800     VTREEID := DIALOG.TREE(VDIALOGID, 'Tree', 1, 1, CDIALOGWIDTH-1, CDIALOGHEIGHT-2);
  801 
  802     FILLTREE(VTREEID, PFICODE, PCODE, PPARENTCODE);
  803 
  804     DIALOG.BUTTON(VDIALOGID, 'btnCancel', (CDIALOGWIDTH-CBUTTONWIDTH)/2, CDIALOGHEIGHT, CBUTTONWIDTH, 'Cancel', DIALOG.CM_CANCEL);
  805 
  806     RETURN VDIALOGID;
  807   EXCEPTION
  808     WHEN OTHERS THEN
  809       ERROR.SAVE(CPROCNAME);
  810       RAISE;
  811   END;
  812 
  813 
  814 
  815 PROCEDURE DIALOGTREEEH(PWHAT IN CHAR, PDIALOGID IN NUMBER, PITEMNAME IN VARCHAR, PCMD IN NUMBER)
  816   IS
  817     CPROCNAME CONSTANT VARCHAR2(80) := CPACKAGENAME || '.DialogTreeEH';
  818   BEGIN
  819     IF (PWHAT = DIALOG.WT_DIALOGPRE) THEN
  820       NULL;
  821     ELSIF (PWHAT = DIALOG.WT_DIALOGPOST) THEN
  822       SRETAILERLIST.DELETE();
  823     END IF;
  824   EXCEPTION
  825     WHEN OTHERS THEN
  826       ERROR.SAVE(CPROCNAME);
  827       RAISE;
  828   END;
  829 
  830 
  831 
  832 FUNCTION GETSQL(PFICODE IN NUMBER := NULL,
  833                 PDISPLAYMODE IN TYPEDISPLAYMODE := NULL,
  834                 PTERMINALID IN VARCHAR := NULL) RETURN VARCHAR
  835   IS
  836     CPROCNAME      CONSTANT VARCHAR2(128) := CPACKAGENAME || '.GetSQL';
  837     CBRANCH        CONSTANT NUMBER := SEANCE.GETBRANCH();
  838     VSQL           VARCHAR2(32767);
  839     VBRANCHPART    TBRANCHPART.BRANCHPART%TYPE;
  840     VTERMINALMASK  VARCHAR2(16);                                         
  841     VCONTAINSMASKS BOOLEAN;                                              
  842 
  843     
  844     FUNCTION DROPMASKCHARS(PSTR IN VARCHAR) RETURN VARCHAR IS
  845       BEGIN
  846         RETURN (
  847           REPLACE(REPLACE(REPLACE(REPLACE(PSTR, '_'), '%'), '*'), '?')
  848         );
  849       END;
  850 
  851     FUNCTION CONTAINSMASKS(PSTR IN VARCHAR) RETURN BOOLEAN
  852       IS
  853        VSTR VARCHAR(128);
  854       BEGIN
  855         VSTR := DROPMASKCHARS(PSTR);
  856         RETURN LENGTH(VSTR) != LENGTH(PSTR);
  857       END;
  858     
  859 
  860   BEGIN
  861 
  862     VSQL := ' from tReferenceFi t1, tReferenceRetailer t2' ||
  863             ' where t1.Branch = ' || CBRANCH;
  864 
  865     IF (PFICODE IS NOT NULL) THEN
  866       VSQL := VSQL ||
  867               ' and t1.Code = ' || PFICODE;
  868     END IF;
  869 
  870     VSQL := VSQL ||
  871               ' and t2.Branch = t1.Branch' ||
  872               ' and t2.FiCode = t1.Code'   ||
  873               ' and t2.Ident != '' ''';
  874 
  875     IF (PDISPLAYMODE = CDMACTIVE) THEN
  876       VSQL := VSQL ||
  877               ' and nvl(t2.Inactive, ' || CACTIVE || ') = ' || CACTIVE ||
  878               ' and nvl(t2.ParentInactive, ' || CACTIVE || ') = ' || CACTIVE;
  879 
  880     ELSIF (PDISPLAYMODE = CDMINACTIVE) THEN
  881       VSQL := VSQL ||
  882               ' and ' ||
  883               '   (  t2.Inactive = ' || CINACTIVE ||
  884               '   or t2.ParentInactive = ' || CINACTIVE ||
  885               '   or (t2.Inactive = ' || CINACTIVE || ' and t2.ParentInactive = ' || CINACTIVE || '))';
  886     END IF;
  887 
  888     IF (NOT CHECKRIGHT(RIGHT_VIEW_ALL_BR)) THEN
  889       VBRANCHPART := SEANCE.GETBRANCHPART();
  890 
  891       VSQL := VSQL ||
  892               ' and nvl(t2.BranchPart, 0) = ' || VBRANCHPART;
  893     END IF;
  894 
  895     
  896     IF (PTERMINALID IS NOT NULL) THEN
  897       VCONTAINSMASKS := FALSE;
  898       IF (CONTAINSMASKS(PTERMINALID)) THEN
  899         VTERMINALMASK := TRANSLATE(PTERMINALID, '*', '%');
  900         VCONTAINSMASKS := TRUE;
  901       ELSE
  902         VTERMINALMASK := PTERMINALID;
  903       END IF;
  904 
  905       VSQL := VSQL || ' and ( exists ( select t3.RetailerCode from tReferenceTerminal t3 '||
  906                                ' where t3.Branch = t2.Branch '||
  907                                '   and t3.RetailerCode = t2.Code ';
  908 
  909       IF (VCONTAINSMASKS) THEN
  910         VSQL := VSQL || ' and Upper(t3.Ident) LIKE '''|| UPPER(VTERMINALMASK)||'''';
  911       ELSE
  912         VSQL := VSQL || ' and Upper(t3.Ident) = '''|| UPPER(VTERMINALMASK)||'''';
  913       END IF;
  914 
  915       VSQL := VSQL || ') )';
  916     END IF;
  917     
  918 
  919     VSQL := VSQL ||
  920             ' order by t1.Fiid, t2.Ident';
  921 
  922     RETURN VSQL;
  923 
  924   EXCEPTION
  925     WHEN OTHERS THEN
  926       ERROR.SAVE(CPROCNAME);
  927       RAISE;
  928   END;
  929 
  930 
  931 
  932 
  933 PROCEDURE DSCLOSE(PDSHANDLE IN NUMBER)
  934   IS
  935     CPROCNAME CONSTANT VARCHAR2(128) := CPACKAGENAME || '.DSClose';
  936   BEGIN
  937     IF (SDSHANDLE > 0) THEN
  938       DYNASET.CLOSE(SDSHANDLE);
  939     END IF;
  940   EXCEPTION
  941     WHEN OTHERS THEN
  942       ERROR.SAVE(CPROCNAME);
  943       RAISE;
  944   END;
  945 
  946 
  947 
  948 PROCEDURE DSOPEN(PSQL IN VARCHAR)
  949   IS
  950     CPROCNAME CONSTANT VARCHAR2(128) := CPACKAGENAME || '.DSOpen';
  951   BEGIN
  952     DSCLOSE(SDSHANDLE);
  953 
  954     SDSHANDLE := DYNASET.OPEN(PSQL,
  955                               
  956                               PCOMMIT => FALSE);
  957                               
  958   EXCEPTION
  959     WHEN OTHERS THEN
  960       ERROR.SAVE(CPROCNAME);
  961       RAISE;
  962   END;
  963 
  964 
  965 
  966 PROCEDURE FILLSCROLLER(PFICODE IN NUMBER := NULL,
  967                        PDISPLAYMODE IN TYPEDISPLAYMODE := NULL,
  968                        PTERMINALID IN VARCHAR := NULL)
  969   IS
  970     CPROCNAME CONSTANT VARCHAR2(128) := CPACKAGENAME || '.FillScroller';
  971     VSQL      VARCHAR2(32767);
  972   BEGIN
  973     VSQL := GETSQL(PFICODE, PDISPLAYMODE, PTERMINALID);
  974 
  975     DSOPEN(VSQL);
  976   EXCEPTION
  977     WHEN OTHERS THEN
  978       ERROR.SAVE(CPROCNAME);
  979       RAISE;
  980   END;
  981 
  982 
  983 
  984 FUNCTION GETROW(PNO IN NUMBER) RETURN TREFERENCERETAILER%ROWTYPE
  985   IS
  986     CPROCNAME CONSTANT VARCHAR2(128) := CPACKAGENAME || '.GetRow';
  987     VKEYS     VARCHAR2(256);
  988     VROWID    VARCHAR2(18);
  989     VROW      TREFERENCERETAILER%ROWTYPE;
  990   BEGIN
  991     VKEYS := DYNASET.GETKEYS(SDSHANDLE, PNO);
  992 
  993     VROWID := SUBSTR(VKEYS, -18);
  994 
  995     SELECT *
  996       INTO VROW
  997       FROM TREFERENCERETAILER
  998       WHERE ROWID = VROWID;
  999 
 1000     RETURN VROW;
 1001 
 1002   EXCEPTION
 1003     WHEN OTHERS THEN
 1004       ERROR.SAVE(CPROCNAME);
 1005       RETURN NULL;
 1006   END;
 1007 
 1008 
 1009 
 1010 FUNCTION GETCOUNT RETURN NUMBER
 1011   IS
 1012     CPROCNAME CONSTANT VARCHAR2(128) := CPACKAGENAME || '.GetCount';
 1013   BEGIN
 1014     RETURN DYNASET.GETCOUNT(SDSHANDLE);
 1015   EXCEPTION
 1016     WHEN OTHERS THEN
 1017       ERROR.SAVE(CPROCNAME);
 1018       RETURN 0;
 1019   END;
 1020 
 1021 
 1022 
 1023 FUNCTION GETTEXT (PNO IN NUMBER) RETURN VARCHAR
 1024   IS
 1025     CPROCNAME CONSTANT VARCHAR2(128) := CPACKAGENAME || '.GetText';
 1026     VROW      TREFERENCERETAILER%ROWTYPE;
 1027     VTEXT     VARCHAR2(1024);
 1028   BEGIN
 1029     VROW := GETROW(PNO);
 1030 
 1031     VTEXT := SERVICE.IIF(VROW.HAVETRANSIT IS NULL, '~', 'T~') ||
 1032              REFERENCEFI.GETFIID(VROW.FICODE) || '~' ||
 1033              VROW.IDENT || '~' ||
 1034              VROW.NAME || '~';
 1035 
 1036     RETURN VTEXT;
 1037   EXCEPTION
 1038     WHEN OTHERS THEN
 1039       ERROR.SAVE(CPROCNAME);
 1040       RETURN NULL;
 1041   END;
 1042 
 1043 
 1044 
 1045 FUNCTION GETPOSBYCODE(PCODE IN NUMBER) RETURN NUMBER
 1046   IS
 1047     CPROCNAME CONSTANT VARCHAR2(128) := CPACKAGENAME || '.GetPosByCode';
 1048     VCOUNT    NUMBER;
 1049     VINDEX    NUMBER;
 1050     VKEYS     VARCHAR2(256);
 1051     VROWID    VARCHAR2(18);
 1052     VROW      TREFERENCERETAILER%ROWTYPE;
 1053     VPOS      NUMBER;
 1054   BEGIN
 1055     VCOUNT := GETCOUNT();
 1056     VINDEX := 0;
 1057 
 1058     WHILE (VCOUNT > VINDEX) LOOP
 1059       VINDEX := VINDEX + 1;
 1060 
 1061       VKEYS := DYNASET.GETKEYS(SDSHANDLE, VINDEX);
 1062 
 1063       VROWID := SUBSTR(VKEYS, -18);
 1064 
 1065       SELECT *
 1066         INTO VROW
 1067         FROM TREFERENCERETAILER
 1068         WHERE ROWID = VROWID;
 1069 
 1070       IF (VROW.CODE = PCODE) THEN
 1071         VPOS := VINDEX;
 1072         EXIT;
 1073       END IF;
 1074 
 1075     END LOOP;
 1076 
 1077     RETURN VPOS;
 1078 
 1079   EXCEPTION
 1080     WHEN OTHERS THEN
 1081       ERROR.SAVE(CPROCNAME);
 1082       RETURN NULL;
 1083   END;
 1084 
 1085 
 1086 
 1087 FUNCTION DIALOGREFERENCE(PFICODE NUMBER,
 1088                          PDIALOGMODE TYPEDIALOGMODE,
 1089                          PCODE NUMBER)
 1090   RETURN NUMBER IS
 1091     CPROCNAME         CONSTANT VARCHAR2(80) := CPACKAGENAME || '.DialogReference';
 1092     CDIALOGEH         CONSTANT VARCHAR2(80) := CPACKAGENAME || '.DialogReferenceEH';
 1093     CDIALOGWIDTH      CONSTANT NUMBER := 80;
 1094     CDIALOGHEIGHT     CONSTANT NUMBER := 20;
 1095     CBUTTONWIDTH      CONSTANT NUMBER := 11;
 1096     VDIALOGCAPTION    VARCHAR2(80);
 1097     VDIALOGID         NUMBER;
 1098     VMENUID           NUMBER;
 1099     VMENUDISPLAYID    NUMBER;
 1100     VMENUREFERENCEID  NUMBER;
 1101     VMENUSETTINGID    NUMBER;
 1102     VDY               NUMBER := 0;
 1103     
 1104   BEGIN
 1105     VDIALOGCAPTION := CASE PDIALOGMODE
 1106                         WHEN CDMREFERENCE THEN
 1107                           'Dictionary of retailers'WHEN CDMLIST THEN
 1108                           'List of retailers'WHEN CDMSELECT THEN
 1109                           'Select retailer'ELSE
 1110                           NULL
 1111                       END;
 1112 
 1113     VDIALOGID := BROWSER.NEW(CPACKAGENAME, VDIALOGCAPTION, 0, 0, CDIALOGWIDTH, CDIALOGHEIGHT);
 1114 
 1115     DIALOG.SETEXTERNALID (VDIALOGID, CPROCNAME); 
 1116 
 1117     DIALOG.SETDIALOGRESIZEABLE(VDIALOGID, TRUE);
 1118     DIALOG.SETDIALOGCANMAXIMIZE(VDIALOGID, TRUE);
 1119     BROWSER.SETDIALOGPRE(VDIALOGID, CDIALOGEH);
 1120     BROWSER.SETDIALOGVALID(VDIALOGID, CDIALOGEH);
 1121     BROWSER.SETDIALOGPOST(VDIALOGID, CDIALOGEH);
 1122 
 1123     VMENUID := DIALOG.MENU(VDIALOGID);
 1124 
 1125     BROWSER.STANDARDMENUFILE(VMENUID);
 1126     BROWSER.STANDARDMENUBLOCK(VMENUID);
 1127     BROWSER.STANDARDMENUFIND(VMENUID);
 1128 
 1129     BROWSER.SETDIALOGMENU(VDIALOGID, VMENUID);
 1130 
 1131     VMENUDISPLAYID := DIALOG.SUBMENU(VMENUID, 'View', '');
 1132 
 1133     DIALOG.MENUITEM(VMENUDISPLAYID, 'mnDisplayAll', 'All', 0, 0, '');
 1134       DIALOG.ENABLEMENUCASE(VDIALOGID, 'mnDisplayAll');
 1135       DIALOG.SETITEMPRE(VDIALOGID, 'mnDisplayAll', CDIALOGEH);
 1136 
 1137     DIALOG.MENUITEM(VMENUDISPLAYID, 'mnDisplayActive', 'Active', 0, 0, '');
 1138       DIALOG.DISABLEMENUCASE(VDIALOGID, 'mnDisplayActive');
 1139       DIALOG.SETITEMPRE(VDIALOGID, 'mnDisplayActive', CDIALOGEH);
 1140 
 1141     DIALOG.MENUITEM(VMENUDISPLAYID, 'mnDisplayInactive', 'Inactive', 0, 0, '');
 1142       DIALOG.ENABLEMENUCASE(VDIALOGID, 'mnDisplayInactive');
 1143       DIALOG.SETITEMPRE(VDIALOGID, 'mnDisplayInactive', CDIALOGEH);
 1144 
 1145     DIALOG.SEPARATOR(VMENUDISPLAYID);
 1146 
 1147     DIALOG.MENUITEM(VMENUDISPLAYID, 'mnStructure', 'Structure', 0, 0, '');
 1148       DIALOG.SETITEMPRE(VDIALOGID, 'mnStructure', CDIALOGEH);
 1149 
 1150     IF (PDIALOGMODE = CDMSELECT) THEN
 1151       REFERENCEFI.MAKEITEM(VDIALOGID, 'miFiid', 0, 0, 10, '', '');
 1152       DIALOG.SETVISIBLE(VDIALOGID, 'miFiid', FALSE);
 1153 
 1154     ELSE
 1155       VDY := 3;
 1156 
 1157       REFERENCEFI.MAKEITEM(VDIALOGID, 'miFiid', 13, 2, 10, 'FIID:', 'Financial institution');
 1158 
 1159       DIALOG.BUTTON(VDIALOGID, 'btnFilter', 60, 2, 12, 'Search', 0, 0, '');
 1160         DIALOG.SETITEMPRE(VDIALOGID, 'btnFilter', CDIALOGEH);
 1161         DIALOG.SETDEFAULT(VDIALOGID, 'btnFilter');
 1162 
 1163       DIALOG.INPUTCHAR(VDIALOGID, 'TerminalId', 13, 3, 16, 'Terminal', NULL, 'Terminal:');  
 1164 
 1165       IF (PDIALOGMODE = CDMREFERENCE) THEN
 1166         VMENUREFERENCEID := DIALOG.SUBMENU(VMENUID, 'Dictionaries', 'Dictionaries');
 1167 
 1168         DIALOG.MENUITEM(VMENUREFERENCEID, 'mnReferenceTerminal' , 'Dictionary of terminals', 0, 0, '');
 1169           DIALOG.SETITEMPRE(VDIALOGID, 'mnReferenceTerminal', CDIALOGEH);
 1170 
 1171         
 1172         DIALOG.MENUITEM(VMENUREFERENCEID, 'mnReferenceGroup' , 'Dictionary of groups', 0, 0, '');
 1173           DIALOG.SETITEMPRE(VDIALOGID, 'mnReferenceGroup', CDIALOGEH);
 1174         
 1175 
 1176         DIALOG.SEPARATOR(VMENUREFERENCEID);
 1177 
 1178         DIALOG.MENUITEM(VMENUREFERENCEID, 'mnUserProperty' , 'User attributes', 0, 0, '');
 1179           DIALOG.SETITEMPRE(VDIALOGID, 'mnUserProperty', CDIALOGEH);
 1180 
 1181         VMENUSETTINGID := DIALOG.SUBMENU(VMENUID, 'Setup', '');
 1182 
 1183         DIALOG.MENUITEM(VMENUSETTINGID, 'mnMerchantID', 'Merchant ID', 0, 0, '');
 1184           DIALOG.SETITEMPRE(VDIALOGID, 'mnMerchantID', CDIALOGEH);
 1185 
 1186         DIALOG.SEPARATOR(VMENUSETTINGID);
 1187         
 1188         DIALOG.MENUITEM(VMENUSETTINGID, 'mnBlockUpdateValues', 'Block for redefining values of retailer attributes...', 0, 0, '');
 1189           DIALOG.SETITEMPRE(VDIALOGID, 'mnBlockUpdateValues', CDIALOGEH);
 1190         
 1191         DIALOG.MENUITEM(VMENUSETTINGID, 'mnBlockSave', 'Block of retailer saving control...', 0, 0, '');
 1192           DIALOG.SETITEMPRE(VDIALOGID, 'mnBlockSave', CDIALOGEH);
 1193 
 1194       ELSIF (PDIALOGMODE = CDMLIST) THEN
 1195         DIALOG.SETENABLE(VDIALOGID, 'miFiid', FALSE);
 1196       END IF;
 1197     END IF;
 1198 
 1199     REFERENCEFI.SETITEMDATA(VDIALOGID, 'miFiid', PFICODE);  
 1200 
 1201     BROWSER.SCROLLER(VDIALOGID, 1, 2+VDY, CDIALOGWIDTH-1, CDIALOGHEIGHT-2-VDY, DIALOG.FIRSTRECORD, '<Enter> - change retailer attributes');
 1202 
 1203     DIALOG.LISTADDFIELD(VDIALOGID, 'SCROLLER', 'T',     'C', 1,  1);
 1204     DIALOG.LISTADDFIELD(VDIALOGID, 'SCROLLER', 'Fiid',  'C', 10, 1);
 1205     DIALOG.LISTADDFIELD(VDIALOGID, 'SCROLLER', 'Ident', 'C', 20, 1);
 1206     DIALOG.LISTADDFIELD(VDIALOGID, 'SCROLLER', 'Name',  'C', 40, 1);
 1207 
 1208     BROWSER.SETCAPTION(VDIALOGID, 'SCROLLER', 'T~FIID~ID~Name');
 1209     DIALOG.SETITEMPRE(VDIALOGID, 'SCROLLER', CDIALOGEH);
 1210 
 1211     IF (PDIALOGMODE != CDMSELECT) THEN
 1212       DIALOG.BUTTON(VDIALOGID, 'btnAdd',    (CDIALOGWIDTH-CBUTTONWIDTH*4 - 2*3)/2, CDIALOGHEIGHT, CBUTTONWIDTH, 'Add', PHINT => 'Add retailer', PANCHOR => DIALOG.ANCHOR_BOTTOM);
 1213       DIALOG.BUTTON(VDIALOGID, 'btnCopy',   (CDIALOGWIDTH-CBUTTONWIDTH*4 - 2*3)/2 + CBUTTONWIDTH + 2, CDIALOGHEIGHT, CBUTTONWIDTH, 'Copy', PHINT => 'Copy retailer', PANCHOR => DIALOG.ANCHOR_BOTTOM);
 1214       DIALOG.BUTTON(VDIALOGID, 'btnDelete', (CDIALOGWIDTH-CBUTTONWIDTH*4 - 2*3)/2 + CBUTTONWIDTH*2 + 2*2, CDIALOGHEIGHT, CBUTTONWIDTH, 'Delete', PHINT => 'Delete retailer', PANCHOR => DIALOG.ANCHOR_BOTTOM);
 1215       DIALOG.BUTTON(VDIALOGID, 'btnExit',   (CDIALOGWIDTH-CBUTTONWIDTH*4 - 2*3)/2 + CBUTTONWIDTH*3 + 2*3, CDIALOGHEIGHT, CBUTTONWIDTH, 'Exit', DIALOG.CM_CANCEL, PANCHOR => DIALOG.ANCHOR_BOTTOM);
 1216 
 1217       DIALOG.SETITEMPRE(VDIALOGID, 'btnAdd',    CDIALOGEH);
 1218       DIALOG.SETITEMPRE(VDIALOGID, 'btnCopy',   CDIALOGEH);
 1219       DIALOG.SETITEMPRE(VDIALOGID, 'btnDelete', CDIALOGEH);
 1220 
 1221     ELSE
 1222       DIALOG.BUTTON(VDIALOGID, 'btnApply', (CDIALOGWIDTH-CBUTTONWIDTH*3 - 2*2)/2 , CDIALOGHEIGHT, CBUTTONWIDTH, 'Enter', DIALOG.CM_OK, PHINT => 'Use retailer', PANCHOR => DIALOG.ANCHOR_BOTTOM);
 1223         DIALOG.SETITEMATTRIBUTIES(VDIALOGID, 'btnApply', DIALOG.DEFAULTON);
 1224       DIALOG.BUTTON(VDIALOGID, 'btnClear', (CDIALOGWIDTH-CBUTTONWIDTH*3 - 2*2)/2 + CBUTTONWIDTH + 2, CDIALOGHEIGHT, CBUTTONWIDTH, 'Clear', DIALOG.CM_OK, PHINT => '�⬥���� �⥩���', PANCHOR => DIALOG.ANCHOR_BOTTOM);  
 1225       DIALOG.BUTTON(VDIALOGID, 'btnCancel', (CDIALOGWIDTH-CBUTTONWIDTH*3 - 2*2)/2 + CBUTTONWIDTH*2 + 2*2, CDIALOGHEIGHT, CBUTTONWIDTH, 'Cancel', DIALOG.CM_CANCEL, PANCHOR => DIALOG.ANCHOR_BOTTOM);
 1226     END IF;
 1227 
 1228     DIALOG.HIDDENNUMBER(VDIALOGID, 'DialogMode', PDIALOGMODE);
 1229     DIALOG.HIDDENNUMBER(VDIALOGID, 'DisplayMode', CDMACTIVE);
 1230     DIALOG.HIDDENNUMBER(VDIALOGID, 'Code', PCODE);
 1231     DIALOG.HIDDENCHAR(VDIALOGID, 'Event', CDIALOGEH);          
 1232 
 1233     RETURN VDIALOGID;
 1234 
 1235   EXCEPTION
 1236     WHEN OTHERS THEN
 1237       ERROR.SAVE(CPROCNAME);
 1238       RAISE;
 1239   END;
 1240 
 1241 
 1242 
 1243 PROCEDURE DIALOGREFERENCEEH(PWHAT IN CHAR, PDIALOGID IN NUMBER, PITEMNAME IN VARCHAR, PCMD IN NUMBER)
 1244   IS
 1245     CPROCNAME     CONSTANT VARCHAR2(80) := CPACKAGENAME || '.DialogReferenceEH';
 1246     VFICODE       TREFERENCERETAILER.FICODE%TYPE;
 1247     VCODE         TREFERENCERETAILER.CODE%TYPE;
 1248     VRIGHTVIEW    BOOLEAN;
 1249     VDISPLAYMODE  TYPEDISPLAYMODE;
 1250     VCURPOS       NUMBER;
 1251     VROW          TREFERENCERETAILER%ROWTYPE;
 1252     VDIALOGMODE   TYPEDIALOGMODE;
 1253     
 1254     PROCEDURE SETITEMSTATE
 1255       IS
 1256         CPROCNAME      CONSTANT VARCHAR2(80) := CPACKAGENAME || '.DialogReferenceEH.SetItemState';
 1257         
 1258         VRIGHTMODIFY   BOOLEAN;
 1259         VRIGHTCREATE   BOOLEAN; 
 1260         VNOTEMPTYLIST  BOOLEAN;
 1261       BEGIN
 1262         VRIGHTMODIFY  := CHECKRIGHT(RIGHT_MODIFY);
 1263         VRIGHTCREATE  := CHECKRIGHT(RIGHT_CREATE); 
 1264 
 1265         VNOTEMPTYLIST := GETCOUNT() > 0;
 1266 
 1267         IF (DIALOG.EXISTSITEMBYNAME(PDIALOGID, 'btnAdd')) THEN
 1268           DIALOG.SETENABLE(PDIALOGID, 'btnAdd', VRIGHTCREATE); 
 1269         END IF;
 1270 
 1271         IF (DIALOG.EXISTSITEMBYNAME(PDIALOGID, 'btnCopy')) THEN
 1272           DIALOG.SETENABLE(PDIALOGID, 'btnCopy', VRIGHTCREATE AND VNOTEMPTYLIST AND VDIALOGMODE != CDMSELECT); 
 1273         END IF;
 1274 
 1275         IF (DIALOG.EXISTSITEMBYNAME(PDIALOGID, 'btnDelete')) THEN
 1276           DIALOG.SETENABLE(PDIALOGID, 'btnDelete', VRIGHTMODIFY AND VNOTEMPTYLIST AND VDIALOGMODE != CDMSELECT);
 1277         END IF;
 1278 
 1279         IF (DIALOG.EXISTSITEMBYNAME(PDIALOGID, 'btnApply')) THEN
 1280           DIALOG.SETENABLE(PDIALOGID, 'btnApply', VRIGHTMODIFY);
 1281         END IF;
 1282 
 1283         
 1284         IF (DIALOG.EXISTSITEMBYNAME(PDIALOGID, 'btnClear')) THEN
 1285           DIALOG.SETENABLE(PDIALOGID, 'btnClear', VRIGHTMODIFY);
 1286         END IF;
 1287         
 1288 
 1289         IF (VNOTEMPTYLIST) THEN
 1290           DIALOG.ENABLEMENUCASE(PDIALOGID, 'mnStructure');
 1291         ELSE
 1292           DIALOG.DISABLEMENUCASE(PDIALOGID, 'mnStructure');
 1293         END IF;
 1294 
 1295       EXCEPTION
 1296         WHEN OTHERS THEN
 1297           ERROR.SAVE(CPROCNAME);
 1298           RAISE;
 1299       END;
 1300     
 1301     PROCEDURE REFRESH(PFICODE IN NUMBER,
 1302                       PDISPLAYMODE IN TYPEDISPLAYMODE,
 1303                       PCODE IN NUMBER := NULL,
 1304                       PPOS IN NUMBER := NULL)
 1305       IS
 1306         CPROCNAME CONSTANT VARCHAR2(80) := CPACKAGENAME || '.DialogReferenceEH.Refresh';
 1307         VPOS      NUMBER;
 1308       BEGIN
 1309         FILLSCROLLER(PFICODE, PDISPLAYMODE, TRIM(DIALOG.GETCHAR(PDIALOGID, 'TerminalId')));
 1310 
 1311         IF (PCODE IS NULL) THEN
 1312           VPOS := PPOS;
 1313         ELSE
 1314           VPOS := NVL(GETPOSBYCODE(PCODE), PPOS);
 1315         END IF;
 1316 
 1317         BROWSER.SCROLLERREFRESH(PDIALOGID, VPOS);
 1318         SETITEMSTATE();
 1319       EXCEPTION
 1320         WHEN OTHERS THEN
 1321           ERROR.SAVE(CPROCNAME);
 1322           RAISE;
 1323       END;
 1324     
 1325   BEGIN
 1326     VFICODE     := REFERENCEFI.GETITEMDATA(PDIALOGID, 'miFiid');
 1327     VRIGHTVIEW  := CHECKRIGHT(RIGHT_VIEW);
 1328     VDIALOGMODE := DIALOG.GETNUMBER(PDIALOGID, 'DialogMode');
 1329 
 1330     IF (PWHAT = DIALOG.WT_DIALOGPRE) THEN
 1331 
 1332       IF (NOT VRIGHTVIEW) THEN
 1333         SERVICE.SAYMSG(PDIALOGID, 'Warning !', 'You are not authorized to view dictionary~');
 1334         DIALOG.ABORT(PDIALOGID);
 1335         RETURN;
 1336       END IF;
 1337 
 1338       VDISPLAYMODE := DIALOG.GETNUMBER(PDIALOGID, 'DisplayMode');
 1339 
 1340       VCODE := DIALOG.GETNUMBER(PDIALOGID, 'Code');
 1341 
 1342       REFRESH(VFICODE, VDISPLAYMODE, VCODE);
 1343 
 1344     ELSIF (PWHAT = DIALOG.WT_ITEMPRE) THEN
 1345       IF (PITEMNAME = UPPER('mnUserProperty')) THEN
 1346         OBJUSERPROPERTY.SHOWREFERENCE(OBJECT_NAME, CHECKRIGHT(RIGHT_MODIFY), 'Retailer');
 1347 
 1348       ELSIF (PITEMNAME = UPPER('mnMerchantID')) THEN
 1349         DIALOG.EXEC(MERCHANTIDGENERATOR.SETUPGENERATORDIALOG(CHECKRIGHT(RIGHT_MODIFY)));
 1350       
 1351       ELSIF (PITEMNAME = UPPER('mnBlockUpdateValues')) THEN
 1352         DIALOG.EXEC(RETAILERSQLTOOL.EDITDLG(RETAILERSQLTOOL.CBTUPDATEVALUES, RETAILERSQLTOOL.COIDENT, CHECKRIGHT(RIGHT_MODIFY)));
 1353       
 1354       ELSIF (PITEMNAME = UPPER('mnBlockSave')) THEN
 1355         DIALOG.EXEC(RETAILERSQLTOOL.EDITDLG(RETAILERSQLTOOL.CBTSAVE, RETAILERSQLTOOL.COIDENT, CHECKRIGHT(RIGHT_MODIFY)));
 1356 
 1357       ELSE
 1358 
 1359         VCURPOS := BROWSER.GETCURPOS(PDIALOGID);
 1360         VROW := GETROW(VCURPOS);
 1361 
 1362         IF (PITEMNAME = UPPER('mnDisplayAll')) THEN
 1363           DIALOG.DISABLEMENUCASE(PDIALOGID, 'mnDisplayAll');
 1364           DIALOG.ENABLEMENUCASE(PDIALOGID, 'mnDisplayActive');
 1365           DIALOG.ENABLEMENUCASE(PDIALOGID, 'mnDisplayInactive');
 1366           DIALOG.PUTNUMBER(PDIALOGID, 'DisplayMode', NULL);
 1367 
 1368           VDISPLAYMODE := DIALOG.GETNUMBER(PDIALOGID, 'DisplayMode');
 1369 
 1370           REFRESH(VFICODE, VDISPLAYMODE, VROW.CODE, VCURPOS);
 1371 
 1372         ELSIF (PITEMNAME = UPPER('mnDisplayActive')) THEN
 1373           DIALOG.ENABLEMENUCASE(PDIALOGID, 'mnDisplayAll');
 1374           DIALOG.DISABLEMENUCASE(PDIALOGID, 'mnDisplayActive');
 1375           DIALOG.ENABLEMENUCASE(PDIALOGID, 'mnDisplayInactive');
 1376           DIALOG.PUTNUMBER(PDIALOGID, 'DisplayMode', CDMACTIVE);
 1377 
 1378           VDISPLAYMODE := DIALOG.GETNUMBER(PDIALOGID, 'DisplayMode');
 1379 
 1380           REFRESH(VFICODE, VDISPLAYMODE, VROW.CODE, VCURPOS);
 1381 
 1382         ELSIF (PITEMNAME = UPPER('mnDisplayInactive')) THEN
 1383           DIALOG.ENABLEMENUCASE(PDIALOGID, 'mnDisplayAll');
 1384           DIALOG.ENABLEMENUCASE(PDIALOGID, 'mnDisplayActive');
 1385           DIALOG.DISABLEMENUCASE(PDIALOGID, 'mnDisplayInactive');
 1386           DIALOG.PUTNUMBER(PDIALOGID, 'DisplayMode', CDMINACTIVE);
 1387 
 1388           VDISPLAYMODE := DIALOG.GETNUMBER(PDIALOGID, 'DisplayMode');
 1389 
 1390           REFRESH(VFICODE, VDISPLAYMODE, VROW.CODE, VCURPOS);
 1391 
 1392         ELSIF (PITEMNAME = UPPER('mnStructure')) THEN
 1393           DIALOG.EXEC(DIALOGTREE(VROW.FICODE, VROW.CODE, VROW.PARENTCODE));
 1394 
 1395         ELSIF (PITEMNAME = UPPER('mnReferenceTerminal')) THEN
 1396           DIALOG.EXEC(REFERENCETERMINAL.DIALOGREFERENCE(VROW.FICODE, VROW.CODE, REFERENCETERMINAL.CDMREFERENCE));  
 1397 
 1398         
 1399         ELSIF (PITEMNAME = UPPER('mnReferenceGroup')) THEN
 1400           DIALOG.EXEC(RETAILERGROUP.DIALOGGROUPLIST(CHECKRIGHT(RIGHT_MODIFY)));
 1401         
 1402 
 1403         ELSE
 1404           VDISPLAYMODE := DIALOG.GETNUMBER(PDIALOGID, 'DisplayMode');
 1405 
 1406           IF (PITEMNAME = UPPER('btnFilter')) THEN
 1407             REFRESH(VFICODE, VDISPLAYMODE, VROW.CODE, VCURPOS);
 1408 
 1409           ELSIF (PITEMNAME = UPPER('btnAdd')) THEN
 1410             IF (DIALOG.EXEC(DIALOGCREATEOBJECT(VROW.FICODE)) = DIALOG.CMOK) THEN
 1411               REFRESH(VFICODE, VDISPLAYMODE, SROW.CODE, VCURPOS);
 1412             ELSE
 1413               REFRESH(VFICODE, VDISPLAYMODE, VROW.CODE, VCURPOS);
 1414             END IF;
 1415 
 1416           ELSIF (PITEMNAME = UPPER('btnCopy')) THEN
 1417             IF (DIALOG.EXEC(DIALOGCOPYOBJECT(VROW.CODE)) = DIALOG.CMOK) THEN
 1418               REFRESH(VFICODE, VDISPLAYMODE, SROW.CODE, VCURPOS);
 1419             ELSE
 1420               REFRESH(VFICODE, VDISPLAYMODE, VROW.CODE, VCURPOS);
 1421             END IF;
 1422 
 1423           ELSIF (PITEMNAME = UPPER('btnDelete')) THEN
 1424             SROW := VROW;
 1425 
 1426             IF (DELOBJECT()) THEN
 1427               REFRESH(VFICODE, VDISPLAYMODE, NULL, VCURPOS);
 1428             END IF;
 1429 
 1430           ELSIF (PITEMNAME = UPPER('Scroller')) THEN
 1431             IF (VDIALOGMODE = CDMSELECT) THEN
 1432               DIALOG.HANDLEACTION(DIALOG.IDBYNAME(PDIALOGID, UPPER('btnApply')), PDIALOGID, UPPER('btnApply'));
 1433             ELSE
 1434               IF (DIALOG.EXEC(DIALOGUPDATEOBJECT(VROW.CODE, VDIALOGMODE)) = DIALOG.CMOK) THEN  
 1435                 REFRESH(VFICODE, VDISPLAYMODE, SROW.CODE, VCURPOS);
 1436               ELSE
 1437                 REFRESH(VFICODE, VDISPLAYMODE, VROW.CODE, VCURPOS);
 1438               END IF;
 1439             END IF;
 1440 
 1441           END IF;
 1442         END IF;
 1443       END IF;
 1444 
 1445     ELSIF (PWHAT = DIALOG.WT_DIALOGVALID) THEN
 1446       IF (PITEMNAME = UPPER('btnApply')) THEN
 1447         VCURPOS := BROWSER.GETCURPOS(PDIALOGID);
 1448         VROW := GETROW(VCURPOS);
 1449         DIALOG.PUTNUMBER(PDIALOGID, 'Code', VROW.CODE);
 1450 
 1451       ELSIF (PITEMNAME = UPPER('btnClear')) THEN  
 1452         DIALOG.PUTNUMBER(PDIALOGID, 'Code', NULL);
 1453       END IF;
 1454 
 1455     ELSIF (PWHAT = DIALOG.WT_DIALOGPOST) THEN
 1456       DSCLOSE(SDSHANDLE);
 1457     END IF;
 1458 
 1459   EXCEPTION
 1460     WHEN OTHERS THEN
 1461       ERROR.SAVE(CPROCNAME);
 1462       RAISE;
 1463   END;
 1464 
 1465 PROCEDURE REMAKECLIENTDIALOG(PDIALOG NUMBER, PCLIENTTYPE NUMBER := CCLIENTCORPORATE) 
 1466   IS
 1467   BEGIN      
 1468     IF PCLIENTTYPE = CCLIENTCORPORATE THEN
 1469       DIALOG.SETVISIBLE(PDIALOG,'CorporateName',      TRUE);
 1470       DIALOG.SETVISIBLE(PDIALOG,'CorporateAddress',   TRUE);
 1471       DIALOG.SETVISIBLE(PDIALOG,'ChangeCorporate',    TRUE);
 1472       DIALOG.SETVISIBLE(PDIALOG,'ViewCorporate',      TRUE);
 1473       DIALOG.SETVISIBLE(PDIALOG,'PersonName',    FALSE);
 1474       DIALOG.SETVISIBLE(PDIALOG,'PersonAddress', FALSE);
 1475       DIALOG.SETVISIBLE(PDIALOG,'ChangePerson',  FALSE);
 1476       DIALOG.SETVISIBLE(PDIALOG,'ViewPerson',    FALSE);
 1477     ELSE 
 1478       DIALOG.SETVISIBLE(PDIALOG,'CorporateName',      FALSE);
 1479       DIALOG.SETVISIBLE(PDIALOG,'CorporateAddress',   FALSE);
 1480       DIALOG.SETVISIBLE(PDIALOG,'ChangeCorporate',    FALSE);
 1481       DIALOG.SETVISIBLE(PDIALOG,'ViewCorporate',      FALSE);
 1482       DIALOG.SETVISIBLE(PDIALOG,'PersonName',    TRUE);
 1483       DIALOG.SETVISIBLE(PDIALOG,'PersonAddress', TRUE);
 1484       DIALOG.SETVISIBLE(PDIALOG,'ChangePerson',  TRUE);
 1485       DIALOG.SETVISIBLE(PDIALOG,'ViewPerson',    TRUE);
 1486     END IF;
 1487     DIALOG.PUTCHAR(PDIALOG, 'Code_Client',       NULL);
 1488     DIALOG.PUTCHAR(PDIALOG, 'ClientTypeLabel',   DIALOG.GETCURRENTRECORDCHAR(PDIALOG, 'ClientType', 'Name'));
 1489     DIALOG.PUTCHAR(PDIALOG, 'CorporateName',          NULL);
 1490     DIALOG.PUTCHAR(PDIALOG, 'CorporateAddress',       NULL);
 1491     DIALOG.PUTCHAR(PDIALOG, 'PersonName',        NULL);
 1492     DIALOG.PUTCHAR(PDIALOG, 'PersonAddress',     NULL);
 1493     REFERENCEFI.SHOWCLIENT(PDIALOG, NULL, PCLIENTTYPE);
 1494   END;
 1495 
 1496 
 1497 PROCEDURE MAKECLIENTDIALOG(PDIALOG NUMBER, X NUMBER, Y NUMBER, DX NUMBER, PNAME VARCHAR:='Customer', PCLIENTTYPE NUMBER := CCLIENTCORPORATE)
 1498   IS
 1499   BEGIN                
 1500     DIALOG.BEVEL(PDIALOG, X,Y,DX,4,DIALOG.BEVEL_FRAME,TRUE,PNAME,4);
 1501     DIALOG.INPUTINTEGER(PDIALOG,'Code_Client', 0, 0, 0, 16); 
 1502     DIALOG.SETITEMATTRIBUTIES(PDIALOG,'Code_Client', DIALOG.ECHOOFF || DIALOG.UPDATEOFF || DIALOG.SELECTOFF);
 1503 
 1504     DIALOG.TEXTLABEL(PDIALOG,'CorporateName', 17+X, 1+Y, DX-32,NULL,'        Name:');
 1505     DIALOG.TEXTLABEL(PDIALOG,'CorporateAddress', 17+X, 2+Y, DX-32,NULL,'Address:');
 1506       
 1507     DIALOG.BUTTON (PDIALOG, 'ViewCorporate'      , DX+X-14, 1+Y, 12, 'Details', 0,  0, 'Details of corporate customer');
 1508 
 1509     IF SREGIM = REG_ADD THEN
 1510       DIALOG.BUTTON (PDIALOG, 'ChangeCorporate'    , DX+X-14, 3+Y, 12, 'Search', 0,  0, 'Search for corporate customer');
 1511     ELSIF SREGIM = REG_EDIT THEN
 1512       DIALOG.BUTTON (PDIALOG, 'ChangeCorporate'    , DX+X-14, 3+Y, 12, 'Change', 0,  0, 'Change corporate customer');
 1513     END IF;
 1514 
 1515     DIALOG.SETITEMPRE(PDIALOG, 'ChangeCorporate' , 'ReferenceFI.DialogEditProc');
 1516     DIALOG.SETITEMPRE(PDIALOG, 'ViewCorporate'   , 'ReferenceFI.DialogEditProc');
 1517     DIALOG.SETENABLE(PDIALOG,'ViewCorporate',FALSE);
 1518 
 1519     DIALOG.TEXTLABEL(PDIALOG,'PersonName', 17+X, 1+Y, DX-32,NULL,'        Name:');
 1520     DIALOG.TEXTLABEL(PDIALOG,'PersonAddress', 17+X, 2+Y, DX-32,NULL,'Address:');
 1521 
 1522     DIALOG.BUTTON (PDIALOG, 'ViewPerson'      , DX+X-14, 1+Y, 12, 'Details', 0,  0, 'Details of private customer');
 1523 
 1524     IF SREGIM = REG_ADD THEN
 1525       DIALOG.BUTTON (PDIALOG, 'ChangePerson'    , DX+X-14, 3+Y, 12, 'Search', 0,  0, 'Search for private customer');
 1526     ELSIF SREGIM = REG_EDIT THEN
 1527       DIALOG.BUTTON (PDIALOG, 'ChangePerson'    , DX+X-14, 3+Y, 12, 'Change', 0,  0, 'Change private customer');
 1528     END IF;
 1529 
 1530     DIALOG.SETITEMPRE(PDIALOG, 'ChangePerson' , 'ReferenceFI.DialogEditProc');
 1531     DIALOG.SETITEMPRE(PDIALOG, 'ViewPerson'   , 'ReferenceFI.DialogEditProc');
 1532     DIALOG.SETENABLE(PDIALOG,'ViewPerson',FALSE);
 1533 
 1534     REMAKECLIENTDIALOG(PDIALOG, PCLIENTTYPE);
 1535   END;
 1536 
 1537  
 1538 PROCEDURE SETACCOUNT (PCANEDIT BOOLEAN) 
 1539  
 1540  IS
 1541    CBRANCH CONSTANT NUMBER := SEANCE.GETBRANCH();
 1542    VHAVING  BOOLEAN;
 1543    VARRLIST TYPES.ARRNUM;
 1544    VHAVINGN NUMBER;
 1545    VACC     NUMBER;
 1546    
 1547    
 1548    VACCPASS NUMBER;  
 1549    VNEWROW  TYPERETAILERROW := SROW; 
 1550  BEGIN
 1551 
 1552   VHAVING := SROW.HAVETRANSIT IS NOT NULL;
 1553   VHAVINGN := HTOOLS.IIF(VHAVING,1,NULL);
 1554 
 1555   VARRLIST(1):=SROW.ACC_ACT ;
 1556   VARRLIST(2):=SROW.ACC_PASS;
 1557   VACC:=SROW.ACCOUNTGROUPCODE;
 1558 
 1559   ACCGROUPVIEW.VIEWACCOUNT(ACCGROUPVIEW.REG_RETAILER,VACC,VACCPASS,VHAVING,2,VARRLIST,SARRACCINFO, PCANEDIT, SROW.CODE);  
 1560 
 1561   IF PCANEDIT THEN
 1562     VHAVINGN := HTOOLS.IIF(VHAVING,1,NULL);
 1563 
 1564      UPDATE TREFERENCERETAILER SET
 1565        ACCOUNTGROUPCODE = VACC,
 1566        HAVETRANSIT      = VHAVINGN,
 1567        ACC_ACT          = VARRLIST(1),
 1568        ACC_PASS         = VARRLIST(2)
 1569        WHERE BRANCH = CBRANCH AND
 1570                CODE = SROW.CODE;
 1571       VNEWROW.ACCOUNTGROUPCODE := VACC;
 1572       VNEWROW.HAVETRANSIT  := VHAVINGN;
 1573       VNEWROW.ACC_ACT  := VARRLIST(1);
 1574       VNEWROW.ACC_PASS := VARRLIST(2);
 1575 
 1576       LOGCHANGES(A4MLOG.ACT_CHANGE, SROW, VNEWROW); 
 1577      COMMIT;
 1578      SROW.ACCOUNTGROUPCODE := VACC;
 1579      SROW.HAVETRANSIT  := VHAVINGN;
 1580      SROW.ACC_ACT  := VARRLIST(1);
 1581      SROW.ACC_PASS := VARRLIST(2);
 1582    END IF;
 1583 
 1584  EXCEPTION
 1585   WHEN OTHERS THEN
 1586    ERR.SETERROR(SQLCODE,'ReferenceRetailer.SetAccount');
 1587  END;
 1588 
 1589 
 1590 
 1591 
 1592 FUNCTION CREATERETAILERCODE  RETURN NUMBER IS
 1593   CPROCNAME CONSTANT VARCHAR2(100) := CPACKAGENAME || '.CreateRetailerCode';
 1594   VCODE  NUMBER;
 1595 BEGIN
 1596   SELECT SEQ_RET.NEXTVAL
 1597     INTO VCODE
 1598     FROM DUAL;
 1599   S.SAY(CPROCNAME || ': return '||VCODE);
 1600   RETURN VCODE;
 1601 EXCEPTION
 1602   WHEN OTHERS THEN
 1603     ERROR.SAVE('ReferenceRetailer.CreateRetailerCode');
 1604     RAISE;
 1605 END;
 1606 
 1607 
 1608 
 1609 FUNCTION GETACTIVE(PINACTIVE IN NUMBER, PPARENTINACTIVE IN NUMBER) RETURN NUMBER
 1610   IS
 1611   BEGIN
 1612     RETURN SERVICE.IIF(NVL(PINACTIVE, CACTIVE) = CACTIVE AND NVL(PPARENTINACTIVE, CACTIVE) = CACTIVE, CACTIVE, CINACTIVE);
 1613   EXCEPTION
 1614     WHEN OTHERS THEN
 1615       ERROR.SAVE(CPACKAGENAME || '.GetActive');
 1616       RAISE;
 1617   END;
 1618 
 1619 
 1620 
 1621 PROCEDURE SETCHILDUPDATED(PCODE IN NUMBER)
 1622   IS
 1623     CPROCNAME CONSTANT VARCHAR2(100) := CPACKAGENAME || '.SetChildUpdated';
 1624     VROW    TREFERENCERETAILER%ROWTYPE;
 1625     VBRANCH NUMBER;
 1626   BEGIN
 1627     S.SAY(CPROCNAME || ': start ['||PCODE||']');
 1628     VROW := SROW;
 1629 
 1630     VBRANCH := SEANCE.GETBRANCH;
 1631 
 1632     FOR I IN (SELECT * FROM TREFERENCERETAILER
 1633                 WHERE BRANCH = VBRANCH
 1634                   AND PARENTCODE = PCODE) LOOP
 1635       UPDATEOBJECT(I, NULL, CMAPI, FALSE); 
 1636     END LOOP;
 1637 
 1638     SROW := VROW;
 1639     S.SAY(CPROCNAME || ': complete');
 1640 
 1641   EXCEPTION
 1642     WHEN OTHERS THEN
 1643       ERROR.SAVE(CPACKAGENAME || '.SetChildUpdated');
 1644       RAISE;
 1645   END;
 1646 
 1647 
 1648 
 1649 
 1650 PROCEDURE SAVEOBJ (PMODE TYPEMODE, PALTERATIONMODE TYPEALTERATIONMODE, PUSEBLOCK BOOLEAN, PDIALOG NUMBER := NULL) 
 1651  IS
 1652    CPROCNAME CONSTANT VARCHAR2(100) := CPACKAGENAME || '.SaveObj';
 1653    CBRANCH CONSTANT NUMBER := SEANCE.GETBRANCH();
 1654    
 1655    VPREVINACTIVE TREFERENCERETAILER.INACTIVE%TYPE;
 1656    VCURRINACTIVE TREFERENCERETAILER.INACTIVE%TYPE;  
 1657  BEGIN
 1658    S.SAY(CPROCNAME || ': start [Mode='||PMODE||', AltMode='||PALTERATIONMODE||', Code='||SROW.CODE||']');
 1659    
 1660 
 1661 
 1662 
 1663 
 1664 
 1665  
 1666 
 1667    
 1668    SROW.UPDATECLERK := CLERK.GETCODE();
 1669    SROW.UPDATEDATE  := SYSDATE();
 1670    
 1671 
 1672    IF SROW.PARENTCODE IS NOT NULL THEN  
 1673      SROW.PARENTINACTIVE := GETACTIVE(SROW.PARENTCODE);
 1674    END IF;
 1675 
 1676    IF PALTERATIONMODE = REG_ADD THEN
 1677      
 1678      SROW.CREATECLERK := CLERK.GETCODE();
 1679      SROW.CREATEDATE  := SYSDATE();
 1680      
 1681 
 1682        SROW.BRANCH    := CBRANCH;
 1683      SROW.CODE      := COALESCE(SROW.CODE, CREATERETAILERCODE());  
 1684      SROW.OBJECTUID := COALESCE(SROW.OBJECTUID, OBJECTUID.NEWUID(OBJECT_NAME, SROW.CODE, PNOCOMMIT => TRUE));  
 1685      
 1686      IF PUSEBLOCK THEN
 1687        RUNUPDATEVALUESBLOCK(PMODE, REG_ADD);
 1688      END IF;
 1689      
 1690      IF PMODE = CMGUI AND PDIALOG IS NOT NULL THEN  
 1691         IF NOT EXCHANGE.OPEREXECFORALL( EXCHANGE.OBJ_RETAILER, EXCHANGE.OP_VALIDDIALOG, PDIALOG, FALSE) THEN
 1692           RAISE EXMOVALIDATION; 
 1693         END IF;
 1694      END IF;
 1695      
 1696 
 1697      IF PUSEBLOCK THEN 
 1698        RUNSAVECONTROLBLOCK (PMODE, REG_ADD);
 1699      END IF;
 1700      
 1701      FORMGEN.EXECSTRUCTOPER(SSTRUCT,FORMGEN.OP_INS);
 1702    ELSE
 1703      VPREVINACTIVE := GETACTIVE(SROW.CODE);  
 1704 
 1705      
 1706      IF PUSEBLOCK THEN
 1707        RUNUPDATEVALUESBLOCK(PMODE, REG_EDIT);
 1708      END IF;
 1709      
 1710      IF PMODE = CMGUI AND PDIALOG IS NOT NULL THEN  
 1711        IF NOT EXCHANGE.OPEREXECFORALL( EXCHANGE.OBJ_RETAILER, EXCHANGE.OP_VALIDDIALOG, PDIALOG, FALSE) THEN
 1712          RAISE EXMOVALIDATION; 
 1713        END IF;
 1714      END IF;
 1715      
 1716      IF PUSEBLOCK THEN 
 1717        RUNSAVECONTROLBLOCK (PMODE, REG_EDIT);
 1718      END IF;
 1719      
 1720      FORMGEN.EXECSTRUCTOPER(SSTRUCT,FORMGEN.OP_UP);
 1721 
 1722        
 1723      VCURRINACTIVE := GETACTIVE(SROW.INACTIVE, SROW.PARENTINACTIVE);
 1724 
 1725      IF NOT (HTOOLS.EQUAL(VPREVINACTIVE, VCURRINACTIVE)) THEN
 1726        RETAILEREVENTLOG.ADDEVENTRECORD(SROW.CODE, RETAILEREVENTLOG.CEVUPDATE, RETAILEREVENTLOG.CAVINACTIVE, VCURRINACTIVE);
 1727      END IF;
 1728      
 1729 
 1730      REFERENCETERMINAL.SETUPDATED(SROW.CODE);  
 1731      SETCHILDUPDATED(SROW.CODE);  
 1732    END IF;
 1733 
 1734  EXCEPTION
 1735    
 1736    WHEN EXMOVALIDATION THEN
 1737      ERROR.SAVE('ReferenceRetailer.SaveObj');
 1738      RAISE;
 1739      
 1740    WHEN OTHERS THEN
 1741      ERROR.SAVE('ReferenceRetailer.SaveObj');
 1742      RAISE;
 1743  END;
 1744 
 1745  
 1746 PROCEDURE DELETEFORFI(PFICODE NUMBER)
 1747  
 1748   IS
 1749     
 1750     TYPE TYPERETAILERROWARRAY IS TABLE OF TREFERENCERETAILER%ROWTYPE
 1751       INDEX BY BINARY_INTEGER;
 1752 
 1753     VBRANCH         NUMBER;
 1754     VARETAILERROWS  TYPERETAILERROWARRAY;
 1755     I               NUMBER;
 1756     VTHIS           INTEGER;
 1757     VRET            NUMBER;
 1758     
 1759     
 1760  BEGIN
 1761    
 1762    VBRANCH := SEANCE.GETBRANCH();
 1763 
 1764     SELECT *
 1765       BULK COLLECT INTO VARETAILERROWS
 1766       FROM TREFERENCERETAILER
 1767       WHERE BRANCH = VBRANCH
 1768         AND FICODE = PFICODE
 1769       ORDER BY IDENT DESC;
 1770 
 1771     I := VARETAILERROWS.FIRST();
 1772 
 1773     WHILE I IS NOT NULL LOOP
 1774       VTHIS := NEWOBJECT(VARETAILERROWS(I).CODE, 'W');
 1775 
 1776       IF VTHIS = BAD_THIS THEN
 1777         ERROR.RAISEWHENERR();
 1778       ELSE
 1779         FREEOBJECT(VARETAILERROWS(I).CODE, VTHIS);
 1780       END IF;
 1781 
 1782       REFERENCETERMINAL.DELETEFORRETAILER(VARETAILERROWS(I).CODE);
 1783 
 1784       IF VARETAILERROWS(I).ACCOUNTGROUPCODE IS NOT NULL THEN
 1785         VRET := ACCGROUP.DELETEACCGROUP(VARETAILERROWS(I).ACCOUNTGROUPCODE);
 1786       END IF;
 1787 
 1788       IF VARETAILERROWS(I).ACC_ACT IS NOT NULL THEN
 1789         VRET := ACCGROUP.DELETEACCGROUP(VARETAILERROWS(I).ACC_ACT);
 1790       END IF;
 1791 
 1792       IF VARETAILERROWS(I).ACC_PASS IS NOT NULL THEN
 1793         VRET := ACCGROUP.DELETEACCGROUP(VARETAILERROWS(I).ACC_PASS);
 1794       END IF;
 1795       
 1796       
 1797 
 1798 
 1799 
 1800 
 1801 
 1802 
 1803 
 1804 
 1805 
 1806 
 1807 
 1808 
 1809 
 1810 
 1811 
 1812 
 1813 
 1814 
 1815 
 1816 
 1817 
 1818 
 1819 
 1820 
 1821       DELETERETAILER(VARETAILERROWS(I), TRUE); 
 1822       
 1823       I := VARETAILERROWS.NEXT(I);
 1824     END LOOP;
 1825     
 1826   EXCEPTION
 1827     WHEN OTHERS THEN
 1828       ERROR.SAVE('ReferenceRetailer.DeleteForFi');  
 1829       RAISE;
 1830   END;
 1831 
 1832 
 1833 
 1834  
 1835 FUNCTION  GETDIALOG (PCODE NUMBER) RETURN NUMBER
 1836  
 1837   IS
 1838     VDIALOG NUMBER;
 1839   BEGIN
 1840     S.SAY('ReferenceRetailer.GetDialog pCode: '||PCODE);
 1841     SROW := READOBJECT(PCODE);
 1842 
 1843     IF SROW.CODE IS NULL THEN
 1844       RETURN SERVICE.MESSAGEDIALOG('Warning!', 'Retailer not found.');
 1845     END IF;
 1846 
 1847     INITSTRUCT;
 1848     VDIALOG := DIALOGEDIT(REG_EDIT, FALSE, SROW.FICODE);  
 1849 
 1850     RETURN VDIALOG;
 1851   END;
 1852 
 1853 
 1854 
 1855 FUNCTION DIALOGEDIT(PALTERATIONMODE NUMBER, PCANEDIT BOOLEAN, PFICODE NUMBER, PDIALOGMODE TYPEDIALOGMODE) RETURN NUMBER  
 1856  IS
 1857    CPROCNAME CONSTANT VARCHAR2(100) := CPACKAGENAME || '.DialogEdit'; 
 1858    VDIALOG         NUMBER;
 1859    VNAME           VARCHAR(200);
 1860 
 1861    
 1862    
 1863    VDW    NUMBER:=80; 
 1864    VDH    NUMBER:=24; 
 1865    VBW    NUMBER:=12; 
 1866    VPH    NUMBER; 
 1867    
 1868 
 1869    P1              NUMBER;
 1870    P2              NUMBER;
 1871    P3              NUMBER;
 1872    P4              NUMBER;
 1873    P5              NUMBER;
 1874    P6              NUMBER;
 1875    P7              NUMBER;
 1876    P8              NUMBER;
 1877    P9              NUMBER;
 1878    P10             NUMBER;                            
 1879    P11             NUMBER;                            
 1880    P12             NUMBER;                            
 1881    P13             NUMBER;                            
 1882    P14             NUMBER;                            
 1883    VLIMPAGE1       NUMBER;                            
 1884    VLIMPAGE2       NUMBER;                            
 1885    VDX             NUMBER;                            
 1886    VARRPROGRAML    APITYPES.TYPELOYALTYPROGRAMARRAY;
 1887    VMAINMENU       NUMBER;
 1888    VDICTMENU       NUMBER;
 1889    VINACTIVEEDIT   BOOLEAN := TRUE;                   
 1890  BEGIN
 1891 
 1892    SREGIM := PALTERATIONMODE;
 1893    IF (SREGIM = REG_EDIT) THEN
 1894      VNAME := 'Retailer data '||SROW.CODE;
 1895    ELSIF (SREGIM = REG_ADD) THEN
 1896      VNAME := 'Add retailer';
 1897    END IF;
 1898 
 1899    VDIALOG:=DIALOG.NEW(VNAME, 0, 0, VDW, VDH, PRESIZABLE => TRUE, PEXTID => CPROCNAME); 
 1900 
 1901    DIALOG.PAGELIST(VDIALOG, 'PAGER', 1, 1, VDW-2, VDH-4); 
 1902    P1  := DIALOG.PAGE(VDIALOG, 'PAGER', 'General', IDPAGEGENERAL);  
 1903    P2  := DIALOG.PAGE(VDIALOG, 'PAGER', 'Address');
 1904    P13 := DIALOG.PAGE(VDIALOG, 'PAGER', 'Limits');  
 1905 
 1906    P6  := DIALOG.PAGE(VDIALOG, 'PAGER', 'Fin. profile');
 1907    P7  := DIALOG.PAGE(VDIALOG, 'PAGER', 'Acq. groups');
 1908    P3  := DIALOG.PAGE(VDIALOG, 'PAGER', 'Representatives');
 1909    P8  := DIALOG.PAGE(VDIALOG, 'PAGER', 'Loyalty programs');
 1910    P5  := DIALOG.PAGE(VDIALOG, 'PAGER', 'Comments');
 1911    P9  := DIALOG.PAGE(VDIALOG, 'PAGER', 'Payment systems');
 1912    P11 := DIALOG.PAGE(VDIALOG, 'PAGER', 'External attributes');  
 1913    P12 := DIALOG.PAGE(VDIALOG, 'PAGER', 'Groups');  
 1914    P10 := DIALOG.PAGE(VDIALOG, 'PAGER', 'Additional'); 
 1915    P14 := DIALOG.PAGE(VDIALOG, 'PAGER', 'Lists of MCC'); 
 1916 
 1917    
 1918    OBJUSERPROPERTY.ADDPAGE(VDIALOG, 'PAGER', 'User', VDH-4, OBJECT_NAME); 
 1919    OBJUSERPROPERTY.FILLPAGE(VDIALOG, OBJECT_NAME, SERVICE.IIF(SREGIM = REG_EDIT, SROW.OBJECTUID, NULL));
 1920    
 1921 
 1922    P4  := DIALOG.PAGE(VDIALOG, 'PAGER', 'System');
 1923 
 1924    
 1925    DIALOG.INPUTINTEGER(VDIALOG, 'This', 0, 0, ' ');
 1926    DIALOG.SETVISIBLE(VDIALOG, 'This', FALSE);
 1927    
 1928 
 1929    VMAINMENU  := MNU.NEW(VDIALOG);
 1930    VDICTMENU := MNU.SUBMENU(VMAINMENU, 'Data', 'Data');
 1931 
 1932    MNU.ITEM(VDICTMENU, 'ACCLIST' , 'List of accts', 0, 0, '');
 1933      DIALOG.SETITEMPRE(VDIALOG, 'ACCLIST', 'ReferenceRetailer.DialogEditProc');
 1934 
 1935    
 1936    MNU.ITEM(VDICTMENU, 'SUBACC' , 'Additional accounts', 0, 0, ''); 
 1937      DIALOG.SETITEMPRE(VDIALOG, 'SUBACC', 'ReferenceRetailer.DialogEditProc');
 1938      IF ADDACCGROUP.GETACCGROUPCOUNT(ADDACCGROUP.C_OBJ_RET) = 0 THEN
 1939        DIALOG.SETENABLE(VDIALOG, 'SUBACC', FALSE);
 1940      END IF;
 1941    
 1942 
 1943    
 1944    MNU.ITEM(VDICTMENU, 'CNS', 'CMS', 0, 0, 'CMS');
 1945      DIALOG.SETITEMPRE(VDIALOG, 'CNS', 'ReferenceRetailer.DialogEditProc');
 1946    
 1947 
 1948    MNU.ITEM(VDICTMENU, 'REFTERM' , 'Terminals', 0, 0, '');
 1949      DIALOG.SETITEMPRE(VDIALOG, 'REFTERM', 'ReferenceRetailer.DialogEditProc');
 1950    MNU.ITEM(VDICTMENU, 'CustomerList' , 'Telebank customers', 0, 0, '');        
 1951      DIALOG.SETITEMPRE(VDIALOG, 'CustomerList', 'ReferenceRetailer.DialogEditProc');  
 1952    MNU.ITEM(VDICTMENU, 'ChildList' , 'Child retailers', 0, 0, '');           
 1953      DIALOG.SETITEMPRE(VDIALOG, 'ChildList', 'ReferenceRetailer.DialogEditProc');  
 1954 
 1955    
 1956    MNU.ITEM(VDICTMENU, 'F2SList' , 'Facilitators/Submerchants', 0, 0, '');           
 1957      DIALOG.SETITEMPRE(VDIALOG, 'F2SList', 'ReferenceRetailer.DialogEditProc');  
 1958    
 1959 
 1960    
 1961    IF (SREGIM = REG_EDIT) THEN
 1962      RETAILERCUSTOMMODULE.MAKEMENUMODULE(VDIALOG, VDICTMENU, SROW.CODE, CHECKRIGHT(RIGHT_MODIFY));
 1963    END IF;
 1964    
 1965 
 1966    
 1967    DIALOG.SEPARATOR(VDICTMENU);
 1968    MNU.ITEM(VDICTMENU, 'mnStructure', 'Structure', 0, 0, '');
 1969    DIALOG.SETITEMPRE(VDIALOG, 'mnStructure', 'ReferenceRetailer.DialogEditProc');
 1970    
 1971 
 1972    
 1973    MNU.SEPARATOR(VDICTMENU);
 1974    MNU.ITEM(VDICTMENU, 'A4MLog', 'Event log', 0, 0, 'View Event log of retailer');  
 1975    DIALOG.SETITEMPRE(VDIALOG, 'A4MLog', 'ReferenceRetailer.DialogEditProc');  
 1976    
 1977 
 1978    
 1979    
 1980    REFERENCEFI.MAKEITEM(P1, 'FIID_EDIT', 27, 2, 10, 'FIID:', 'Financial institution', PUSERROUTINE => 'ReferenceRetailer.DialogEditProc');  
 1981      DIALOG.SETENABLE(P1, 'FIID_EDIT', PALTERATIONMODE = REG_ADD AND PDIALOGMODE = CDMREFERENCE);  
 1982 
 1983    IF (SREGIM = REG_EDIT) THEN  
 1984      REFERENCEFI.SETITEMDATA(P1, 'FIID_EDIT', SROW.FICODE);  
 1985    ELSE
 1986      REFERENCEFI.SETITEMDATA(P1, 'FIID_EDIT', PFICODE);  
 1987    END IF;
 1988    
 1989 
 1990    DIALOG.INPUTCHAR(P1, 'ParentCode', 27, 3, 20, 'Parent retailer', 20, '      Parent retailer:');
 1991    DIALOG.SETENABLE(VDIALOG, 'ParentCode', FALSE);
 1992 
 1993    DIALOG.BUTTON(P1, 'FindParent', 49, 3, 3, '...', PHANDLER => 'ReferenceRetailer.DialogEditProc');
 1994    DIALOG.SETENABLE(VDIALOG, 'FindParent', PALTERATIONMODE IN (REG_ADD, REG_EDIT));
 1995 
 1996    FORMGEN.SETFORMITEMDIALOG(SFORM, 'RET', P1);
 1997    FORMGEN.EXECFORMOPER(SFORM, FORMGEN.OP_MKDIALOG);
 1998    REFERENCEMCC.MAKEITEM(P1, 'MCC', 27, 8, TRUE, PADDEMPTYROW => TRUE, PONLYFAVORITES => TRUE, PREADONLY => TRUE ); 
 1999 
 2000    REFERENCEBRANCHPART.INPUTBRANCHPART(P1, 27, 9, 49, TRUE);
 2001 
 2002    
 2003    DIALOG.INPUTCHAR(P1, 'ClientType', 27, 10, 1, 'Owner type', 17, '   Owner type:'); 
 2004    DIALOG.LISTADDFIELD(P1, 'ClientType', 'Code',  'N',  1);
 2005    DIALOG.LISTADDFIELD(P1, 'ClientType', 'Name',  'C',  16);
 2006    DIALOG.SETITEMPOST(P1, 'ClientType', 'ReferenceRetailer.DialogEditProc');
 2007    DIALOG.TEXTLABEL(P1,'ClientTypeLabel', 31, 10, 16);
 2008    
 2009 
 2010    
 2011    DIALOG.INPUTCHECK(P1, 'INACTIVE', 27, 11, 30, 'Set as inactive', 'Inactive retailer');
 2012    
 2013    MAKECLIENTDIALOG(P1, 1, 12, VDW-3, PCLIENTTYPE => SERVICE.IIF(PALTERATIONMODE = REG_ADD, CCLIENTCORPORATE, NVL(CLIENT.GETCLIENTTYPE(SROW.CODE_CLIENT), CCLIENTCORPORATE)));  
 2014    
 2015    DIALOG.BEVEL(P2, 1, 2, VDW-3, 11, DIALOG.BEVEL_FRAME, TRUE, 'Address', 4); 
 2016    REFERENCECOUNTRY.MAKEADDRESSPANEL(P2, 1, 2, REFERENCECOUNTRY.MODE_ADDRESS_PHONE);
 2017 
 2018    
 2019    DIALOG.BUTTON(P2, 'CopyAddress', 67, 3, 6, 'Auto', 0, 0, 'Copy address attributes from another place', 'ReferenceRetailer.DialogEditProc');
 2020    DIALOG.SETITEMPRE(P2, 'CopyAddress', 'ReferenceRetailer.DialogEditProc');
 2021    
 2022 
 2023    
 2024    
 2025    DIALOG.INPUTCHAR(P2, 'LOCATION', 17, 12, 56, 'Terminal address for payment system',100,'Location:');  
 2026    
 2027 
 2028 
 2029    
 2030    
 2031    
 2032    VPH := VDH-7;
 2033    DIALOG.PAGELIST(P13, 'LimitPageList', 1, 1, VDW-4, VPH);
 2034    
 2035      VLIMPAGE1 := DIALOG.PAGE(P13, 'LimitPageList', 'Limits in PC');
 2036 
 2037    REFERENCELIMIT.MAKEPANELRETAILER    (VLIMPAGE1, 2, 2, VDW-8, VPH-3);
 2038    
 2039     VLIMPAGE2 := DIALOG.PAGE(P13, 'LimitPageList', 'Internal limits'
 2040 );
 2041 
 2042    REFERENCELIMIT.MAKEPANELINTRETAILER    (VLIMPAGE2, 2, 2, VDW-8, VPH-3);
 2043    
 2044 
 2045    REFERENCECURRENCY.MAKEITEM(P13, 'LimitCurrency', 20, VPH+1, 3, 'Limit currency:', 'Select limit currency from list', 40,
 2046                               PANCHOR=>DIALOG.ANCHOR_BOTTOM+DIALOG.ANCHOR_LEFT);
 2047    
 2048 
 2049    
 2050    SFINPAGE := P6;
 2051 
 2052    VPH := VDH-5; 
 2053    FINRETAILERINSTANCE.MAKEPAGE(P6, VDW-4, VPH); 
 2054    IF (SREGIM = REG_EDIT) THEN  
 2055      FINRETAILERINSTANCE.LOADPAGE(P6, SROW.PROFILE, SROW.CODE);
 2056    END IF;
 2057 
 2058    
 2059    SGRPPAGE := P7;
 2060    VPH := VDH-7; 
 2061    REFERENCEACQGROUP.FILLDIALOGGROUP(P7, 3, 1, VDW-10, VPH, 
 2062                                      REFERENCEACQGROUP.COBJ_RETAILER,
 2063                                      HTOOLS.IIF(SREGIM = REG_EDIT, SROW.CODE, NULL));  
 2064 
 2065    
 2066    VPH := VDH-9; 
 2067    DIALOG.LIST(P3, 'CONTACTS', 3, 3, 56, VPH, 'List of contact persons', PANCHOR=>DIALOG.ANCHOR_ALL); 
 2068    DIALOG.LISTADDFIELD(P3, 'CONTACTS', 'ORDER', 'N', 10, 0); 
 2069    DIALOG.LISTADDFIELD(P3, 'CONTACTS', 'FIO','C', 40, 1);
 2070    DIALOG.LISTADDFIELD(P3, 'CONTACTS', 'POST', 'C', 30, 1);
 2071    BROWSER.SETCAPTION(P3, 'CONTACTS', 'Full name~Position');
 2072 
 2073    DIALOG.BUTTON (P3, 'C_ADD', VDW-VBW-4, 3, VBW, 'Add', 0, 0, 'Add contact person', PANCHOR=>DIALOG.ANCHOR_RIGHT); 
 2074    DIALOG.BUTTON (P3, 'C_DEL', VDW-VBW-4, 5, VBW, 'Delete', 0, 0, 'Delete contact person', PANCHOR=>DIALOG.ANCHOR_RIGHT); 
 2075 
 2076    DIALOG.SETITEMPRE(VDIALOG, 'C_ADD',    'ReferenceRetailer.DialogEditProc');
 2077    DIALOG.SETITEMPRE(VDIALOG, 'C_DEL',    'ReferenceRetailer.DialogEditProc');
 2078    DIALOG.SETITEMPRE(VDIALOG, 'CONTACTS', 'ReferenceRetailer.DialogEditProc');
 2079 
 2080    
 2081    
 2082    VPH := VDH-7;
 2083    WINDOWS.EDITTEXT(P5, 'Note', 3, 2, VDW-8, VPH, '');
 2084    DIALOG.SETANCHOR(P5, 'Note', DIALOG.ANCHOR_ALL);
 2085    
 2086 
 2087    
 2088    SPSPAGE := P9;
 2089    VPH := VDH-7; 
 2090    REFERENCEPSGROUP.FILLDIALOGGROUP (P9, 3, 1, VDW-10, VPH, 
 2091                                      REFERENCEPSGROUP.COBJ_RETAILER,
 2092                                      HTOOLS.IIF(SREGIM = REG_EDIT, SROW.CODE, NULL));  
 2093 
 2094    
 2095    
 2096    VPH := VDH-9; 
 2097    RETAILEREXTPSNAME.MAKEPAGE(P11, VDW-4, VPH, PCANEDIT); 
 2098    RETAILEREXTPSNAME.LOADPAGE(P11, HTOOLS.IIF(SREGIM = REG_EDIT, SROW.CODE, NULL));
 2099    
 2100 
 2101    
 2102    
 2103    VPH := VDH-8; 
 2104    RETAILERGROUP.MAKEPAGE(P12, VDW-8, VPH); 
 2105    RETAILERGROUP.LOADPAGE(P12, HTOOLS.IIF(SREGIM = REG_EDIT, SROW.CODE, NULL));
 2106    
 2107 
 2108    
 2109    VDX := 16; 
 2110    
 2111    DIALOG.BEVEL(P10, 1, 1, 77, 4, DIALOG.BEVEL_FRAME, TRUE, NULL, 4);
 2112    DIALOG.INPUTCHECK(P10, 'IsProtoType', VDX, 2, 30, 'Use as prototype for other retailers', PCAPTION => 'Use as prototype');
 2113    DIALOG.SETITEMPRE(P10, 'IsProtoType', 'ReferenceRetailer.DialogEditProc');
 2114    PROTOTYPEITEM(P10, 'ProtoType', VDX, 4, 10, 'Prototype:', 'Prototype', 20, PDOFILLITEM => FALSE);
 2115    
 2116 
 2117    
 2118    
 2119    SMCCRANGESPAGE := P14;
 2120    VPH := VDH-8; 
 2121    RETAILERMCCRANGES.MAKEPAGE(P14, VDW-8, VPH, PCANEDIT); 
 2122    RETAILERMCCRANGES.LOADPAGE(P14, HTOOLS.IIF(SREGIM = REG_EDIT, SROW.CODE, NULL));
 2123    
 2124 
 2125    
 2126    DIALOG.INPUTCHAR(P10, 'MerchantID', VDX, 7, 10, 'Merchant ID', 15, 'Merchant ID:', 'U');
 2127    DIALOG.SETENABLE(VDIALOG, 'MerchantID', NOT MERCHANTIDGENERATOR.ISGENERATE());  
 2128    
 2129 
 2130    
 2131    DIALOG.INPUTCHECK(P10, 'Reimbursement', 8, 9, 30, 'Suspend reimbursement', 'Reimbursement suspended'); 
 2132    
 2133 
 2134    
 2135 
 2136    
 2137    
 2138    
 2139    
 2140    
 2141    
 2142 
 2143 
 2144 
 2145 
 2146 
 2147 
 2148 
 2149 
 2150 
 2151 
 2152    DIALOG.INPUTCHECK(P10, 'AnyPOSRefund', 8, 11, 70, 'Permit refund, adjustment and reversals on any POS terminals of retailer', 
 2153                                                      'Permit refund, adjustment and reversals on any POS terminals');
 2154    DIALOG.SETITEMPRE(P10, 'AnyPOSRefund', 'ReferenceRetailer.DialogEditProc');
 2155    DIALOG.INPUTCHECK(P10, 'RefundFromSiblingsPos', 9, 12, 70, 'Including POS terminals of child retailers of parent retailer', 
 2156                                                             'Including POS terminals of child retailers of parent retailer');
 2157    DIALOG.SETVISIBLE(P10, 'RefundFromSiblingsPos', FALSE);
 2158    DIALOG.SETENABLED(P10, 'RefundFromSiblingsPos', FALSE);
 2159    
 2160 
 2161    EXCHANGE.OPEREXECFORALL(EXCHANGE.OBJ_RETAILER, EXCHANGE.OP_MAKEDIALOG, VDIALOG);
 2162 
 2163    IF (SREGIM = REG_EDIT) THEN
 2164      DIALOG.PUTCHAR(VDIALOG, 'ParentCode', GETIDENT(SROW.PARENTCODE));  
 2165 
 2166      
 2167      IF (SROW.PARENTCODE IS NOT NULL) THEN
 2168        VINACTIVEEDIT := GETINACTIVEEDIT(SROW.PARENTCODE);
 2169      END IF;
 2170 
 2171      IF (VINACTIVEEDIT) THEN
 2172        DIALOG.PUTBOOL(VDIALOG, 'INACTIVE', NVL(SROW.INACTIVE, CACTIVE) = CINACTIVE);
 2173      ELSE
 2174        DIALOG.PUTBOOL(VDIALOG, 'INACTIVE', TRUE);
 2175      END IF;
 2176 
 2177      DIALOG.SETENABLE(VDIALOG, 'INACTIVE', VINACTIVEEDIT);
 2178      
 2179 
 2180      DIALOG.PUTTEXT(P5, 'Note', SROW.NOTE);
 2181 
 2182      FORMGEN.EXECFORMOPER(SFORM, FORMGEN.OP_ROWS2FORM);
 2183      EXCHANGE.OPEREXECFORALL(EXCHANGE.OBJ_RETAILER, EXCHANGE.OP_READ,       VDIALOG);
 2184      EXCHANGE.OPEREXECFORALL(EXCHANGE.OBJ_RETAILER, EXCHANGE.OP_FILLDIALOG, VDIALOG);
 2185 
 2186      VPH := VDH-9; 
 2187      DIALOG.LIST(P8, 'PROGRAMS', 3, 3, VDW-10, VPH, 'List of loyalty programs', PANCHOR=>DIALOG.ANCHOR_ALL); 
 2188      DIALOG.LISTADDFIELD(P8,'PROGRAMS','NAME','C', 60,1);
 2189      DIALOG.LISTADDFIELD(P8,'PROGRAMS','CURR','C',  6,1);
 2190      BROWSER.SETCAPTION(P8,'PROGRAMS','Name~Currency');
 2191 
 2192      VARRPROGRAML := LOYALTYPROGRAM.GETRETAILERPROGRAMLIST(SROW.CODE);
 2193      FOR I IN 1..VARRPROGRAML.COUNT LOOP
 2194        DIALOG.LISTADDRECORD(P8,'PROGRAMS', VARRPROGRAML(I).NAME||'~'||VARRPROGRAML(I).BONUSCURRENCYNO||'~',0,0);
 2195      END LOOP;
 2196 
 2197      
 2198      
 2199      DIALOG.PUTCHAR(P2, 'Location', SROW.LOCATION);
 2200      
 2201    END IF;
 2202 
 2203    DIALOG.HIDDENBOOL(VDIALOG, 'InactiveEdit', VINACTIVEEDIT);  
 2204 
 2205    
 2206    
 2207    
 2208 
 2209    
 2210    
 2211    
 2212    
 2213 
 2214    
 2215    
 2216    
 2217    
 2218 
 2219    
 2220    
 2221    
 2222 
 2223    
 2224    
 2225    
 2226    
 2227 
 2228    DIALOG.BEVEL(P4, 1, 1, VDW-3, 6, DIALOG.BEVEL_FRAME);
 2229 
 2230    DIALOG.INPUTCHAR(P4, 'GUID',        20, 2, 40, 'Global identifier', 40, 'GUID:');
 2231      DIALOG.SETENABLE(P4, 'GUID', FALSE);
 2232    DIALOG.INPUTCHAR(P4, 'CreateClerk', 20, 3, 40, NULL, PCAPTION => 'Created by:');
 2233      DIALOG.SETENABLE(P4, 'CreateClerk', FALSE);
 2234    DIALOG.INPUTCHAR(P4, 'CreateDate',  20, 4, 40, NULL, PCAPTION => 'Creation date:');
 2235      DIALOG.SETENABLE(P4, 'CreateDate', FALSE);
 2236    DIALOG.INPUTCHAR(P4, 'UpdateClerk', 20, 5, 40, NULL, PCAPTION => 'Changed by:');
 2237      DIALOG.SETENABLE(P4, 'UpdateClerk', FALSE);
 2238    DIALOG.INPUTCHAR(P4, 'UpdateDate',  20, 6, 40, NULL, PCAPTION => '   Change date:'   );
 2239      DIALOG.SETENABLE(P4, 'UpdateDate', FALSE);
 2240 
 2241    RETAILEREVENTLOG.MAKEITEM(P4, 'EventLog', 2, 9, VDW-7, 9); 
 2242    
 2243 
 2244    DIALOG.BUTTON (VDIALOG, 'OK'    , VDW/2-1-VBW, VDH-2, VBW, 'Enter', DIALOG.CMOK, 0, 'Save changes', PANCHOR=>DIALOG.ANCHOR_BOTTOM); 
 2245      DIALOG.SETENABLE(VDIALOG, 'OK', PCANEDIT);
 2246    DIALOG.BUTTON (VDIALOG, 'CANCEL', VDW/2+1,     VDH-2, VBW, 'Cancel', DIALOG.CMCANCEL, 0, 'Cancel changes', PANCHOR=>DIALOG.ANCHOR_BOTTOM); 
 2247 
 2248      DIALOG.SETITEMATTRIBUTIES(VDIALOG, SERVICE.IIF(PCANEDIT, 'OK', 'CANCEL'), DIALOG.DEFAULT_ON);
 2249 
 2250    IF (SREGIM = REG_ADD) THEN
 2251      IF CLIENT.GETCLIENTTYPE(SROW.CODE_CLIENT) = CCLIENTCORPORATE THEN
 2252        DIALOG.SETENABLE(VDIALOG, 'ViewCorporate', FALSE);
 2253      ELSE 
 2254        DIALOG.SETENABLE(VDIALOG, 'ViewPerson', FALSE);
 2255      END IF;
 2256      DIALOG.DISABLEMENUCASE(VDIALOG, 'REFTERM');
 2257      DIALOG.DISABLEMENUCASE(VDIALOG, 'ACCLIST');
 2258      DIALOG.DISABLEMENUCASE(VDIALOG, 'CNS'); 
 2259      DIALOG.DISABLEMENUCASE(VDIALOG, 'CustomerList');  
 2260      DIALOG.DISABLEMENUCASE(VDIALOG, 'ChildList');  
 2261      DIALOG.DISABLEMENUCASE(VDIALOG, 'A4MLog');     
 2262      DIALOG.DISABLEMENUCASE(VDIALOG, 'mnStructure');   
 2263      DIALOG.DISABLEMENUCASE(VDIALOG, 'F2SList');   
 2264    ELSE
 2265      REFERENCEFI.SHOWCLIENT(P1, SROW.CODE_CLIENT, CLIENT.GETCLIENTTYPE(SROW.CODE_CLIENT)); 
 2266 
 2267      IF (NOT CHECKRIGHT(RIGHT_VIEW_ACC)) THEN  
 2268        DIALOG.DISABLEMENUCASE(VDIALOG, 'ACCLIST');
 2269      END IF;
 2270 
 2271      IF (NOT SECURITY.CHECKRIGHT(REFERENCETERMINAL.OBJECT_NAME,'|'||TO_CHAR(REFERENCETERMINAL.RIGHT_VIEW)||'|')) THEN 
 2272        DIALOG.DISABLEMENUCASE(VDIALOG, 'REFTERM');
 2273      END IF;
 2274    END IF;
 2275    
 2276    DIALOG.SETDIALOGPRE(VDIALOG,'ReferenceRetailer.DialogEditProc');
 2277    DIALOG.SETDIALOGVALID(VDIALOG,'ReferenceRetailer.DialogEditProc');
 2278    DIALOG.SETDIALOGPOST(VDIALOG, 'ReferenceRetailer.DialogEditProc'); 
 2279 
 2280    DIALOG.GOITEM(VDIALOG, 'Ident');
 2281 
 2282    DIALOG.HIDDENBOOL(VDIALOG, 'CanEdit', PCANEDIT);
 2283 
 2284    RETURN VDIALOG;
 2285  END;
 2286 
 2287  
 2288 PROCEDURE DIALOGEDITPROC (PWHAT IN CHAR, PDIALOG IN NUMBER, PITEM IN CHAR, PCMD IN NUMBER)
 2289   
 2290   IS
 2291     CPROCNAME CONSTANT VARCHAR2(100) := CPACKAGENAME || '.DialogEditProc'; 
 2292     CBRANCH   CONSTANT NUMBER := SEANCE.GETBRANCH();
 2293     VCMD    NUMBER;
 2294     VDIALOG NUMBER;
 2295     VPAGE   NUMBER;  
 2296     VRET    TREFERENCERETAILER % ROWTYPE;
 2297     INFO    APITYPES.ADDRESSINFO;
 2298     
 2299     VERR          NUMBER; 
 2300     THIS          NUMBER; 
 2301     VRES          NUMBER; 
 2302 
 2303     VFICODE         TREFERENCERETAILER.FICODE%TYPE;      
 2304     VCODE           TREFERENCERETAILER.CODE%TYPE;        
 2305     VNEWCODE        TREFERENCERETAILER.CODE%TYPE;        
 2306     VINACTIVEEDIT   BOOLEAN;                             
 2307 
 2308     VLOGPARAMLISTNO NUMBER;                              
 2309 
 2310     VCANEDIT        BOOLEAN;
 2311     VLIMITS         REFERENCELIMIT.TLIMITARRAY;          
 2312     VINTLIMITS      REFERENCELIMIT.TLIMITARRAY;          
 2313     
 2314     
 2315     
 2316 
 2317 
 2318 
 2319 
 2320 
 2321 
 2322 
 2323 
 2324  
 2325   BEGIN
 2326     VCANEDIT := DIALOG.GETBOOL(PDIALOG, 'CanEdit');
 2327 
 2328     IF PWHAT = DIALOG.WT_DIALOGPRE THEN
 2329       SCONTACTSCOUNT := 0;
 2330 
 2331       VFICODE := REFERENCEFI.GETITEMDATA(PDIALOG, 'FIID_EDIT');  
 2332       FILLPROTOTYPEITEM(PDIALOG, 'ProtoType', 0, VFICODE);  
 2333 
 2334       IF (SREGIM = REG_EDIT) THEN  
 2335         
 2336         THIS := NEWOBJECT(SROW.CODE, SERVICE.IIF(VCANEDIT, 'W', 'R'));
 2337         VERR := ERR.GETERRORCODE();
 2338 
 2339         IF( VERR != 0 ) THEN
 2340           IF( VERR = ERR.REFFI_RETAILER_BUSY) THEN  
 2341             IF DIALOG.EXEC(SERVICE.DIALOGCONFIRM('Warning!', 'Retailer '||SROW.CODE||' is being used by another operator~'||OBJECT.CAPTUREDOBJECTINFO(OBJECT_NAME,SROW.CODE)||' RETAILER/CODE: '||SROW.CODE||'~'||'Do you want to use view mode?'||'~', '  Yes  ', '', '  No   ', '' )) = DIALOG.CMOK THEN  
 2342               THIS := NEWOBJECT(SROW.CODE, 'R');
 2343 
 2344               DIALOG.SETENABLE(PDIALOG, 'OK', FALSE);
 2345               DIALOG.SETITEMATTRIBUTIES(VDIALOG, 'CANCEL', DIALOG.DEFAULT_ON);
 2346 
 2347               DIALOG.DISABLEMENUCASE(PDIALOG, 'REFTERM');
 2348 
 2349               DIALOG.PUTBOOL(PDIALOG, 'CanEdit', FALSE);
 2350             END IF;
 2351           
 2352           ELSE
 2353             SERVICE.SAYERR(PDIALOG, 'Warning !');
 2354           
 2355           END IF;
 2356 
 2357           IF( THIS = 0 ) THEN 
 2358             DIALOG.ABORT(PDIALOG);
 2359             RETURN;
 2360           END IF;
 2361         END IF;
 2362         DIALOG.PUTNUMBER(PDIALOG, 'This', THIS);
 2363         
 2364 
 2365         FOR I IN (SELECT * FROM TREFERENCERETAILERCONTACTS WHERE BRANCH = CBRANCH AND RETAILERCODE = SROW.CODE ORDER BY ORDERNO) LOOP 
 2366           SCONTACTSCOUNT := SCONTACTSCOUNT + 1;
 2367           SCONTACTS(SCONTACTSCOUNT) := I;
 2368         END LOOP;
 2369 
 2370         INFO.CITY    := SROW.CITY_CODE    ;
 2371         INFO.COUNTRY := SROW.COUNTRY_CODE ;
 2372         INFO.REGION  := SROW.REGION_CODE  ;
 2373         INFO.ADDRESS := SUBSTR(RTRIM(SROW.ADDRESS), 1, 200); 
 2374         INFO.POSTAL  := SROW.EXTERNAL_ZIPCODE;
 2375         INFO.PHONE   := SUBSTR(RTRIM(SROW.PHONES), 1, 20);  
 2376         INFO.FAX     := RTRIM(SROW.FAX)          ;
 2377         INFO.EMAIL   := RTRIM(SROW.EMAIL)        ;
 2378 
 2379         INFO.STREET    := SROW.STREET  ;
 2380         INFO.HOUSE     := SROW.HOUSE   ;
 2381         INFO.BUILDING  := SROW.BUILDING;
 2382         INFO.FRAME     := SROW.FRAME   ;
 2383         INFO.FLAT      := SROW.FLAT    ;
 2384 
 2385         REFERENCECOUNTRY.SETDATA(PDIALOG,INFO);
 2386 
 2387         
 2388         REFERENCEMCC.SETITEMDATA(PDIALOG,'MCC',SROW.EXTERNAL_SICCODE);
 2389 
 2390         REFERENCEBRANCHPART.SETBPTODIALOG(PDIALOG, SROW.BRANCHPART);
 2391 
 2392         
 2393         DIALOG.PUTBOOL(PDIALOG, 'IsProtoType', SROW.ISPROTOTYPE = ISPROTOTYPE);
 2394         IF SROW.ISPROTOTYPE = ISPROTOTYPE THEN
 2395           DIALOG.SETITEMATTRIBUTIES(PDIALOG, 'ProtoType', DIALOG.SELECTOFF);
 2396         ELSE
 2397           SETPROTOTYPEITEMDATA(PDIALOG, 'ProtoType', SROW.PROTOTYPE);
 2398         END IF;
 2399         
 2400         DIALOG.PUTCHAR(PDIALOG, 'MerchantID', SROW.MERCHANTID);  
 2401 
 2402         
 2403         DIALOG.PUTBOOL(PDIALOG, 'Reimbursement', HTOOLS.I2B(SROW.REIMBURSEMENT));
 2404         
 2405 
 2406         
 2407         
 2408         
 2409         
 2410         
 2411         DIALOG.PUTBOOL(PDIALOG, 'AnyPOSRefund', HTOOLS.I2B(SROW.ANYPOSREFUND));
 2412         IF SROW.PARENTCODE IS NOT NULL THEN
 2413           DIALOG.SETVISIBLE(PDIALOG, 'RefundFromSiblingsPos', TRUE);
 2414           DIALOG.SETENABLED(PDIALOG, 'RefundFromSiblingsPos', SROW.ANYPOSREFUND IN (CALLOWREFUND, CALLOWREFUNDWITHPARENT));
 2415           DIALOG.PUTBOOL(PDIALOG, 'RefundFromSiblingsPos', SROW.ANYPOSREFUND = CALLOWREFUNDWITHPARENT);
 2416         END IF;
 2417         
 2418 
 2419         REFERENCELIMIT.INITLIMITSRETAILER(PDIALOG, SROW.LIMITGRPFO, PRETAILERID => SROW.CODE);  
 2420         REFERENCELIMIT.INITINTLIMITSRETAILER(PDIALOG, SROW.LIMITGRP, PRETAILERID => SROW.CODE);  
 2421         REFERENCECURRENCY.SETDATA(PDIALOG, 'LimitCurrency', SROW.LIMITCURRENCY);                 
 2422 
 2423         
 2424         IF (SROW.OBJECTUID IS NOT NULL) THEN
 2425           DIALOG.PUTCHAR(PDIALOG, 'GUID', OBJECTUID.GETGUIDASSTR(SROW.OBJECTUID));
 2426         END IF;
 2427 
 2428         DIALOG.PUTCHAR(PDIALOG, 'CreateDate',  TO_CHAR(SROW.CREATEDATE, HTOOLS.GETDATETIMEFORMAT()));
 2429         DIALOG.PUTCHAR(PDIALOG, 'CreateClerk', CLERK.GETNAMEBYCODE(SROW.CREATECLERK)||' ('||SROW.CREATECLERK||')' );
 2430 
 2431         DIALOG.PUTCHAR(PDIALOG, 'UpdateDate',  TO_CHAR(SROW.UPDATEDATE, HTOOLS.GETDATETIMEFORMAT()));
 2432         DIALOG.PUTCHAR(PDIALOG, 'UpdateClerk', CLERK.GETNAMEBYCODE(SROW.UPDATECLERK)||' ('||SROW.UPDATECLERK||')' );
 2433 
 2434         RETAILEREVENTLOG.FILLITEM(PDIALOG, 'EventLog', SROW.CODE);
 2435         
 2436       ELSE
 2437 
 2438         INFO.CITY    := REFERENCEFI.SROWRET.CITY_CODE    ;
 2439         INFO.COUNTRY := REFERENCEFI.SROWRET.COUNTRY_CODE ;
 2440         INFO.REGION  := REFERENCEFI.SROWRET.REGION_CODE  ;
 2441         REFERENCECOUNTRY.SETDATA(PDIALOG,INFO);
 2442         REFERENCEBRANCHPART.SETBPTODIALOG(PDIALOG, SEANCE.GETBRANCH);
 2443 
 2444         REFERENCELIMIT.INITLIMITSRETAILER(PDIALOG, NULL, PRETAILERID => NULL);     
 2445         REFERENCELIMIT.INITINTLIMITSRETAILER(PDIALOG, NULL, PRETAILERID => NULL);  
 2446         REFERENCECURRENCY.SETDATA(PDIALOG, 'LimitCurrency', NULL);                 
 2447       END IF;
 2448       REFRESHCONTACTS(PDIALOG); 
 2449 
 2450       FILLCLIENTTYPEITEM(PDIALOG, 'ClientType', PCMD, NVL(CLIENT.GETCLIENTTYPE(SROW.CODE_CLIENT), CCLIENTCORPORATE)); 
 2451 
 2452     ELSIF PWHAT = DIALOG.WT_ITEMPRE THEN
 2453       
 2454       IF PITEM = 'REFTERM' THEN
 2455         
 2456         VPAGE :=  DIALOG.IDBYNAME(PDIALOG, IDPAGEGENERAL);
 2457         
 2458         VDIALOG := REFERENCETERMINAL.DIALOGREFERENCE(SROW.FICODE, SROW.CODE, REFERENCETERMINAL.CDMLIST);  
 2459         DIALOG.EXEC(VDIALOG);
 2460         
 2461         FORMGEN.SETFORMITEMDIALOG(SFORM, 'RET', VPAGE);
 2462         
 2463 
 2464         REFERENCELIMIT.REINITRETAILERLIMITS(SROW.CODE);  
 2465       ELSIF PITEM='ACCLIST' THEN
 2466         SETACCOUNT(VCANEDIT AND CHECKRIGHT(RIGHT_MODIFY_ACC));
 2467 
 2468       ELSIF PITEM='SUBACC' THEN
 2469         DIALOG.EXEC(ADDACCGROUP.SELECTGRPDIALOG(ADDACCGROUP.C_OBJ_RET, VCANEDIT AND CHECKRIGHT(RIGHT_MODIFY_ACC), SROW.CODE));
 2470 
 2471       
 2472       ELSIF PITEM='CNS' THEN
 2473         CNSDIALOGS.CMSLISTBYRETAILER(SROW.CODE);
 2474       
 2475 
 2476       
 2477       ELSIF PITEM='C_ADD' THEN
 2478         IF DIALOG.EXEC(DIALOGCONTACT(REG_ADD)) = DIALOG.CMOK THEN
 2479           REFRESHCONTACTS(PDIALOG);
 2480         END IF;
 2481       ELSIF PITEM='CONTACTS' THEN
 2482         REPOSCONTACTS(PDIALOG);
 2483         IF DIALOG.EXEC(DIALOGCONTACT(REG_EDIT)) = DIALOG.CMOK THEN
 2484           REFRESHCONTACTS(PDIALOG);
 2485         END IF;
 2486       ELSIF PITEM='C_DEL' THEN
 2487         REPOSCONTACTS(PDIALOG);
 2488         IF HTOOLS.ASK('Warning !', 'Do you really want to delete record?') THEN
 2489           SCONTACTSCOUNT := SCONTACTSCOUNT-1;
 2490           FOR I IN SCURCONTACT..SCONTACTSCOUNT LOOP
 2491             SCONTACTS(I):=SCONTACTS(I+1);
 2492           END LOOP;
 2493           REFRESHCONTACTS(PDIALOG);
 2494         END IF;
 2495       
 2496       ELSIF PITEM = 'ISPROTOTYPE' THEN
 2497         IF DIALOG.GETBOOL(PDIALOG, PITEM) THEN
 2498           DIALOG.SETITEMATTRIBUTIES(PDIALOG, 'ProtoType', DIALOG.SELECTOFF);
 2499           SETPROTOTYPEITEMDATA(PDIALOG, 'ProtoType', NULL);
 2500         ELSE
 2501           DIALOG.SETITEMATTRIBUTIES(PDIALOG, 'ProtoType', DIALOG.SELECTON);
 2502         END IF;
 2503       
 2504       
 2505       ELSIF (PITEM = UPPER('CustomerList')) THEN
 2506         RETAILERCUSTOMER.DIALOGCUSTOMERLIST(SROW.CODE, VCANEDIT);
 2507       ELSIF (PITEM = UPPER('FindParent')) THEN
 2508         VFICODE := REFERENCEFI.GETITEMDATA(PDIALOG, 'FIID_EDIT');  
 2509 
 2510         IF (VFICODE IS NULL) THEN  
 2511           DIALOG.GOITEM(PDIALOG, 'FIID_EDIT');
 2512           DIALOG.SETHOTHINT(PDIALOG, 'Value must be selected from list!');
 2513           RETURN;
 2514         END IF;
 2515 
 2516         VCODE := GETCODEBYIDENT(VFICODE, DIALOG.GETCHAR(PDIALOG, 'ParentCode'));  
 2517 
 2518         VNEWCODE := SELECTRETAILER(VFICODE, VCODE);  
 2519 
 2520         DIALOG.PUTCHAR(PDIALOG, 'ParentCode', GETIDENT(VNEWCODE));
 2521 
 2522         
 2523         IF (NOT HTOOLS.EQUAL(VCODE, VNEWCODE)) THEN
 2524           IF (VNEWCODE IS NOT NULL) THEN
 2525             VINACTIVEEDIT := GETINACTIVEEDIT(VNEWCODE);
 2526           ELSE
 2527             VINACTIVEEDIT := TRUE;
 2528           END IF;
 2529 
 2530           DIALOG.PUTBOOL(PDIALOG, 'Inactive', NOT VINACTIVEEDIT);
 2531           DIALOG.SETENABLE(PDIALOG, 'Inactive', VINACTIVEEDIT);
 2532           DIALOG.PUTBOOL(PDIALOG, 'InactiveEdit', VINACTIVEEDIT);
 2533         END IF;
 2534         
 2535         
 2536         IF VCODE IS NOT NULL AND VNEWCODE IS NULL THEN
 2537           DIALOG.PUTBOOL(PDIALOG, 'RefundFromSiblingsPos', FALSE);
 2538           DIALOG.SETVISIBLE(PDIALOG, 'RefundFromSiblingsPos', FALSE);
 2539         ELSIF VCODE IS NULL AND VNEWCODE IS NOT NULL THEN
 2540           DIALOG.SETVISIBLE(PDIALOG, 'RefundFromSiblingsPos', TRUE);
 2541           IF DIALOG.GETBOOL(PDIALOG, 'AnyPOSRefund') THEN
 2542             DIALOG.SETENABLED(PDIALOG, 'RefundFromSiblingsPos', TRUE);
 2543           END IF;
 2544         END IF;
 2545         
 2546       
 2547 
 2548       
 2549       
 2550       
 2551       
 2552       
 2553 
 2554       
 2555       ELSIF (PITEM = 'A4MLOG') THEN
 2556         A4MLOG.SHOWLOGBYKEY(OBJECT.GETTYPE(OBJECT_NAME), SROW.CODE);
 2557       
 2558 
 2559       
 2560       ELSIF PITEM = UPPER('ChildList') THEN
 2561         VCODE := SROW.CODE;  
 2562 
 2563         DIALOG.EXEC(DIALOGCHILDLIST(SROW.CODE));
 2564 
 2565         SROW := READOBJECT(VCODE);  
 2566       
 2567       
 2568       ELSIF PITEM = UPPER('F2SList') THEN
 2569         RETAILERF2S.DIALOGF2S(SROW.CODE, VCANEDIT);
 2570       
 2571       
 2572       ELSIF PITEM = UPPER('CopyAddress') THEN
 2573         VFICODE := REFERENCEFI.GETITEMDATA(PDIALOG, 'FIID_EDIT');
 2574         SROW.CODE_CLIENT := DIALOG.GETNUMBER(PDIALOG, 'Code_Client');
 2575 
 2576         DIALOG.EXEC(DIALOGADDRESSCOPY(PDIALOG, VFICODE, SROW.CODE_CLIENT, DIALOG.GETCURRENTRECORDNUMBER(PDIALOG, 'ClientType', 'Code')));
 2577       
 2578 
 2579       
 2580       ELSIF PITEM = UPPER('mnStructure') THEN
 2581         DIALOG.EXEC(DIALOGTREE(SROW.FICODE, SROW.CODE, SROW.PARENTCODE));
 2582       
 2583       
 2584       ELSIF PITEM = UPPER('AnyPOSRefund') THEN
 2585         IF DIALOG.GETCHAR(PDIALOG, 'ParentCode') IS NOT NULL AND DIALOG.GETBOOL(PDIALOG, 'AnyPOSRefund') THEN
 2586           DIALOG.SETENABLED(PDIALOG, 'RefundFromSiblingsPos', TRUE);
 2587         ELSE
 2588           DIALOG.SETENABLED(PDIALOG, 'RefundFromSiblingsPos', FALSE);
 2589           DIALOG.PUTBOOL(PDIALOG, 'RefundFromSiblingsPos', FALSE);
 2590         END IF;
 2591       
 2592       END IF;
 2593 
 2594     ELSIF PWHAT = DIALOG.WT_NEXTFIELD THEN
 2595       IF PITEM = 'FIID_EDIT' THEN  
 2596         VFICODE := REFERENCEFI.GETITEMDATA(PDIALOG, PITEM);
 2597         DIALOG.PUTCHAR(PDIALOG, 'ParentCode', NULL);
 2598 
 2599         FILLPROTOTYPEITEM(PDIALOG, 'ProtoType', 0, VFICODE);
 2600         SETPROTOTYPEITEMDATA(PDIALOG, 'ProtoType', NULL);
 2601       ELSIF PITEM = 'CLIENTTYPE' THEN 
 2602         REMAKECLIENTDIALOG(PDIALOG, DIALOG.GETCURRENTRECORDNUMBER(PDIALOG, 'ClientType', 'Code'));
 2603       END IF;
 2604 
 2605     ELSIF PWHAT = DIALOG.WT_DIALOGVALID THEN
 2606 
 2607       
 2608       VFICODE := REFERENCEFI.GETITEMDATA(PDIALOG, 'FIID_EDIT');  
 2609 
 2610       IF VFICODE IS NULL THEN
 2611         DIALOG.GOITEM(PDIALOG, 'FIID_EDIT');
 2612         DIALOG.SETHOTHINT(PDIALOG,'Field not filled!');
 2613         SETPROTOTYPEITEMDATA(PDIALOG, 'ProtoType', NULL);
 2614         FILLPROTOTYPEITEM(PDIALOG, 'ProtoType', 0, NULL);
 2615         RETURN;
 2616       END IF;
 2617 
 2618       IF DIALOG.GETCHAR(PDIALOG, 'ProtoType') IS NOT NULL THEN
 2619         IF DIALOG.GETCURRENTRECORDNUMBER(PDIALOG, 'ProtoType', 'FiCode') <> VFICODE THEN  
 2620           SETPROTOTYPEITEMDATA(PDIALOG, 'ProtoType', NULL);
 2621           FILLPROTOTYPEITEM(PDIALOG, 'ProtoType', 0, VFICODE);  
 2622         END IF;
 2623       END IF;
 2624       
 2625 
 2626       IF NOT FORMGEN.VALIDATEFORM(SFORM) THEN
 2627         RETURN;
 2628       END IF;
 2629 
 2630       IF NOT REFERENCEPSGROUP.ISVALID(PDIALOG, REFERENCEPSGROUP.COBJ_RETAILER, HTOOLS.IIF(SREGIM = REG_EDIT,SROW.CODE,NULL)) THEN 
 2631         DIALOG.GOITEM(PDIALOG, PITEM);
 2632         RETURN;
 2633       END IF;
 2634 
 2635       VCMD:=GETCODEBYIDENT(VFICODE, DIALOG.GETCHAR(PDIALOG,'IDENT'));  
 2636       IF (VCMD IS NOT NULL) THEN
 2637         ERR.SETERROR(0,'');
 2638         IF (SREGIM = REG_ADD OR VCMD <> SROW.CODE) THEN 
 2639           DIALOG.SETHOTHINT(PDIALOG,'ERROR: This identifier already in use');
 2640           DIALOG.GOITEM(PDIALOG,'IDENT');
 2641           RETURN;
 2642         END IF;
 2643       END IF;
 2644       
 2645 
 2646       VRET:=SROW;
 2647       IF SREGIM = REG_ADD THEN 
 2648         SROW := NULL;
 2649       END IF;
 2650       
 2651       
 2652 
 2653 
 2654 
 2655 
 2656 
 2657 
 2658       
 2659 
 2660       BEGIN
 2661         FORMGEN.EXECFORMOPER(SFORM,FORMGEN.OP_FORM2ROWS);
 2662         
 2663         IF (TRIM(SROW.NAME) IS NULL) THEN
 2664           DIALOG.SETHOTHINT(PDIALOG,'ERROR: invalid name');
 2665           DIALOG.GOITEM(PDIALOG, 'NAME');
 2666           RETURN;
 2667 
 2668         ELSIF (TRIM(SROW.IDENT) IS NULL) THEN
 2669           DIALOG.SETHOTHINT(PDIALOG,'ERROR: invalid identifier');
 2670           DIALOG.GOITEM(PDIALOG, 'IDENT');
 2671           RETURN;
 2672         END IF;
 2673         
 2674 
 2675         
 2676         VCODE := GETCODEBYEXTERNAL_IDENT(SROW.EXTERNAL_IDENT);
 2677         IF (VCODE IS NOT NULL) THEN
 2678           IF (SREGIM = REG_ADD OR VCODE != SROW.CODE) THEN
 2679             DIALOG.SETHOTHINT(PDIALOG,'ERROR: such external identifier already in use');
 2680             DIALOG.GOITEM(PDIALOG,'EXTERNAL_IDENT');
 2681             RETURN;
 2682           END IF;
 2683         END IF;
 2684         
 2685 
 2686         BEGIN
 2687           REFERENCECOUNTRY.GETDATA(PDIALOG,INFO,
 2688                                    PCONTROLVALUE => TRUE);  
 2689         EXCEPTION
 2690           WHEN OTHERS THEN
 2691             KTOOLS.MESSAGEBOX('Error saving address', 'Error', KTOOLS.AT_EXCEPTION);  
 2692             KTOOLS.SETFOCUS(PDIALOG, 'OK');  
 2693             RETURN;
 2694         END;
 2695         
 2696 
 2697 
 2698 
 2699 
 2700 
 2701 
 2702 
 2703  
 2704 
 2705         
 2706         IF (NOT OBJUSERPROPERTY.VALIDPAGE(PDIALOG, OBJECT_NAME)) THEN
 2707           DIALOG.CANCELCLOSE(PDIALOG);
 2708           RETURN;
 2709         END IF;
 2710         
 2711 
 2712         SROW.CITY_CODE          := INFO.CITY    ;
 2713         SROW.COUNTRY_CODE       := INFO.COUNTRY ;
 2714         SROW.REGION_CODE        := INFO.REGION  ;
 2715         SROW.ADDRESS            := INFO.ADDRESS ;
 2716         SROW.EXTERNAL_ZIPCODE   := INFO.POSTAL  ;
 2717         SROW.PHONES             := INFO.PHONE   ;
 2718         SROW.FAX                := INFO.FAX     ;
 2719         SROW.EMAIL              := INFO.EMAIL   ;
 2720 
 2721         SROW.STREET             := INFO.STREET   ;
 2722         SROW.HOUSE              := INFO.HOUSE    ;
 2723         SROW.BUILDING           := INFO.BUILDING ;
 2724         SROW.FRAME              := INFO.FRAME    ;
 2725         SROW.FLAT               := INFO.FLAT     ;
 2726         
 2727         
 2728         
 2729         SROW.EXTERNAL_SICCODE := REFERENCEMCC.GETITEMDATA(PDIALOG,'MCC');
 2730         
 2731         
 2732         DECLARE
 2733           VERRORCODE NUMBER;
 2734         BEGIN
 2735         
 2736           SROW.BRANCHPART := REFERENCEBRANCHPART.GETBPFROMDIALOG(PDIALOG);
 2737         
 2738         EXCEPTION
 2739           WHEN OTHERS THEN
 2740             ERROR.SAVE('ReferenceRetailer.DialogEditProc');
 2741             VERRORCODE := ERR.GETERRORCODE();
 2742 
 2743             IF VERRORCODE = ERR.REFBPART_BRANCHPART_NOTDEFINED THEN
 2744               ERROR.CLEAR();
 2745               SROW.BRANCHPART := NULL;
 2746 
 2747             ELSIF VERRORCODE = ERR.UE_VALUE_INCORRECT THEN
 2748               ERROR.CLEAR();
 2749               DIALOG.SETHOTHINT(PDIALOG, 'ERROR: invalid branch No!');
 2750               REFERENCEBRANCHPART.GOBPITEM(PDIALOG);
 2751               RETURN;
 2752 
 2753             ELSIF VERRORCODE = ERR.REFBPART_BRANCHPART_NOT_FOUND THEN
 2754               IF HTOOLS.ASKCONFIRM('Warning', 'Branch not found in dictionary!~Save changes?') THEN
 2755                 SROW.BRANCHPART := REFERENCEBRANCHPART.GETBPFROMDIALOG(PDIALOG, PNOEXCEPTION => TRUE);
 2756               ELSE
 2757                 ERROR.CLEAR();
 2758                 DIALOG.SETHOTHINT(PDIALOG, 'Error: branch not found in dictionary');
 2759                 REFERENCEBRANCHPART.GOBPITEM(PDIALOG);
 2760                 RETURN;
 2761               END IF;
 2762             ELSE
 2763               RAISE;
 2764             END IF;
 2765         END;
 2766         
 2767 
 2768         SROW.CODE_CLIENT      := DIALOG.GETNUMBER(PDIALOG,'CODE_CLIENT');
 2769 
 2770         
 2771         SROW.ISPROTOTYPE      := HTOOLS.IIF(DIALOG.GETBOOL(PDIALOG, 'IsProtoType'), ISPROTOTYPE, ISNOTPROTOTYPE);
 2772         IF DIALOG.GETCHAR(PDIALOG, 'ProtoType') IS NOT NULL THEN
 2773           SROW.PROTOTYPE := DIALOG.GETCURRENTRECORDNUMBER(PDIALOG, 'ProtoType', 'Code');
 2774         ELSE
 2775           SROW.PROTOTYPE := NULL;
 2776         END IF;
 2777 
 2778         IF SREGIM = REG_EDIT THEN
 2779           IF VRET.ISPROTOTYPE = ISPROTOTYPE AND VRET.ISPROTOTYPE <> SROW.ISPROTOTYPE THEN
 2780             DELETEPROTOTYPE(SROW.CODE);
 2781           END IF;
 2782 
 2783           
 2784           IF (SROW.OBJECTUID IS NULL) THEN
 2785             SROW.OBJECTUID := INTERNALGETUID(SROW.CODE);
 2786           END IF;
 2787           
 2788 
 2789         END IF;
 2790         
 2791 
 2792         
 2793         IF (DIALOG.GETBOOL(PDIALOG, 'InactiveEdit')) THEN
 2794           SROW.INACTIVE := HTOOLS.IIF(DIALOG.GETBOOL(PDIALOG, 'INACTIVE'), CINACTIVE, CACTIVE);  
 2795         ELSIF (SREGIM = REG_EDIT) THEN
 2796           SROW.INACTIVE := VRET.INACTIVE;
 2797         END IF;
 2798         
 2799 
 2800         
 2801         SROW.PARENTCODE := GETCODEBYIDENT(VFICODE, DIALOG.GETCHAR(PDIALOG, 'ParentCode'));  
 2802 
 2803         IF SROW.PARENTCODE IS NOT NULL THEN  
 2804           SROW.PARENTINACTIVE := GETACTIVE(SROW.PARENTCODE);  
 2805         END IF;
 2806 
 2807         IF (SREGIM = REG_EDIT) THEN
 2808           IF (SROW.PARENTCODE IS NOT NULL AND
 2809               (SROW.CODE = SROW.PARENTCODE OR
 2810                ISCHILDOBJECT(SROW.CODE, SROW.PARENTCODE))) THEN
 2811             DIALOG.SETHOTHINT(PDIALOG, 'ERROR: invalid value');
 2812             DIALOG.GOITEM(PDIALOG, 'ParentCode');
 2813             RETURN;
 2814           END IF;
 2815 
 2816           IF (DIALOG.GETBOOL(PDIALOG, 'InactiveEdit') AND                                             
 2817               GETACTIVE(SROW.CODE) = CACTIVE AND  
 2818               SROW.INACTIVE = CINACTIVE AND
 2819               HAVECHILDOBJECT(SROW.CODE)) THEN
 2820 
 2821               IF (NOT HTOOLS.ASK('Warning !', 'Retailer has child objects '||CHR(10)||'that will be also deactivated.'||CHR(10)||'Do you really want to deactivate it ?')) THEN
 2822                 DIALOG.PUTBOOL(PDIALOG, 'INACTIVE', FALSE);
 2823                 DIALOG.GOITEM(PDIALOG, 'CANCEL');
 2824                 RETURN;
 2825               END IF;
 2826           END IF;
 2827         
 2828         END IF;
 2829 
 2830         
 2831         SROW.MERCHANTID := DIALOG.GETCHAR(PDIALOG, 'MerchantId', PNOTRIM => TRUE); 
 2832         
 2833 
 2834         
 2835         SROW.REIMBURSEMENT := HTOOLS.B2I(DIALOG.GETBOOL(PDIALOG, 'Reimbursement'));
 2836         
 2837 
 2838         
 2839         
 2840         
 2841         
 2842         SROW.ANYPOSREFUND := CASE WHEN DIALOG.GETBOOL(PDIALOG, 'RefundFromSiblingsPos') THEN CALLOWREFUNDWITHPARENT 
 2843                                   WHEN DIALOG.GETBOOL(PDIALOG, 'AnyPOSRefund')          THEN CALLOWREFUND ELSE CFORBIDREFUND END;
 2844 
 2845         
 2846 
 2847 
 2848 
 2849 
 2850 
 2851 
 2852 
 2853 
 2854 
 2855 
 2856 
 2857 
 2858 
 2859 
 2860 
 2861 
 2862 
 2863 
 2864 
 2865 
 2866 
 2867 
 2868 
 2869 
 2870 
 2871 
 2872 
 2873 
 2874 
 2875 
 2876 
 2877 
 2878 
 2879 
 2880 
 2881 
 2882 
 2883 
 2884 
 2885 
 2886 
 2887 
 2888 
 2889 
 2890 
 2891 
 2892 
 2893 
 2894 
 2895 
 2896 
 2897 
 2898 
 2899 
 2900 
 2901 
 2902 
 2903 
 2904 
 2905 
 2906 
 2907 
 2908 
 2909 
 2910 
 2911 
 2912 
 2913 
 2914 
 2915 
 2916 
 2917 
 2918 
 2919 
 2920 
 2921 
 2922 
 2923 
 2924 
 2925 
 2926 
 2927 
 2928 
 2929 
 2930 
 2931 
 2932 
 2933 
 2934  
 2935 
 2936         SROW.NOTE  := DIALOG.GETTEXT(PDIALOG,'Note');
 2937 
 2938         
 2939         
 2940         SROW.LOCATION := DIALOG.GETCHAR(PDIALOG, 'Location');
 2941         
 2942 
 2943         SROW.FICODE  := VFICODE;  
 2944 
 2945         SROW.LIMITGRPFO    := REFERENCELIMIT.GETDIALOGLIMITGRP(PDIALOG);     
 2946         SROW.LIMITGRP      := REFERENCELIMIT.GETDIALOGLIMITGRPINT(PDIALOG);  
 2947         SROW.LIMITCURRENCY := DIALOG.GETNUMBER(PDIALOG, 'LimitCurrency');    
 2948         VLIMITS := REFERENCELIMIT.GETDIALOGLIMITS(PDIALOG);                  
 2949         
 2950         
 2951         VINTLIMITS := REFERENCELIMIT.GETDIALOGLIMITSINT(PDIALOG);
 2952         
 2953 
 2954         SROW.PROFILE := FINRETAILERINSTANCE.GETPAGEPROFILE(SFINPAGE);
 2955 
 2956         
 2957         
 2958         
 2959 
 2960 
 2961 
 2962 
 2963 
 2964 
 2965 
 2966 
 2967 
 2968 
 2969 
 2970 
 2971 
 2972 
 2973 
 2974 
 2975 
 2976 
 2977 
 2978 
 2979 
 2980 
 2981 
 2982 
 2983 
 2984 
 2985 
 2986         SETCURRENTDLGUSERATTRIBUTES(OBJUSERPROPERTY.GETPAGEDATA(PDIALOG, OBJECT_NAME));
 2987         SETCURRENTUSERPROPLIST(GETCURRENTDLGUSERATTRIBUTES);
 2988         SETCURRENTEXTATTRIBUTELIST(RETAILEREXTPSNAME.GETCURRENTEXTATTRIBUTELIST);
 2989         
 2990         
 2991         IF NOT EXCHANGE.OPEREXECFORALL( EXCHANGE.OBJ_RETAILER, EXCHANGE.OP_INIT, PDIALOG, FALSE) THEN
 2992           ERROR.RAISEERROR('Error getting exchange module attributes from dialog');
 2993         END IF;
 2994         
 2995         
 2996         S.SAY(CPROCNAME || ': p1');
 2997         BEGIN 
 2998           SAVEOBJ (CMGUI, SREGIM, TRUE, PDIALOG); 
 2999         
 3000         EXCEPTION
 3001           WHEN EXMOVALIDATION THEN
 3002             S.ERR(CPROCNAME||' (not Exchange.OperExecForAll)'); 
 3003             RETURN;
 3004           WHEN OTHERS THEN
 3005             ERROR.SAVE(CPROCNAME);
 3006             RAISE;
 3007         END;
 3008         
 3009         S.SAY(CPROCNAME || ': p2');
 3010 
 3011         
 3012         IF SREGIM = REG_EDIT THEN
 3013           LOGCHANGES(A4MLOG.ACT_CHANGE, VRET, SROW);
 3014         ELSIF SREGIM = REG_ADD THEN
 3015           LOGCHANGES(A4MLOG.ACT_ADD, PNEWROW => SROW);
 3016         END IF;
 3017         
 3018 
 3019 
 3020 
 3021 
 3022 
 3023 
 3024 
 3025 
 3026 
 3027 
 3028 
 3029 
 3030 
 3031 
 3032 
 3033 
 3034 
 3035 
 3036 
 3037 
 3038 
 3039 
 3040 
 3041 
 3042 
 3043 
 3044 
 3045 
 3046 
 3047         
 3048         
 3049         SAVECONTACTSRETAIL(SROW.CODE);
 3050         S.SAY(CPROCNAME || ': p4');
 3051         
 3052         
 3053         ERR.SETERROR(0, CPACKAGENAME || '.DialogEditProc');
 3054         REFERENCELIMIT.SAVERETAILERLIMITS(SROW.CODE, VLIMITS);
 3055         ERROR.RAISEWHENERR;
 3056         
 3057         
 3058         ERR.SETERROR(0, CPACKAGENAME || '.DialogEditProc');
 3059         REFERENCELIMIT.SAVERETAILERINTLIMITS(SROW.CODE, VINTLIMITS);
 3060         ERROR.RAISEWHENERR;
 3061         
 3062         S.SAY(CPROCNAME || ': p5');
 3063 
 3064         FINRETAILERINSTANCE.SAVEPAGE(SFINPAGE, SROW.CODE);
 3065         S.SAY(CPROCNAME || ': p6');
 3066         REFERENCEACQGROUP.SAVEDIALOGGROUP(SGRPPAGE,REFERENCEACQGROUP.COBJ_RETAILER,SROW.CODE);
 3067         S.SAY(CPROCNAME || ': p7');
 3068         REFERENCEPSGROUP.SAVEDIALOGGROUP(SPSPAGE, REFERENCEPSGROUP.COBJ_RETAILER, SROW.CODE);
 3069         S.SAY(CPROCNAME || ': p8');
 3070         
 3071         
 3072         RETAILEREXTPSNAME.SAVEEXTATTRIBUTELIST(SROW.CODE, GETCURRENTEXTATTRIBUTELIST(), PLOG => TRUE);
 3073         S.SAY(CPROCNAME || ': p9');
 3074         
 3075 
 3076         RETAILERGROUP.SAVEPAGE(PDIALOG, SROW.CODE);      
 3077         S.SAY(CPROCNAME || ': p10');
 3078 
 3079         IF NOT EXCHANGE.OPEREXECFORALL( EXCHANGE.OBJ_RETAILER, EXCHANGE.OP_SAVE, PDIALOG, FALSE) THEN
 3080           ERROR.RAISEERROR('Error saving attributes of exchange modules');
 3081         END IF;
 3082         S.SAY(CPROCNAME || ': p11');
 3083 
 3084         
 3085         RETAILERMCCRANGES.SAVEPAGE(SMCCRANGESPAGE, SROW.CODE);
 3086         S.SAY(CPROCNAME || ': p14');
 3087         
 3088 
 3089         
 3090         
 3091         
 3092 
 3093 
 3094 
 3095 
 3096 
 3097         OBJUSERPROPERTY.SAVERECORD(OBJECT_NAME,
 3098                                    INTERNALGETUID(SROW.CODE),
 3099                                    GETCURRENTUSERPROPLIST,
 3100                                    PCLEARPROPNOTINLIST => TRUE, 
 3101                                    PLOG_TYPE => OBJECT.GETTYPE(OBJECT_NAME),
 3102                                    PLOG_KEY  => SROW.CODE);
 3103         
 3104         
 3105 
 3106         S.SAY(CPROCNAME || ': p12');
 3107         COMMIT;
 3108 
 3109       EXCEPTION
 3110        WHEN OTHERS THEN
 3111         ROLLBACK;  
 3112 
 3113         SROW:=VRET;
 3114 
 3115         
 3116         IF (VLOGPARAMLISTNO IS NOT NULL) THEN
 3117           BEGIN
 3118             A4MLOG.CLEANPLIST(VLOGPARAMLISTNO);
 3119           EXCEPTION
 3120             WHEN OTHERS THEN
 3121               NULL;
 3122           END;
 3123         END IF;
 3124         
 3125 
 3126         RAISE;
 3127       END;
 3128 
 3129     ELSIF PWHAT = DIALOG.WT_DIALOGPOST THEN          
 3130       IF (SREGIM = REG_EDIT) THEN       
 3131         FREEOBJECT(SROW.CODE, DIALOG.GETNUMBER(PDIALOG, 'This'));
 3132       END IF;
 3133     END IF;
 3134 
 3135  EXCEPTION
 3136   WHEN OTHERS THEN
 3137    DIALOG.GOITEM(PDIALOG, PITEM);
 3138    ERROR.SAVE('ReferenceRetailer.DialogEditProc');
 3139    ERROR.SHOWERROR('Error !');
 3140    RAISE;
 3141  END;
 3142 
 3143 
 3144 FUNCTION DIALOGCOPY RETURN NUMBER  
 3145  IS
 3146    CPROCNAME CONSTANT VARCHAR2(100) := CPACKAGENAME || '.DialogCopy'; 
 3147    VDIALOG NUMBER;
 3148  BEGIN
 3149    SREGIM := REG_ADD;
 3150    VDIALOG := DIALOG.NEW('Copy retailer',0,0,70,12, PEXTID => CPROCNAME); 
 3151 
 3152    DIALOG.INPUTCHAR(VDIALOG, 'ParentCode', 27, 3, 20, 'Parent retailer', 20, 'Par. retailer');        
 3153    DIALOG.SETENABLE(VDIALOG, 'ParentCode', FALSE);
 3154 
 3155    DIALOG.BUTTON(VDIALOG, 'FindParent', 49, 3, 3, '...', PHANDLER => 'ReferenceRetailer.DialogCopyProc');   
 3156 
 3157    FORMGEN.SETFORMITEMDIALOG(SFORM, 'RET', VDIALOG);
 3158    FORMGEN.EXECFORMOPER(SFORM, FORMGEN.OP_MKDIALOG);
 3159    FORMGEN.EXECFORMOPER(SFORM, FORMGEN.OP_ROWS2FORM);
 3160 
 3161    DIALOG.BUTTON (VDIALOG, 'OK'    , (70 - (10*2+2))/2, 9, 10, 'Enter', DIALOG.CMOK, 0, 'Save changes');
 3162    DIALOG.BUTTON (VDIALOG, 'CANCEL', (70 - (10*2+2))/2+10+2, 9, 10, 'Cancel', DIALOG.CMCANCEL, 0, 'Cancel changes');
 3163 
 3164    DIALOG.SETDIALOGPRE(VDIALOG,'ReferenceRetailer.DialogCopyProc');
 3165    DIALOG.SETDIALOGVALID(VDIALOG,'ReferenceRetailer.DialogCopyProc');
 3166    DIALOG.SETDIALOGPOST(VDIALOG, 'ReferenceRetailer.DialogCopyProc');
 3167 
 3168    RETURN VDIALOG;
 3169  END;
 3170 
 3171 PROCEDURE DIALOGCOPYPROC(PWHAT IN CHAR, PDIALOG IN NUMBER, PITEM IN VARCHAR, PCMD IN NUMBER)
 3172  IS
 3173    CWHERE   CONSTANT VARCHAR2(100) := CPACKAGENAME || '.DialogCopyProc';
 3174    CBRANCH  CONSTANT NUMBER := SEANCE.GETBRANCH();
 3175    VCMD     NUMBER;
 3176    VRET     TREFERENCERETAILER%ROWTYPE;
 3177    VARRLIST TYPES.ARRNUM;
 3178    
 3179    VRETCODE TREFERENCERETAILER.CODE%TYPE;
 3180 
 3181    
 3182    VUSERPROPLIST   APITYPES.TYPEUSERPROPLIST;  
 3183  BEGIN
 3184    IF PWHAT = DIALOG.WT_DIALOGPRE THEN
 3185      SCONTACTSCOUNT := 0;
 3186      FOR I IN (SELECT * FROM TREFERENCERETAILERCONTACTS WHERE BRANCH = CBRANCH AND RETAILERCODE = SROW.CODE ORDER BY ORDERNO) LOOP
 3187        SCONTACTSCOUNT := SCONTACTSCOUNT + 1;
 3188        SCONTACTS(SCONTACTSCOUNT) := I;
 3189      END LOOP;
 3190 
 3191      DIALOG.PUTCHAR(PDIALOG, 'ParentCode', GETIDENT(SROW.PARENTCODE));  
 3192 
 3193    
 3194    ELSIF (PWHAT = DIALOG.WT_ITEMPRE) THEN
 3195      IF (PITEM = UPPER('FindParent')) THEN
 3196        VRETCODE := GETCODEBYIDENT(SROW.FICODE, DIALOG.GETCHAR(PDIALOG, 'ParentCode'));
 3197 
 3198        VRETCODE := SELECTRETAILER(SROW.FICODE, VRETCODE);
 3199 
 3200        DIALOG.PUTCHAR(PDIALOG, 'ParentCode', GETIDENT(VRETCODE));
 3201      END IF;
 3202    
 3203 
 3204    ELSIF PWHAT = DIALOG.WT_DIALOGVALID THEN
 3205      IF NOT FORMGEN.VALIDATEFORM(SFORM) THEN
 3206        RETURN;
 3207      END IF;
 3208 
 3209      VCMD := GETCODEBYIDENT(SROW.FICODE, DIALOG.GETCHAR(PDIALOG,'IDENT'));
 3210      IF (VCMD IS NOT NULL) THEN
 3211        ERR.SETERROR(0,'');
 3212        DIALOG.SETHOTHINT(PDIALOG,'ERROR: This identifier already in use');
 3213        DIALOG.GOITEM(PDIALOG,'IDENT');
 3214        RETURN;
 3215      END IF;
 3216 
 3217      VRET := SROW;
 3218 
 3219      BEGIN
 3220        FORMGEN.EXECFORMOPER(SFORM,FORMGEN.OP_FORM2ROWS);
 3221 
 3222        
 3223        IF (TRIM(SROW.NAME) IS NULL) THEN
 3224          DIALOG.SETHOTHINT(PDIALOG,'ERROR: invalid name');
 3225          DIALOG.GOITEM(PDIALOG, 'NAME');
 3226          RETURN;
 3227 
 3228        ELSIF (TRIM(SROW.IDENT) IS NULL) THEN
 3229          DIALOG.SETHOTHINT(PDIALOG,'ERROR: invalid identifier');
 3230          DIALOG.GOITEM(PDIALOG, 'IDENT');
 3231          RETURN;
 3232        END IF;
 3233        
 3234 
 3235        
 3236        SROW.PARENTCODE := GETCODEBYIDENT(SROW.FICODE, DIALOG.GETCHAR(PDIALOG, 'ParentCode'));
 3237 
 3238        IF (SROW.PARENTCODE IS NOT NULL) THEN
 3239          SROW.PARENTINACTIVE := GETACTIVE(SROW.PARENTCODE);  
 3240          IF (NVL(SROW.INACTIVE, CACTIVE) = CACTIVE AND
 3241              SROW.PARENTINACTIVE = CINACTIVE) THEN  
 3242            DIALOG.SETHOTHINT(PDIALOG,'ERROR: invalid parent retailer');
 3243            DIALOG.GOITEM(PDIALOG, 'ParentCode');
 3244            RETURN;
 3245          END IF;
 3246        END IF;
 3247        
 3248 
 3249        
 3250        VCMD := GETCODEBYEXTERNAL_IDENT(SROW.EXTERNAL_IDENT);
 3251        IF (VCMD IS NOT NULL) THEN
 3252          DIALOG.SETHOTHINT(PDIALOG, 'ERROR: such external identifier already in use');
 3253          DIALOG.GOITEM(PDIALOG, 'EXTERNAL_IDENT');
 3254          RETURN;
 3255        END IF;
 3256        
 3257 
 3258        SROW.CODE := NULL;
 3259        SROW.ACCOUNTGROUPCODE := NULL;
 3260        SROW.ACC_ACT  := NULL;
 3261        SROW.ACC_PASS := NULL;
 3262        
 3263        SROW.MERCHANTID := NULL;
 3264        
 3265        
 3266        SROW.OBJECTUID := NULL;
 3267        
 3268 
 3269        
 3270        ERR.SETERROR(0, '');
 3271        
 3272 
 3273        SAVEOBJ (CMAPI, REG_ADD, PUSEBLOCK => TRUE); 
 3274 
 3275        
 3276        
 3277 
 3278 
 3279 
 3280 
 3281 
 3282 
 3283 
 3284 
 3285 
 3286 
 3287 
 3288 
 3289 
 3290 
 3291 
 3292 
 3293 
 3294 
 3295 
 3296 
 3297 
 3298 
 3299 
 3300 
 3301 
 3302 
 3303 
 3304 
 3305 
 3306 
 3307        LOGCHANGES(A4MLOG.ACT_ADD, PNEWROW => SROW, PREMARK =>  'Copy retailer '||TO_CHAR(SROW.CODE));
 3308        
 3309        FINRETAILERINSTANCE.COPYFINPROFILE(VRET.CODE, SROW.CODE);
 3310 
 3311        SAVECONTACTSRETAIL(SROW.CODE);
 3312 
 3313        REFERENCEPSGROUP.COPYRETPSGROUP(VRET.CODE, SROW.CODE);
 3314        REFERENCEACQGROUP.COPYRETACQGROUP(VRET.CODE, SROW.CODE);
 3315        RETAILERGROUP.COPYGROUP(VRET.CODE, SROW.CODE);            
 3316 
 3317        LOYALTYPROGRAM.COPYRETAILERPROGRAM(VRET.CODE, SROW.CODE);
 3318 
 3319        VARRLIST(1) := VRET.ACC_ACT;
 3320        VARRLIST(2) := VRET.ACC_PASS;
 3321        ACCGROUPVIEW.COPYRETACCGROUP(VRET.ACCOUNTGROUPCODE, VARRLIST);
 3322 
 3323        UPDATE TREFERENCERETAILER SET
 3324          ACCOUNTGROUPCODE = VRET.ACCOUNTGROUPCODE,
 3325          ACC_ACT  = VARRLIST(1),
 3326          ACC_PASS = VARRLIST(2)
 3327          WHERE BRANCH = CBRANCH
 3328            AND CODE = SROW.CODE;
 3329 
 3330         
 3331         REFERENCELIMIT.COPYRETAILERLIMITS(VRET.CODE, SROW.CODE); 
 3332         REFERENCELIMIT.COPYRETAILERINTLIMITS(VRET.CODE, SROW.CODE);
 3333         RETAILEREXTPSNAME.COPYEXTPSNAME(VRET.CODE, SROW.CODE);
 3334         RETAILERCUSTOMER.COPYLINK(VRET.CODE, SROW.CODE);
 3335         RETAILERMCCRANGES.COPYRANGE(VRET.CODE, SROW.CODE); 
 3336 
 3337         VUSERPROPLIST := OBJUSERPROPERTY.GETRECORD(OBJECT_NAME, GETUID(VRET.CODE));
 3338         
 3339 
 3340 
 3341 
 3342 
 3343 
 3344  
 3345         OBJUSERPROPERTY.SAVERECORD(OBJECT_NAME, INTERNALGETUID(SROW.CODE), VUSERPROPLIST);
 3346         
 3347 
 3348         VRETCODE := SROW.CODE;
 3349 
 3350         EXCHANGE.SETPARAMSFORCOPY(VRET.CODE, SROW.CODE);
 3351         IF NOT EXCHANGE.OPEREXECFORALL( EXCHANGE.OBJ_RETAILER, EXCHANGE.OP_COPY, NULL, FALSE) THEN
 3352           ROLLBACK;
 3353           RETURN;
 3354         END IF;
 3355 
 3356         SROW.CODE := VRETCODE;
 3357 
 3358        COMMIT;
 3359 
 3360      EXCEPTION
 3361       WHEN OTHERS THEN
 3362        SROW := VRET;
 3363         
 3364         
 3365 
 3366 
 3367 
 3368 
 3369 
 3370 
 3371 
 3372 
 3373 
 3374 
 3375 
 3376         
 3377        RAISE;
 3378      END;
 3379 
 3380    END IF;
 3381 
 3382  EXCEPTION
 3383   WHEN OTHERS THEN
 3384    DIALOG.GOITEM(PDIALOG,PITEM);
 3385    ERROR.SAVE('ReferenceRetailer.DialogCopyProc');
 3386    ERROR.SHOWERROR('Error !');
 3387    RAISE;
 3388  END;
 3389 
 3390 
 3391  
 3392 FUNCTION  DIALOGCONTACT(PALTERATIONMODE NUMBER) RETURN NUMBER
 3393  
 3394   IS
 3395     CPROCNAME CONSTANT VARCHAR2(100) := CPACKAGENAME || '.DialogContact'; 
 3396     VDIALOG NUMBER;
 3397     VNAME VARCHAR(200);
 3398   BEGIN
 3399     SREGIMCONTACT := PALTERATIONMODE;
 3400     IF SREGIMCONTACT = REG_EDIT THEN
 3401       VNAME := 'Contact person data';
 3402     ELSE
 3403       VNAME := 'Add contact person';
 3404     END IF;
 3405     VDIALOG:=DIALOG.NEW(VNAME,0,0,60,13, PEXTID => CPROCNAME); 
 3406     FORMGEN.SETFORMITEMDIALOG(SFORMCONTACT,'CONTACT' , VDIALOG);
 3407     FORMGEN.EXECFORMOPER(SFORMCONTACT,FORMGEN.OP_MKDIALOG);
 3408     
 3409     DIALOG.SETCAPTIONPOS(VDIALOG,'Note',DIALOG.ANCHOR_LEFT);
 3410 
 3411     IF SREGIMCONTACT = REG_EDIT THEN
 3412       SROWCONTACT := SCONTACTS(SCURCONTACT);
 3413       
 3414     ELSE                                                          
 3415       SROWCONTACT := NULL;
 3416     END IF;
 3417 
 3418     
 3419     DIALOG.INPUTINTEGER(VDIALOG, 'IdClient', 0, 0, '');
 3420     KTOOLS.VISIBLE(VDIALOG, 'IdClient', FALSE);
 3421 
 3422     DIALOG.BEVEL(VDIALOG, 1, 7, 60-1, 4, DIALOG.BEVEL_FRAME, TRUE);
 3423 
 3424     DIALOG.CHECKBOX(VDIALOG, 'clUseLink', 4, 7, 36, 1, '');
 3425     KTOOLS.LADD(VDIALOG, 'clUseLink', 'Use link to private customer');
 3426     DIALOG.SETITEMMARK(VDIALOG, 'clUseLink', 'ReferenceRetailer.DialogContactProc');
 3427 
 3428     DIALOG.BUTTON(VDIALOG, 'btnFind', 60-11-3, 8, 11, 'Search', 0, 0, 'Specify contact person (customer)', 'ReferenceRetailer.DialogContactProc');
 3429     DIALOG.BUTTON(VDIALOG, 'btnDetail', 60-11-3, 10, 11, 'Details', 0, 0, 'Detailed information about contact person', 'ReferenceRetailer.DialogContactProc');
 3430     
 3431 
 3432     DIALOG.BUTTON (VDIALOG, 'OK'    , 17, 13, 12, 'Save', DIALOG.CMOK,  0, 'Save changes');
 3433     DIALOG.BUTTON (VDIALOG, 'CANCEL', 31, 13, 12, 'Cancel', DIALOG.CMCANCEL, 0, 'Cancel changes');
 3434     DIALOG.SETDIALOGVALID(VDIALOG,'ReferenceRetailer.DialogContactProc');
 3435     DIALOG.SETDIALOGPRE(VDIALOG, 'ReferenceRetailer.DialogContactProc');  
 3436 
 3437     DIALOG.SETDEFAULT(VDIALOG, 'OK');
 3438     RETURN VDIALOG;
 3439   END;
 3440 
 3441  
 3442 PROCEDURE DIALOGCONTACTPROC (PWHAT IN CHAR, PDIALOG IN NUMBER, PITEM IN CHAR, PCMD IN NUMBER)
 3443  
 3444   IS
 3445     CBRANCH CONSTANT NUMBER := SEANCE.GETBRANCH();
 3446     VRET    TREFERENCERETAILERCONTACTS % ROWTYPE;
 3447 
 3448   BEGIN
 3449     
 3450     IF PWHAT = DIALOG.WTDIALOGPRE THEN
 3451 
 3452       DIALOG.PUTNUMBER(PDIALOG, 'IdClient', SROWCONTACT.CLIENTIDLINK);
 3453 
 3454       IF( SROWCONTACT.CLIENTIDLINK IS NULL ) THEN
 3455         KTOOLS.ENABLE(PDIALOG, 'FIO');
 3456         KTOOLS.ENABLE(PDIALOG, 'POST');
 3457         KTOOLS.ENABLE(PDIALOG, 'Note');
 3458 
 3459         IF SREGIMCONTACT = REG_EDIT THEN
 3460           FORMGEN.EXECFORMOPER(SFORMCONTACT,FORMGEN.OP_ROWS2FORM);
 3461         END IF;
 3462 
 3463         DIALOG.PUTCHAR(PDIALOG, 'clUseLink', ' ');
 3464         KTOOLS.DISABLE(PDIALOG, 'btnFind');
 3465         KTOOLS.DISABLE(PDIALOG, 'btnDetail');
 3466 
 3467       ELSE
 3468 
 3469         DIALOG.PUTCHAR(PDIALOG, 'clUseLink', '1');
 3470         KTOOLS.DISABLE(PDIALOG, 'FIO');
 3471         KTOOLS.DISABLE(PDIALOG, 'POST');
 3472         KTOOLS.DISABLE(PDIALOG, 'Note');
 3473         KTOOLS.ENABLE(PDIALOG, 'btnFind');
 3474         KTOOLS.ENABLE(PDIALOG, 'btnDetail');
 3475         DECLARE
 3476           VROW APITYPES.TYPEPERSONERECORD;
 3477         BEGIN
 3478           VROW := CLIENT.GETPERSONERECORD(SROWCONTACT.CLIENTIDLINK);
 3479           DIALOG.PUTCHAR(PDIALOG, 'FIO', VROW.FIO);
 3480           DIALOG.PUTCHAR(PDIALOG, 'POST', NVL(VROW.JOBTITLE,' '));
 3481           DIALOG.PUTCHAR(PDIALOG, 'Note', NULL);
 3482         END;
 3483         KTOOLS.SETFOCUS(PDIALOG, 'btnDetail');
 3484       END IF;
 3485 
 3486 
 3487     ELSIF( PWHAT = DIALOG.WTITEMMARK ) THEN
 3488       DECLARE VMARK VARCHAR(1); BEGIN
 3489         VMARK := KTOOLS.TRIM(NVL(DIALOG.GETCHAR(PDIALOG, 'clUseLink'), ' '));
 3490         IF( VMARK IS NULL ) THEN
 3491           KTOOLS.ENABLE(PDIALOG, 'FIO');
 3492           KTOOLS.ENABLE(PDIALOG, 'POST');
 3493           KTOOLS.ENABLE(PDIALOG, 'Note');
 3494           KTOOLS.DISABLE(PDIALOG, 'btnFind');
 3495           KTOOLS.DISABLE(PDIALOG, 'btnDetail');
 3496         ELSE
 3497           KTOOLS.DISABLE(PDIALOG, 'FIO');
 3498           KTOOLS.DISABLE(PDIALOG, 'POST');
 3499           KTOOLS.DISABLE(PDIALOG, 'Note');
 3500           KTOOLS.ENABLE(PDIALOG, 'btnFind');
 3501           KTOOLS.ENABLE(PDIALOG, 'btnDetail');
 3502         END IF;
 3503       END;
 3504 
 3505     ELSIF( PWHAT = DIALOG.WTITEMPRE ) THEN
 3506       IF( PITEM = UPPER('btnFind') ) THEN
 3507         DECLARE VDIALOG NUMBER; VID NUMBER; VROW APITYPES.TYPEPERSONERECORD; BEGIN
 3508           VDIALOG := FINDER.MAINDIALOG(FINDER.OT_PERSONE);
 3509           IF( DIALOG.EXECDIALOG(VDIALOG) = DIALOG.CMOK ) THEN
 3510             VID := FINDER.GETFINDERRESULT(VDIALOG).IDCLIENT;
 3511             DIALOG.PUTNUMBER(PDIALOG, 'IdClient', VID);
 3512             VROW := CLIENT.GETPERSONERECORD(VID);
 3513             DIALOG.PUTCHAR(PDIALOG, 'FIO', VROW.FIO);
 3514             DIALOG.PUTCHAR(PDIALOG, 'POST', NVL(VROW.JOBTITLE,' '));
 3515             DIALOG.PUTCHAR(PDIALOG, 'Note', NULL);
 3516           END IF;
 3517           DIALOG.DESTROY(VDIALOG);
 3518         END;
 3519 
 3520       ELSIF( PITEM = UPPER('btnDetail') ) THEN
 3521         DECLARE VID NUMBER; BEGIN
 3522           VID := DIALOG.GETNUMBER(PDIALOG, 'IdClient');
 3523           IF( VID IS NULL ) THEN
 3524             KTOOLS.MESSAGEBOX('Specify customer', 'Warning!');
 3525             KTOOLS.SETFOCUS(PDIALOG, 'btnFind');
 3526           ELSE
 3527             DIALOG.EXEC(CLIENT.EDITCLIENT(VID));
 3528 
 3529             DECLARE VROW APITYPES.TYPEPERSONERECORD; BEGIN
 3530               VROW := CLIENT.GETPERSONERECORD(VID);
 3531               DIALOG.PUTCHAR(PDIALOG, 'FIO', VROW.FIO);
 3532               DIALOG.PUTCHAR(PDIALOG, 'POST', NVL(VROW.JOBTITLE,' '));
 3533               DIALOG.PUTCHAR(PDIALOG, 'Note', NULL);
 3534             END;
 3535 
 3536           END IF;
 3537         END;
 3538       END IF;
 3539     
 3540     ELSIF PWHAT=DIALOG.WT_DIALOGVALID THEN
 3541       
 3542       DECLARE VMARK VARCHAR(1); BEGIN
 3543         VMARK := KTOOLS.TRIM(NVL(DIALOG.GETCHAR(PDIALOG, 'clUseLink'), ' '));
 3544         IF( VMARK IS NULL ) THEN
 3545           SROWCONTACT.CLIENTIDLINK := NULL;
 3546         ELSE
 3547           SROWCONTACT.CLIENTIDLINK := DIALOG.GETNUMBER(PDIALOG, 'IdClient');
 3548         END IF;
 3549       END;
 3550       
 3551       IF SROWCONTACT.CLIENTIDLINK IS NULL THEN
 3552         IF NOT FORMGEN.VALIDATEFORM(SFORMCONTACT) THEN
 3553           RETURN;
 3554         END IF;
 3555       END IF;
 3556 
 3557      BEGIN
 3558        VRET:=SROWCONTACT;
 3559        IF SREGIMCONTACT = REG_ADD THEN
 3560          SROWCONTACT:=NULL;
 3561        END IF;
 3562 
 3563        FORMGEN.EXECFORMOPER(SFORMCONTACT,FORMGEN.OP_FORM2ROWS);
 3564 
 3565        SROWCONTACT.CLIENTIDLINK := VRET.CLIENTIDLINK;                     
 3566        SROWCONTACT.POST := NVL(SROWCONTACT.POST, ' ');                    
 3567 
 3568        IF SREGIMCONTACT = REG_ADD THEN
 3569          SROWCONTACT.BRANCH := CBRANCH;
 3570          IF SREGIM <> REG_ADD THEN
 3571            SROWCONTACT.RETAILERCODE := SROW.CODE;
 3572          END IF;
 3573          SCONTACTSCOUNT:=SCONTACTSCOUNT+1;
 3574          SCONTACTS(SCONTACTSCOUNT):=SROWCONTACT;
 3575        ELSE
 3576          SCONTACTS(SCURCONTACT):=SROWCONTACT;
 3577        END IF;
 3578        
 3579        
 3580 
 3581      EXCEPTION
 3582       WHEN OTHERS THEN
 3583        SROWCONTACT:=VRET;
 3584        RAISE;
 3585      END;
 3586 
 3587     END IF;
 3588   END;
 3589 
 3590 
 3591 PROCEDURE FILLPOSTLIST(PDIALOG IN NUMBER, PITEM IN VARCHAR)
 3592  IS
 3593    VBRANCH NUMBER;  
 3594  BEGIN
 3595    VBRANCH := SEANCE.GETBRANCH();
 3596 
 3597    DIALOG.LISTADDFIELD  (PDIALOG, PITEM,'Post','C',30,1);
 3598 
 3599    FOR I IN (SELECT DISTINCT(POST) POST FROM TREFERENCERETAILERCONTACTS WHERE BRANCH = VBRANCH) LOOP
 3600      DIALOG.LISTADDRECORD (PDIALOG, PITEM,I.POST||'~',0,0);
 3601    END LOOP;
 3602  END;
 3603 
 3604 
 3605 
 3606  
 3607 PROCEDURE REFRESHCONTACTS(PDIALOG NUMBER)
 3608  
 3609   IS
 3610   BEGIN
 3611     DIALOG.LISTCLEAR(PDIALOG,'CONTACTS');
 3612     FOR I IN 1..SCONTACTSCOUNT LOOP
 3613       DIALOG.LISTADDRECORD(PDIALOG,'CONTACTS',SCONTACTS(I).ORDERNO||'~'||SCONTACTS(I).FIO||'~'||SCONTACTS(I).POST||'~',0,0); 
 3614     END LOOP;
 3615     DIALOG.SETENABLE(PDIALOG,'C_DEL', SCONTACTSCOUNT <> 0);
 3616   END;
 3617 
 3618 
 3619  
 3620 PROCEDURE REPOSCONTACTS(PDIALOG NUMBER)
 3621  
 3622   IS
 3623   BEGIN
 3624     SCURCONTACT := DIALOG.GETLISTCURRENTRECORDNUMBER(PDIALOG,'CONTACTS');
 3625   END;
 3626 
 3627 
 3628 
 3629 
 3630  
 3631 FUNCTION  DELOBJECT  RETURN BOOLEAN 
 3632  
 3633  IS
 3634    CWHERE CONSTANT VARCHAR2(100) := CPACKAGENAME || '.DelObject';
 3635    VBRANCH         NUMBER;  
 3636    VCOUNT          NUMBER;
 3637    VTHIS           INTEGER; 
 3638    VRET            NUMBER;  
 3639    VLOGPARAMLISTNO NUMBER;  
 3640    
 3641  BEGIN
 3642    VBRANCH := SEANCE.GETBRANCH();  
 3643 
 3644    SAVEPOINT POINT_DELOBJECT;
 3645 
 3646    IF NOT HTOOLS.ASKCONFIRM('Warning !', 'Do you really want to delete retailer '||SROW.IDENT||' ?', '   Yes  ', '', '  No    ', '') THEN
 3647      RETURN FALSE;
 3648    END IF;
 3649 
 3650    
 3651    IF HAVECHILDOBJECT(SROW.CODE) THEN
 3652      HTOOLS.MESSAGE('Warning !', 'Deletion interrupted.~Retailer is parent.');
 3653      RETURN FALSE;
 3654    END IF;
 3655    
 3656 
 3657    
 3658    S.SAY(CWHERE || ': IsPrototype='||SROW.ISPROTOTYPE);
 3659    IF SROW.ISPROTOTYPE=ISPROTOTYPE THEN
 3660      IF NOT HTOOLS.ASKCONFIRM('Warning !', 'Retailer is prototype. ~Continue deletion?', '   Yes  ', '', '  No    ', '') THEN 
 3661        RETURN FALSE;
 3662      END IF;
 3663    END IF;
 3664    
 3665 
 3666    IF NOT REFERENCEFI.CAN_CDELETE THEN
 3667      SELECT COUNT(*)
 3668       INTO VCOUNT
 3669       FROM TREFERENCETERMINAL
 3670       WHERE BRANCH = VBRANCH
 3671         AND RETAILERCODE = SROW.CODE;
 3672 
 3673      IF VCOUNT > 0 THEN
 3674        HTOOLS.MESSAGE('Warning !', 'Deletion interrupted.~Retailer has terminals.');
 3675        RETURN FALSE;
 3676      END IF;
 3677    END IF;
 3678 
 3679    
 3680    VTHIS := NEWOBJECT(SROW.CODE, 'W');
 3681    IF VTHIS = BAD_THIS THEN
 3682      IF ERR.GETERRORCODE = ERR.REFFI_RETAILER_BUSY THEN  
 3683        HTOOLS.MESSAGE ('Warning!', 'Deletion interrupted. ~Retailer '||SROW.CODE||' is being used by another operator~'||OBJECT.CAPTUREDOBJECTINFO(OBJECT_NAME,SROW.CODE)||' RETAILER/CODE: '||SROW.CODE||'~'); 
 3684        RETURN FALSE;
 3685      
 3686      ELSE
 3687        HTOOLS.SAYERROR('Warning!');
 3688        RETURN FALSE;
 3689      END IF;
 3690      
 3691    ELSE
 3692      FREEOBJECT(SROW.CODE, VTHIS);
 3693    END IF;
 3694    
 3695 
 3696    
 3697    REFERENCETERMINAL.DELETEFORRETAILER(SROW.CODE);
 3698    
 3699 
 3700 
 3701    IF SROW.ACCOUNTGROUPCODE IS NOT NULL THEN
 3702      VRET := ACCGROUP.DELETEACCGROUP(SROW.ACCOUNTGROUPCODE);
 3703    END IF;
 3704 
 3705    IF SROW.ACC_ACT IS NOT NULL THEN
 3706      VRET := ACCGROUP.DELETEACCGROUP(SROW.ACC_ACT);
 3707    END IF;
 3708 
 3709    IF SROW.ACC_PASS IS NOT NULL THEN
 3710      VRET := ACCGROUP.DELETEACCGROUP(SROW.ACC_PASS);
 3711    END IF;
 3712    
 3713 
 3714    ADDACCGROUP.DELETERETAILERACCGROUPS(SROW.CODE); 
 3715 
 3716    RETAILERF2S.CLEARLINKS(SROW.CODE); 
 3717 
 3718    DELETEPROTOTYPE(SROW.CODE); 
 3719    
 3720 
 3721 
 3722 
 3723 
 3724 
 3725 
 3726 
 3727 
 3728 
 3729 
 3730 
 3731 
 3732 
 3733 
 3734 
 3735 
 3736 
 3737 
 3738 
 3739 
 3740 
 3741 
 3742 
 3743 
 3744 
 3745 
 3746 
 3747 
 3748    DELETERETAILER(SROW.CODE);
 3749 
 3750    
 3751    COMMIT;
 3752    RETURN TRUE;
 3753 
 3754  EXCEPTION
 3755   WHEN OTHERS THEN
 3756 
 3757    ROLLBACK TO POINT_DELOBJECT;
 3758    S.ERR('ReferenceRetailer.DelObject');
 3759    ERR.SETERROR(SQLCODE,'ReferenceRetailer.DelObject');
 3760 
 3761    
 3762    IF (VLOGPARAMLISTNO IS NOT NULL) THEN
 3763      BEGIN
 3764        A4MLOG.CLEANPLIST(VLOGPARAMLISTNO);
 3765      EXCEPTION
 3766        WHEN OTHERS THEN
 3767          NULL;
 3768      END;
 3769    END IF;
 3770    
 3771 
 3772    HTOOLS.SETHOTERROR;
 3773    RETURN FALSE;
 3774  END;
 3775 
 3776 PROCEDURE DELETEACC( PMAIN BOOLEAN) IS
 3777   CODE NUMBER;
 3778  BEGIN
 3779    IF PMAIN THEN
 3780      CODE:=ACCGROUP.DELETEACCGROUP(SROW.ACCOUNTGROUPCODE);
 3781      SROW.ACCOUNTGROUPCODE  := NULL;
 3782    END IF;
 3783    CODE:=ACCGROUP.DELETEACCGROUP(SROW.ACC_ACT);
 3784    CODE:=ACCGROUP.DELETEACCGROUP(SROW.ACC_PASS);
 3785    SROW.ACC_ACT  := NULL;
 3786    SROW.ACC_PASS := NULL;
 3787  END;
 3788 
 3789 
 3790 
 3791  
 3792 FUNCTION  GETNAME
 3793  
 3794   (
 3795     PCODE IN NUMBER
 3796   )
 3797   RETURN VARCHAR
 3798  IS
 3799    CBRANCH CONSTANT NUMBER := SEANCE.GETBRANCH();
 3800    VNAME   TREFERENCERETAILER.NAME%TYPE; 
 3801  BEGIN
 3802    SELECT NAME INTO VNAME
 3803    FROM TREFERENCERETAILER
 3804    WHERE BRANCH = CBRANCH AND
 3805            CODE = PCODE;
 3806    RETURN VNAME;
 3807  EXCEPTION
 3808   WHEN NO_DATA_FOUND THEN
 3809    ERR.SETERROR(ERR.REFFI_UNDEFINED_RETAILER,'ReferenceRetailer.GetName');
 3810    RETURN NULL;
 3811  END;
 3812 
 3813  
 3814 FUNCTION  GETIDENT
 3815  
 3816   (
 3817     PCODE IN NUMBER
 3818   )
 3819   RETURN VARCHAR
 3820  IS
 3821    CBRANCH CONSTANT NUMBER := SEANCE.GETBRANCH();
 3822    VIDENT  VARCHAR(20);
 3823  BEGIN
 3824    SELECT IDENT INTO VIDENT
 3825    FROM TREFERENCERETAILER
 3826    WHERE BRANCH = CBRANCH AND
 3827            CODE = PCODE;
 3828    RETURN VIDENT;
 3829  EXCEPTION
 3830   WHEN NO_DATA_FOUND THEN
 3831    ERR.SETERROR(ERR.REFFI_UNDEFINED_RETAILER,'ReferenceRetailer.GetIdent');
 3832    RETURN NULL;
 3833  END;
 3834 
 3835  
 3836 FUNCTION  GETCODEBYIDENT
 3837  
 3838   (
 3839     PFICODE   IN NUMBER,
 3840     PRETAILER IN VARCHAR
 3841   )
 3842   RETURN NUMBER
 3843  IS
 3844    CWHERE  CONSTANT VARCHAR2(100) := CPACKAGENAME || '.GetCodeByIdent';
 3845    CBRANCH CONSTANT NUMBER := SEANCE.GETBRANCH();
 3846    VCODE NUMBER;
 3847  BEGIN
 3848    S.SAY(CWHERE || ': start [FICode='||PFICODE||', RetialerId='||PRETAILER||']');
 3849     
 3850    IF PFICODE IS NULL THEN
 3851      ERR.SETERROR(ERR.REFFI_UNDEFINED_RETAILER,'ReferenceRetailer.GetCodeByIdent');
 3852      RETURN NULL;
 3853    ELSE
 3854      SELECT CODE INTO VCODE
 3855      FROM TREFERENCERETAILER
 3856      WHERE BRANCH = CBRANCH AND
 3857            FICODE = PFICODE AND
 3858              IDENT = PRETAILER;
 3859    END IF;
 3860    S.SAY(CWHERE || ': return '||VCODE);
 3861    RETURN VCODE;
 3862  EXCEPTION
 3863   WHEN NO_DATA_FOUND THEN
 3864    ERR.SETERROR(ERR.REFFI_UNDEFINED_RETAILER,'ReferenceRetailer.GetCodeByIdent');
 3865    RETURN NULL;
 3866  END;
 3867 
 3868  
 3869 FUNCTION  GETBRANCHPART     (PCODE IN NUMBER) RETURN NUMBER
 3870  
 3871  IS
 3872    CBRANCH CONSTANT NUMBER := SEANCE.GETBRANCH();
 3873    VBP TREFERENCERETAILER.BRANCHPART%TYPE;
 3874  BEGIN
 3875    ERR.SETERROR(0,'ReferenceRetailer.GetBranchPart');
 3876 
 3877    SELECT BRANCHPART
 3878    INTO VBP
 3879    FROM TREFERENCERETAILER
 3880    WHERE BRANCH = CBRANCH AND
 3881            CODE = PCODE;
 3882 
 3883    RETURN VBP;
 3884  EXCEPTION
 3885   WHEN NO_DATA_FOUND THEN
 3886    ERR.SETERROR(ERR.REFFI_UNDEFINED_RETAILER,'ReferenceRetailer.GetBranchPart');
 3887    RETURN NULL;
 3888  END;
 3889 
 3890 
 3891 FUNCTION GETPARENTCODE (PCODE IN NUMBER) RETURN NUMBER
 3892   IS
 3893     CBRANCH CONSTANT NUMBER := SEANCE.GETBRANCH();
 3894     VPARENTCODE NUMBER;
 3895   BEGIN
 3896     SELECT PARENTCODE INTO VPARENTCODE
 3897       FROM TREFERENCERETAILER
 3898       WHERE BRANCH = CBRANCH
 3899         AND CODE   = PCODE;
 3900     RETURN VPARENTCODE;
 3901   EXCEPTION
 3902     WHEN NO_DATA_FOUND THEN
 3903       ERR.SETERROR(ERR.REFFI_UNDEFINED_RETAILER, 'ReferenceRetailer.GetParentCode');
 3904       RETURN NULL;
 3905   END;
 3906 
 3907 
 3908  
 3909 FUNCTION  FILLLIST
 3910  
 3911   (                                       
 3912     PDIALOG   IN NUMBER,                  
 3913     PITEMNAME IN VARCHAR,                 
 3914     PCMD      IN NUMBER,
 3915     PFICODE   IN NUMBER
 3916   )
 3917   RETURN NUMBER
 3918  IS
 3919    CBRANCH CONSTANT NUMBER := SEANCE.GETBRANCH();
 3920    VCNT NUMBER:=0;
 3921  BEGIN
 3922    DIALOG.LISTCLEAR(PDIALOG,PITEMNAME);
 3923    FOR N IN
 3924     (SELECT CODE||'~'||IDENT||'~'||NAME||'~' AS TEXT
 3925      FROM TREFERENCERETAILER
 3926      WHERE BRANCH = CBRANCH AND
 3927            FICODE = NVL(PFICODE,FICODE) AND
 3928             IDENT <> ' ')
 3929    LOOP
 3930      VCNT:=VCNT+1;
 3931      DIALOG.LISTADDRECORD(PDIALOG, PITEMNAME, N.TEXT , PCMD, 0);
 3932    END LOOP;
 3933    RETURN VCNT;
 3934  EXCEPTION
 3935   WHEN OTHERS THEN
 3936    ERR.SETERROR(SQLCODE,'ReferenceRetailer.FillList');
 3937    RETURN -1;
 3938  END;
 3939 
 3940  
 3941 PROCEDURE INITSTRUCT
 3942  
 3943  IS
 3944    VSTR NUMBER;
 3945    VGRP NUMBER;
 3946    N    NUMBER;
 3947    VSTRNAME VARCHAR(20) := 'tReferenceRetailer';
 3948  BEGIN
 3949 
 3950    IF FORMGEN.STRUCTBYNAME(VSTRNAME) != 0 THEN
 3951      RETURN;
 3952    END IF;
 3953 
 3954    VSTR := FORMGEN.CREATESTRUCT(VSTRNAME,2,'ReferenceRetailer.sRow', NULL, NULL);  
 3955 
 3956    N:=FORMGEN.ADDFIELD(VSTR,'Branch'            , 'N', FALSE);
 3957    N:=FORMGEN.ADDFIELD(VSTR,'Code'              , 'N', FALSE);
 3958    N:=FORMGEN.ADDFIELD(VSTR,'FiCode'            , 'N', FALSE);
 3959    N:=FORMGEN.ADDFIELD(VSTR,'Ident'             , 'S', FALSE,   20, 'ID', 'Retailer ID');  
 3960    N:=FORMGEN.ADDFIELD(VSTR,'Name'              , 'S', FALSE,   50, 'Name', 'Retailer name ', PMAXLEN=>200); 
 3961    N:=FORMGEN.ADDFIELD(VSTR,'AccountGroupCode'  , 'N', TRUE);
 3962    N:=FORMGEN.ADDFIELD(VSTR,'External_Name'     , 'S', TRUE,    50, 'Name (Latin)','Used as "Merchant Name" in payment systems', PMAXLEN=>200); 
 3963    N:=FORMGEN.ADDFIELD(VSTR,'External_City'     , 'S', TRUE,    13, 'City','City');  
 3964    N:=FORMGEN.ADDFIELD(VSTR,'External_Country'  , 'S', TRUE,    10);                  
 3965    N:=FORMGEN.ADDFIELD(VSTR,'External_ZIPcode'  , 'S', TRUE,    5, 'ZIP','ZIP code');
 3966    N:=FORMGEN.ADDFIELD(VSTR,'External_SICcode'  , 'S', TRUE,    4, 'MCC','Mechant Category Code');
 3967    FORMGEN.SETFIELDCLICKPROC(N,'ReferenceMCC.ItemClickProc');
 3968    N:=FORMGEN.ADDFIELD(VSTR,'External_CPScode'  , 'C', TRUE,    1, '');               
 3969    N:=FORMGEN.ADDFIELD(VSTR,'PANEntryType'      , 'C', TRUE,    2, '');               
 3970    N:=FORMGEN.ADDFIELD(VSTR,'HolderAuthType'    , 'C', TRUE,    1, '');               
 3971 
 3972    N:=FORMGEN.ADDFIELD(VSTR,'BankName'          , 'S', TRUE,  180, 'Bank');              
 3973    N:=FORMGEN.ADDFIELD(VSTR,'BankAccount'       , 'S', TRUE,   20, 'Corr. acct');         
 3974    N:=FORMGEN.ADDFIELD(VSTR,'BIC'               , 'S', TRUE,   20, 'BIC');               
 3975    N:=FORMGEN.ADDFIELD(VSTR,'ExternalAccount'   , 'S', TRUE,   20, 'Settl. Acct');      
 3976    N:=FORMGEN.ADDFIELD(VSTR,'INN'               , 'S', TRUE,   20, 'TPN');               
 3977 
 3978    N:=FORMGEN.ADDFIELD(VSTR,'Country'           , 'S', TRUE,   40, 'Country');               
 3979    N:=FORMGEN.ADDFIELD(VSTR,'City'              , 'S', TRUE,   40, 'City');               
 3980    N:=FORMGEN.ADDFIELD(VSTR,'Address'           , 'S', TRUE,  255, 'Address');
 3981    N:=FORMGEN.ADDFIELD(VSTR,'Phones'            , 'S', TRUE,  255, 'Phones');
 3982    N:=FORMGEN.ADDFIELD(VSTR,'EMail'             , 'S', TRUE,   40, 'E-Mail');
 3983    N:=FORMGEN.ADDFIELD(VSTR,'BossFIO'           , 'S', TRUE,  250, 'CEO full name');  
 3984    N:=FORMGEN.ADDFIELD(VSTR,'ServicePersoneFIO' , 'S', TRUE,  250, 'Contact full name');   
 3985 
 3986    N:=FORMGEN.ADDFIELD(VSTR,'Country_Code'      , 'N', TRUE,    3, 'Country', 'Country code');               
 3987    FORMGEN.SETFIELDCLICKPROC(N,'!ReferenceCountry.ItemClick(:DIALOG,:ITEM,'||REFERENCECOUNTRY.SM_CODE||')');
 3988 
 3989    N:=FORMGEN.ADDFIELD(VSTR,'HaveTransit'       , 'N', TRUE);               
 3990    N:=FORMGEN.ADDFIELD(VSTR,'Acc_Act'           , 'N', TRUE);               
 3991    N:=FORMGEN.ADDFIELD(VSTR,'Acc_Pass'          , 'N', TRUE);               
 3992 
 3993    N:=FORMGEN.ADDFIELD(VSTR,'PostalCode'        , 'S', TRUE,   30, 'Postal','Postal code');               
 3994 
 3995    N:=FORMGEN.ADDFIELD(VSTR,'Region_Code'       , 'S', TRUE,   20, 'Region_Code','');
 3996    N:=FORMGEN.ADDFIELD(VSTR,'City_Code'         , 'S', TRUE,   20, 'City_Code','');
 3997    N:=FORMGEN.ADDFIELD(VSTR,'Fax'               , 'S', TRUE,   20, 'Fax','');
 3998 
 3999    N:=FORMGEN.ADDFIELD(VSTR,'Code_Client'       , 'N', TRUE);
 4000 
 4001    N:=FORMGEN.ADDFIELD(VSTR,'CreateDate'        , 'D', TRUE);
 4002    N:=FORMGEN.ADDFIELD(VSTR,'UpdateDate'        , 'D', TRUE);
 4003    N:=FORMGEN.ADDFIELD(VSTR,'CreateClerk'       , 'N', TRUE);
 4004    N:=FORMGEN.ADDFIELD(VSTR,'UpdateClerk'       , 'N', TRUE);
 4005 
 4006    N:=FORMGEN.ADDFIELD(VSTR,'Note'              , 'S', TRUE,1000);
 4007 
 4008    N:=FORMGEN.ADDFIELD(VSTR,'Profile'           , 'N', TRUE);
 4009    N:=FORMGEN.ADDFIELD(VSTR,'BranchPart'        , 'N', TRUE, 5, 'Branch');
 4010 
 4011    N:=FORMGEN.ADDFIELD(VSTR,'Street'            , 'S', TRUE,20);
 4012    N:=FORMGEN.ADDFIELD(VSTR,'House'             , 'S', TRUE,20);
 4013    N:=FORMGEN.ADDFIELD(VSTR,'Building'          , 'S', TRUE,20);
 4014    N:=FORMGEN.ADDFIELD(VSTR,'Frame'             , 'S', TRUE,20);
 4015    N:=FORMGEN.ADDFIELD(VSTR,'Flat'              , 'S', TRUE,20);
 4016 
 4017    N:=FORMGEN.ADDFIELD(VSTR,'IsProtoType'       , 'N', TRUE);                                     
 4018    N:=FORMGEN.ADDFIELD(VSTR,'ProtoType'         , 'N', TRUE);                                     
 4019 
 4020    N:=FORMGEN.ADDFIELD(VSTR,'Inactive'          , 'N', TRUE);                                     
 4021 
 4022    N:=FORMGEN.ADDFIELD(VSTR,'Location'          , 'S', TRUE,    100);                             
 4023 
 4024    N:=FORMGEN.ADDFIELD(VSTR,'MerchantID'        , 'S', TRUE,    15, 'MerchantID', 'MerchantID');  
 4025 
 4026    N:=FORMGEN.ADDFIELD(VSTR,'ObjectUID'         , 'N', TRUE);                                     
 4027 
 4028    N:=FORMGEN.ADDFIELD(VSTR,'ParentCode'        , 'N', TRUE);                                     
 4029 
 4030    N:=FORMGEN.ADDFIELD(VSTR,'ParentInactive'    , 'N', TRUE);                                     
 4031 
 4032    N:=FORMGEN.ADDFIELD(VSTR,'External_Ident'    , 'S', TRUE,   20, 'External ID', 'Retailer external identifier');  
 4033 
 4034    N:=FORMGEN.ADDFIELD(VSTR,'LimitGrpFO'        , 'N', TRUE);                                     
 4035    N:=FORMGEN.ADDFIELD(VSTR,'LimitGrp'          , 'N', TRUE);                                     
 4036    N:=FORMGEN.ADDFIELD(VSTR,'LimitCurrency'     , 'N', TRUE);                                     
 4037 
 4038    N:=FORMGEN.ADDFIELD(VSTR,'Reimbursement'     , 'N', TRUE);                                     
 4039 
 4040    N:=FORMGEN.ADDFIELD(VSTR,'AnyPOSRefund'      , 'N', TRUE);                                     
 4041 
 4042    FORMGEN.ALLOWSTRUCTOPERS(VSTR,FORMGEN.OP_INS+FORMGEN.OP_UP+FORMGEN.OP_READ+FORMGEN.OP_DEL);
 4043    SSTRUCT := VSTR;
 4044 
 4045    VGRP := FORMGEN.CREATEGROUP('RET',SSTRUCT);
 4046    N:=FORMGEN.ADDITEM(VGRP, 'Ident'          , 25,  3);
 4047    N:=FORMGEN.ADDITEM(VGRP, 'Name'           , 25,  4);
 4048    N:=FORMGEN.ADDITEM(VGRP, 'External_Ident' , 25,  5);  
 4049    N:=FORMGEN.ADDITEM(VGRP, 'External_Name'  , 25,  6);
 4050    
 4051    
 4052    SGROUP:=VGRP;
 4053 
 4054    SFORM:=FORMGEN.CREATEFORM('RET');
 4055    N:=FORMGEN.ADDLINK       (SFORM, 'link'    , SSTRUCT, 'ReferenceRetailer.sRow');
 4056 
 4057    N:=FORMGEN.ADDFORMITEM   (SFORM, 'RET'     , SGROUP      , 'link',2,1);
 4058 
 4059    FORMGEN.ALLOWFORMOPERS(SFORM, FORMGEN.OP_MKDIALOG+FORMGEN.OP_FORM2ROWS+FORMGEN.OP_ROWS2FORM);
 4060 
 4061 
 4062 
 4063    VSTR := FORMGEN.CREATESTRUCT('tReferenceRetailerContacts',2,'ReferenceRetailer.sRowContact');
 4064    N:=FORMGEN.ADDFIELD(VSTR,'Branch'            , 'N', FALSE);
 4065    N:=FORMGEN.ADDFIELD(VSTR,'RetailerCode'      , 'N', FALSE);
 4066    N:=FORMGEN.ADDFIELD(VSTR,'FIO'               , 'S', FALSE, 250, 'Full name');  
 4067    
 4068    N:=FORMGEN.ADDFIELD(VSTR,'Post'              , 'S', TRUE, 30,   'Position', 'Position', FORMGEN.ET_COMBO+FORMGEN.ET_LINE,'ReferenceRetailer.FillPostList');
 4069    N:=FORMGEN.ADDFIELD(VSTR,'Note'              , 'S', TRUE, 2000, 'Comments','',          FORMGEN.ET_MEMO);
 4070    N:=FORMGEN.ADDFIELD(VSTR,'OrderNo'           , 'N', FALSE);
 4071    N:=FORMGEN.ADDFIELD(VSTR,'ClientIdLink'      , 'N', FALSE);  
 4072 
 4073    SSTRUCTCONTACT := VSTR;
 4074    FORMGEN.ALLOWSTRUCTOPERS(VSTR,FORMGEN.OP_INS);
 4075 
 4076    VGRP := FORMGEN.CREATEGROUP('CONTACT',VSTR);
 4077    N:=FORMGEN.ADDITEM(VGRP, 'FIO'   ,15,  1, 40);  
 4078    N:=FORMGEN.ADDITEM(VGRP, 'POST'  ,15,  2);
 4079    N:=FORMGEN.ADDITEM(VGRP, 'NOTE'  ,15,  3, 40, 3);
 4080    
 4081    SGROUPCONTACT := VGRP;
 4082 
 4083    SFORMCONTACT:=FORMGEN.CREATEFORM('RETAILERCONTACT');
 4084    N:=FORMGEN.ADDLINK       (SFORMCONTACT, 'link'    , SSTRUCTCONTACT, 'ReferenceRetailer.sRowContact');
 4085 
 4086    N:=FORMGEN.ADDFORMITEM   (SFORMCONTACT, 'CONTACT'     , SGROUPCONTACT , 'link', 0, 1);
 4087 
 4088    FORMGEN.ALLOWFORMOPERS(SFORMCONTACT, FORMGEN.OP_MKDIALOG+FORMGEN.OP_FORM2ROWS+FORMGEN.OP_ROWS2FORM);
 4089 
 4090  EXCEPTION
 4091   WHEN OTHERS THEN
 4092    S.ERR('ReferenceRetailer.InitStruct');
 4093    ERROR.SAVE('ReferenceRetailer.InitStruct');
 4094    RAISE;
 4095  END;
 4096                
 4097 
 4098 
 4099 
 4100 
 4101 
 4102 
 4103 
 4104 
 4105 
 4106   
 4107 PROCEDURE UPDATERETAILER (PRET TREFERENCERETAILER%ROWTYPE,  PALTERATIONMODE TYPEALTERATIONMODE, PMODE TYPEMODE, PUSEBLOCK BOOLEAN) 
 4108   
 4109   IS
 4110     CPROCNAME CONSTANT VARCHAR2(100) := CPACKAGENAME || '.UpdateRetailer';
 4111     
 4112     
 4113     
 4114     
 4115     VPREVEXTATTRIBUTELIST APITYPES.TYPERETAILEREXTATTRIBUTELIST;
 4116     VPREVUSERPROPLIST     APITYPES.TYPEUSERPROPLIST;
 4117   BEGIN
 4118     S.SAY(CPROCNAME || ': start ['||PRET.CODE||']');
 4119     
 4120     IF PUSEBLOCK THEN
 4121       VPREVEXTATTRIBUTELIST := GETCURRENTEXTATTRIBUTELIST;
 4122       VPREVUSERPROPLIST     := GETCURRENTUSERPROPLIST;
 4123     END IF;
 4124 
 4125     
 4126     INITSTRUCT;
 4127 
 4128     SROW   := PRET;
 4129     SREGIM := PALTERATIONMODE;
 4130 
 4131     
 4132     
 4133     
 4134     IF PUSEBLOCK THEN
 4135       IF PALTERATIONMODE = CAMMODIFY THEN
 4136         SETCURRENTUSERPROPLIST(OBJUSERPROPERTY.GETRECORD(OBJECT_NAME, GETUID(PRET.CODE)));
 4137         SETCURRENTEXTATTRIBUTELIST(RETAILEREXTPSNAME.GETEXTATTRIBUTELIST(PRET.CODE));
 4138       ELSE
 4139         CLEARCURRENTUSERPROPLIST;
 4140         CLEARCURRENTEXTATTRIBUTELIST;
 4141       END IF;
 4142     END IF;
 4143     
 4144 
 4145     SAVEOBJ (PMODE, PALTERATIONMODE, PUSEBLOCK); 
 4146 
 4147     
 4148     IF PUSEBLOCK THEN
 4149       SETCURRENTEXTATTRIBUTELIST(VPREVEXTATTRIBUTELIST);
 4150       SETCURRENTUSERPROPLIST(VPREVUSERPROPLIST);
 4151     END IF;
 4152 
 4153     S.SAY(CPROCNAME || ': complete');
 4154   EXCEPTION
 4155     WHEN NO_DATA_FOUND THEN
 4156       ERR.SETERROR(ERR.REFFI_UNDEFINED_RETAILER, CPROCNAME);
 4157     WHEN OTHERS THEN
 4158       ERR.SETERROR(SQLCODE, CPROCNAME);
 4159   END;
 4160 
 4161   
 4162 PROCEDURE UPDATEOBJECT (PRET TREFERENCERETAILER%ROWTYPE, PLOG BOOLEAN, PMODE TYPEMODE, PUSEBLOCK BOOLEAN)  
 4163   
 4164   IS
 4165     CPROCNAME CONSTANT VARCHAR2(100) := CPACKAGENAME || '.UpdateObject';
 4166     
 4167     VOLDRET         TREFERENCERETAILER%ROWTYPE;  
 4168     
 4169     
 4170   BEGIN
 4171     
 4172     S.SAY(CPROCNAME || ': start [' || PRET.CODE || ']');
 4173     IF (PLOG) THEN
 4174       VOLDRET := READOBJECT(PRET.CODE);
 4175     END IF;
 4176 
 4177     UPDATERETAILER (PRET, REG_EDIT, PMODE, PUSEBLOCK); 
 4178 
 4179     
 4180     IF (PLOG) THEN
 4181       
 4182       
 4183 
 4184 
 4185 
 4186 
 4187 
 4188 
 4189 
 4190 
 4191 
 4192 
 4193 
 4194 
 4195 
 4196 
 4197 
 4198 
 4199 
 4200 
 4201 
 4202 
 4203 
 4204 
 4205 
 4206 
 4207 
 4208 
 4209 
 4210 
 4211 
 4212       LOGCHANGES(A4MLOG.ACT_CHANGE, VOLDRET, PRET);
 4213       
 4214     END IF;
 4215     
 4216     S.SAY(CPROCNAME || ': complete');
 4217   EXCEPTION
 4218     WHEN OTHERS THEN
 4219       
 4220       
 4221 
 4222 
 4223 
 4224 
 4225 
 4226 
 4227 
 4228 
 4229 
 4230 
 4231 
 4232       
 4233       RAISE;
 4234   END;
 4235 
 4236   
 4237 FUNCTION  CREATEOBJECT (PRET TREFERENCERETAILER%ROWTYPE, PLOG BOOLEAN, PMODE TYPEMODE, PUSEBLOCK BOOLEAN) RETURN NUMBER  
 4238   
 4239   IS
 4240     
 4241   BEGIN
 4242     SROW.CODE:=NULL;
 4243 
 4244     UPDATERETAILER (PRET, REG_ADD, PMODE, PUSEBLOCK); 
 4245 
 4246     
 4247     IF (PLOG) THEN
 4248       
 4249       
 4250 
 4251 
 4252 
 4253 
 4254 
 4255 
 4256 
 4257 
 4258 
 4259 
 4260 
 4261 
 4262 
 4263 
 4264 
 4265 
 4266 
 4267 
 4268 
 4269 
 4270 
 4271 
 4272 
 4273 
 4274 
 4275 
 4276       LOGCHANGES(A4MLOG.ACT_ADD, PNEWROW => SROW);
 4277       
 4278 
 4279     END IF;
 4280     
 4281 
 4282     RETURN SROW.CODE;
 4283 
 4284   EXCEPTION
 4285     WHEN OTHERS THEN
 4286       
 4287       
 4288 
 4289 
 4290 
 4291 
 4292 
 4293 
 4294 
 4295 
 4296 
 4297 
 4298 
 4299       
 4300       RAISE;
 4301   END;
 4302 
 4303   
 4304 FUNCTION  READOBJECT (PCODE NUMBER) RETURN TREFERENCERETAILER%ROWTYPE
 4305   
 4306   IS
 4307     CBRANCH CONSTANT NUMBER := SEANCE.GETBRANCH();
 4308   BEGIN
 4309     SELECT * INTO SROW FROM TREFERENCERETAILER WHERE BRANCH = CBRANCH AND CODE = PCODE;
 4310 
 4311     
 4312     IF (SROW.OBJECTUID IS NULL) THEN
 4313       SROW.OBJECTUID := INTERNALGETUID(SROW.CODE);  
 4314     END IF;
 4315     
 4316 
 4317     RETURN SROW;
 4318   EXCEPTION
 4319     WHEN NO_DATA_FOUND THEN
 4320       ERR.SETERROR(ERR.REFFI_UNDEFINED_RETAILER,'ReferenceRetailer.ReadObject');
 4321       RETURN NULL;
 4322     WHEN OTHERS THEN
 4323       ERR.SETERROR(SQLCODE,'ReferenceRetailer.ReadObject');
 4324       RETURN NULL;
 4325   END;
 4326 
 4327   
 4328 PROCEDURE DELETEOBJECT (PCODE NUMBER, PLOG BOOLEAN)  
 4329   
 4330   IS
 4331     
 4332 
 4333 
 4334 
 4335  
 4336   BEGIN
 4337     IF (HAVECHILDOBJECT(PCODE)) THEN
 4338       ERR.SETERROR(ERR.REFFI_RETAILER_OBJECT_EXISTS, 'ReferenceRetailer.DeleteObject');  
 4339     ELSE
 4340       
 4341       
 4342 
 4343 
 4344 
 4345 
 4346 
 4347 
 4348 
 4349 
 4350 
 4351 
 4352 
 4353 
 4354 
 4355 
 4356 
 4357 
 4358 
 4359 
 4360 
 4361 
 4362 
 4363 
 4364 
 4365 
 4366 
 4367 
 4368 
 4369 
 4370       ADDACCGROUP.DELETERETAILERACCGROUPS(PCODE, FALSE); 
 4371       DELETERETAILER(PCODE, PLOG);
 4372       
 4373     END IF;
 4374 
 4375   EXCEPTION
 4376     WHEN NO_DATA_FOUND THEN
 4377       ERR.SETERROR(ERR.REFFI_UNDEFINED_RETAILER,'ReferenceRetailer.DeleteObject');
 4378     WHEN OTHERS THEN
 4379       ERR.SETERROR(SQLCODE,'ReferenceRetailer.DeleteObject');
 4380       
 4381 
 4382 
 4383 
 4384 
 4385 
 4386 
 4387 
 4388 
 4389 
 4390 
 4391  
 4392   END;
 4393 
 4394 
 4395   
 4396 PROCEDURE REFRESHOBJECT(PCODE NUMBER) IS
 4397   
 4398     VBRANCH    NUMBER;
 4399     VCLERKCODE NUMBER;
 4400   BEGIN
 4401     VBRANCH    := SEANCE.GETBRANCH();
 4402     VCLERKCODE := CLERK.GETCODE();
 4403 
 4404     UPDATE TREFERENCERETAILER
 4405       SET UPDATEDATE = SYSDATE(),
 4406           UPDATECLERK = VCLERKCODE
 4407       WHERE BRANCH = VBRANCH
 4408         AND CODE = PCODE;
 4409 
 4410   EXCEPTION
 4411     WHEN OTHERS THEN
 4412       ERROR.SAVE('ReferenceTerminal.RefreshObject');
 4413       RAISE;
 4414   END;
 4415 
 4416 
 4417  
 4418 FUNCTION  GETACCOUNT
 4419  
 4420  (
 4421     PRETCODE  IN NUMBER,
 4422     PCURRENCY IN NUMBER,
 4423     PTYPE     IN NUMBER
 4424  ) RETURN VARCHAR
 4425  IS
 4426    CBRANCH CONSTANT NUMBER := SEANCE.GETBRANCH();
 4427    VROW  TREFERENCERETAILER % ROWTYPE;
 4428    
 4429    VACCCODE NUMBER;
 4430  BEGIN
 4431    BEGIN
 4432      SELECT * INTO VROW FROM TREFERENCERETAILER WHERE
 4433        BRANCH = CBRANCH AND
 4434        CODE   = PRETCODE;
 4435    EXCEPTION
 4436     WHEN NO_DATA_FOUND THEN
 4437       ERR.SETERROR(ERR.REFFI_UNDEFINED_RETAILER,'ReferenceRetailer.GetAccount');
 4438       RETURN NULL;
 4439    END;
 4440    IF VROW.HAVETRANSIT IS NULL THEN
 4441      VACCCODE := VROW.ACCOUNTGROUPCODE;
 4442    ELSE
 4443      IF PTYPE = ACTIVE_ACCOUNT THEN
 4444        VACCCODE := VROW.ACC_ACT;
 4445      ELSIF PTYPE = PASSIVE_ACCOUNT THEN
 4446        VACCCODE := VROW.ACC_PASS;
 4447      ELSIF PTYPE = REAL_ACCOUNT THEN
 4448        VACCCODE := VROW.ACCOUNTGROUPCODE;
 4449      END IF;
 4450    END IF;
 4451    IF VACCCODE IS NULL THEN
 4452      ERR.SETERROR(ERR.REFFI_UNDEFINED_ACCOUNT,'ReferenceRetailer.GetIssuerAccount');
 4453      RETURN NULL;
 4454    END IF;
 4455    RETURN ACCGROUP.GETACCOUNT(VACCCODE, PCURRENCY);
 4456  END;
 4457 
 4458  
 4459 FUNCTION  GETRETAILERRECORD
 4460  
 4461   (
 4462     PFIID IN NUMBER,
 4463     PRETIDENT IN VARCHAR
 4464   )
 4465   RETURN APITYPES.TYPERETAILERRECORD IS
 4466     CBRANCH CONSTANT NUMBER := SEANCE.GETBRANCH();
 4467     VROW TREFERENCERETAILER%ROWTYPE;
 4468     VRETAILERRECORD APITYPES.TYPERETAILERRECORD:=NULL;
 4469   BEGIN
 4470     SELECT * INTO VROW
 4471      FROM TREFERENCERETAILER
 4472      WHERE BRANCH = CBRANCH AND
 4473            FICODE = PFIID AND
 4474            IDENT = PRETIDENT;
 4475 
 4476     VRETAILERRECORD.CODE := VROW.CODE;
 4477     VRETAILERRECORD.FICODE := VROW.FICODE;
 4478     VRETAILERRECORD.IDENT := VROW.IDENT;
 4479     VRETAILERRECORD.NAME := VROW.NAME;
 4480     VRETAILERRECORD.EXTERNAL_NAME := VROW.EXTERNAL_NAME;
 4481     VRETAILERRECORD.EXTERNAL_CITY := VROW.EXTERNAL_CITY;
 4482     VRETAILERRECORD.EXTERNAL_COUNTRY := VROW.EXTERNAL_COUNTRY;
 4483     VRETAILERRECORD.EXTERNAL_ZIPCODE := VROW.EXTERNAL_ZIPCODE;
 4484     VRETAILERRECORD.EXTERNAL_SICCODE := VROW.EXTERNAL_SICCODE;
 4485     VRETAILERRECORD.COUNTRY := VROW.COUNTRY;
 4486     VRETAILERRECORD.CITY := VROW.CITY;
 4487     VRETAILERRECORD.ADDRESS := VROW.ADDRESS;
 4488     VRETAILERRECORD.PHONES := VROW.PHONES;
 4489     VRETAILERRECORD.EMAIL := VROW.EMAIL;
 4490     VRETAILERRECORD.POSTALCODE := VROW.POSTALCODE;
 4491     VRETAILERRECORD.REGION_CODE := VROW.REGION_CODE;
 4492     VRETAILERRECORD.CITY_CODE := VROW.CITY_CODE;
 4493     VRETAILERRECORD.IDCLIENT := VROW.CODE_CLIENT;
 4494     VRETAILERRECORD.NOTE := VROW.NOTE;
 4495     VRETAILERRECORD.PROFILE := VROW.PROFILE;
 4496     VRETAILERRECORD.BRANCHPART := VROW.BRANCHPART;
 4497     
 4498     VRETAILERRECORD.CREATEDATE := VROW.CREATEDATE;
 4499     VRETAILERRECORD.UPDATEDATE := VROW.UPDATEDATE;
 4500     
 4501     VRETAILERRECORD.STREET   := VROW.STREET  ;
 4502     VRETAILERRECORD.HOUSE    := VROW.HOUSE   ;
 4503     VRETAILERRECORD.BUILDING := VROW.BUILDING;
 4504     VRETAILERRECORD.FRAME    := VROW.FRAME   ;
 4505     VRETAILERRECORD.FLAT     := VROW.FLAT    ;
 4506 
 4507     
 4508     VRETAILERRECORD.ISPROTOTYPE   := NVL(VROW.ISPROTOTYPE, ISNOTPROTOTYPE);
 4509     VRETAILERRECORD.PROTOTYPE     := VROW.PROTOTYPE;
 4510     
 4511 
 4512     
 4513     VRETAILERRECORD.INACTIVE      := NVL(VROW.INACTIVE, CACTIVE);
 4514     
 4515     VRETAILERRECORD.LOCATION      := VROW.LOCATION;       
 4516     VRETAILERRECORD.MERCHANTID    := VROW.MERCHANTID;     
 4517     VRETAILERRECORD.GUID          := GETGUID(VROW.CODE);  
 4518 
 4519     VRETAILERRECORD.PARENTINACTIVE := NVL(VROW.PARENTINACTIVE, CACTIVE);  
 4520 
 4521     VRETAILERRECORD.EXTERNAL_IDENT := VROW.EXTERNAL_IDENT;  
 4522     VRETAILERRECORD.PARENTCODE     := VROW.PARENTCODE;      
 4523 
 4524     VRETAILERRECORD.LIMITGRPFO     := VROW.LIMITGRPFO;      
 4525     VRETAILERRECORD.LIMITGRP       := VROW.LIMITGRP;        
 4526     VRETAILERRECORD.LIMITCURRENCY  := VROW.LIMITCURRENCY;   
 4527     
 4528     VRETAILERRECORD.FAX          := VROW.FAX;
 4529     VRETAILERRECORD.COUNTRY_CODE := VROW.COUNTRY_CODE;
 4530     VRETAILERRECORD.CREATECLERK  := VROW.CREATECLERK;
 4531     VRETAILERRECORD.UPDATECLERK  := VROW.UPDATECLERK;
 4532     
 4533     VRETAILERRECORD.REIMBURSEMENT := NVL(VROW.REIMBURSEMENT, 0);
 4534     
 4535 
 4536     VRETAILERRECORD.ANYPOSREFUND := NVL(VROW.ANYPOSREFUND, 0); 
 4537 
 4538     RETURN VRETAILERRECORD;
 4539   EXCEPTION
 4540     WHEN NO_DATA_FOUND THEN
 4541       RETURN VRETAILERRECORD;
 4542     WHEN OTHERS THEN
 4543       ERR.SETERROR(SQLCODE, 'ReferenceRetailer.GetRetailerRecord');
 4544       RETURN VRETAILERRECORD;
 4545   END;
 4546 
 4547  
 4548 FUNCTION GETRETAILERACCLIST (PRETAILERCODE IN NUMBER) RETURN APITYPES.TYPERETAILERACCLIST
 4549   IS
 4550     CBRANCH CONSTANT NUMBER := SEANCE.GETBRANCH();
 4551     VRETAILERACCOUNT APITYPES.TYPERETAILERACCLIST;
 4552     VCOUNT           NUMBER;
 4553 
 4554     CURSOR CACCRET
 4555       IS
 4556       SELECT AG.*
 4557         FROM TREFERENCERETAILER RR, TACCGROUP AG
 4558         WHERE RR.BRANCH = CBRANCH
 4559           AND RR.CODE   = PRETAILERCODE
 4560           AND AG.BRANCH = RR.BRANCH
 4561           AND AG.CODE   = RR.ACCOUNTGROUPCODE;
 4562   BEGIN
 4563     VCOUNT := 0;
 4564 
 4565     FOR I IN CACCRET LOOP
 4566       VCOUNT := VCOUNT + 1;
 4567       VRETAILERACCOUNT(VCOUNT).CURRENCY := I.CURRENCY;
 4568       VRETAILERACCOUNT(VCOUNT).ACCOUNT := I.ACCOUNT;
 4569       VRETAILERACCOUNT(VCOUNT).ACCOUNTGROUP := CACCOUNTGROUPSETTLEMENT;
 4570     END LOOP;
 4571 
 4572     RETURN VRETAILERACCOUNT;
 4573   EXCEPTION
 4574     WHEN OTHERS THEN
 4575       ERR.SETERROR(SQLCODE, 'ReferenceRetailer.GetRetailerAccList');
 4576       RETURN VRETAILERACCOUNT;
 4577   END;
 4578 
 4579 
 4580 FUNCTION GETRETAILERTRANACCLIST (PRETAILERCODE IN NUMBER) RETURN APITYPES.TYPERETAILERACCLIST
 4581   IS
 4582     CBRANCH CONSTANT NUMBER := SEANCE.GETBRANCH();
 4583     VRETAILERACCOUNT APITYPES.TYPERETAILERACCLIST;
 4584     VCOUNT           NUMBER;
 4585 
 4586     CURSOR CTRANACCRET
 4587       IS
 4588       SELECT AG.*, DECODE(AG.CODE, RR.ACC_ACT, CACCOUNTGROUPACTIVE, CACCOUNTGROUPPASSIVE) AS ACCOUNTGROUP
 4589         FROM TREFERENCERETAILER RR, TACCGROUP AG
 4590         WHERE RR.BRANCH = CBRANCH
 4591           AND RR.CODE   = PRETAILERCODE
 4592           AND AG.BRANCH = RR.BRANCH
 4593           AND AG.CODE IN (RR.ACC_ACT, RR.ACC_PASS);
 4594   BEGIN
 4595     VCOUNT := 0;
 4596 
 4597     FOR I IN CTRANACCRET LOOP
 4598       VCOUNT := VCOUNT + 1;
 4599       VRETAILERACCOUNT(VCOUNT).CURRENCY := I.CURRENCY;
 4600       VRETAILERACCOUNT(VCOUNT).ACCOUNT := I.ACCOUNT;
 4601       VRETAILERACCOUNT(VCOUNT).ACCOUNTGROUP := I.ACCOUNTGROUP;
 4602     END LOOP;
 4603 
 4604     RETURN VRETAILERACCOUNT;
 4605   EXCEPTION
 4606     WHEN OTHERS THEN
 4607       ERR.SETERROR(SQLCODE, 'ReferenceRetailer.GetRetailerTranAccList');
 4608       RETURN VRETAILERACCOUNT;
 4609   END;
 4610 
 4611 FUNCTION GETRETAILERADDITIONALACCLIST (PRETAILERCODE IN NUMBER) RETURN APITYPES.TYPERETAILERACCLIST
 4612   IS
 4613     CBRANCH CONSTANT NUMBER := SEANCE.GETBRANCH();
 4614     VRETAILERACCOUNT APITYPES.TYPERETAILERACCLIST;
 4615     VCOUNT           NUMBER;
 4616 
 4617     CURSOR CADDITIONALACCRET
 4618       IS
 4619       SELECT RAG.*, RAGT.IDENT
 4620         FROM TACCTYPE2RET AR, TRETAILERACCOUNTGROUP RAG, TREFACCGROUPTYPE RAGT
 4621         WHERE AR.BRANCH   = CBRANCH
 4622           AND AR.RET_CODE = PRETAILERCODE
 4623           AND RAG.BRANCH  = AR.BRANCH
 4624           AND RAG.CODE    = AR.CODE
 4625           AND RAGT.BRANCH = AR.BRANCH
 4626           AND RAGT.CODE   = AR.TYPE_CODE;
 4627   BEGIN
 4628     VCOUNT := 0;
 4629 
 4630     FOR I IN CADDITIONALACCRET LOOP
 4631       VCOUNT := VCOUNT + 1;
 4632       VRETAILERACCOUNT(VCOUNT).CURRENCY := I.CURRENCY;
 4633       VRETAILERACCOUNT(VCOUNT).ACCOUNT := I.ACCOUNT;
 4634       VRETAILERACCOUNT(VCOUNT).ACCOUNTGROUP := I.IDENT;
 4635     END LOOP;
 4636 
 4637     RETURN VRETAILERACCOUNT;
 4638   EXCEPTION
 4639     WHEN OTHERS THEN
 4640       ERR.SETERROR(SQLCODE, 'ReferenceRetailer.GetRetailerAdditionalAccList');
 4641       RETURN VRETAILERACCOUNT;
 4642   END;
 4643 
 4644 
 4645 PROCEDURE TOLOG(PCODE NUMBER, PTEXT VARCHAR,
 4646                 PACTION NUMBER := NULL,          
 4647                 PLOGPARAMLISTNO NUMBER := NULL)  
 4648   IS
 4649   BEGIN
 4650     
 4651     IF (PLOGPARAMLISTNO IS NOT NULL) THEN
 4652       IF (A4MLOG.LOGOBJECT(OBJECT.GETTYPE(OBJECT_NAME), NVL(TO_CHAR(PCODE), ' Copy ?'),
 4653                            PTEXT, PACTION,  
 4654                            A4MLOG.PUTPARAMLIST(PLOGPARAMLISTNO)) != 0) THEN
 4655         ERROR.RAISEUSER(ERR.GETFULLMESSAGE());
 4656       END IF;
 4657     END IF;
 4658     
 4659   EXCEPTION
 4660     WHEN OTHERS THEN
 4661       RAISE;
 4662   END;
 4663 
 4664 PROCEDURE FILLSECURITYARRAY(PLEVEL IN NUMBER, PKEY   IN VARCHAR)
 4665   IS
 4666   BEGIN
 4667     IF PLEVEL = 1 THEN
 4668       SECURITY.STITLE     := 'List of allowed actions';
 4669       SECURITY.SARRAYSIZE := 7; 
 4670 
 4671       SECURITY.SCODEARRAY(1) := RIGHT_VIEW;
 4672       SECURITY.SCODEARRAY(2) := RIGHT_VIEW_ALL_BR;
 4673       SECURITY.SCODEARRAY(3) := RIGHT_CREATE; 
 4674       SECURITY.SCODEARRAY(4) := RIGHT_MODIFY;
 4675       SECURITY.SCODEARRAY(5) := RIGHT_VIEW_ACC;
 4676       SECURITY.SCODEARRAY(6) := RIGHT_MODIFY_ACC;
 4677       SECURITY.SCODEARRAY(7) := RIGHT_BLOCKS; 
 4678 
 4679       SECURITY.STEXTARRAY(1) := 'View';
 4680       SECURITY.STEXTARRAY(2) := 'View retailers of all branches';  
 4681       SECURITY.STEXTARRAY(3) := 'Create'; 
 4682       SECURITY.STEXTARRAY(4) := 'Modification';
 4683       SECURITY.STEXTARRAY(5) := 'View accounts';
 4684       SECURITY.STEXTARRAY(6) := 'Modify accounts';
 4685       SECURITY.STEXTARRAY(7) := 'Blocks of additional control'; 
 4686     ELSE
 4687       SECURITY.SARRAYSIZE := 0;
 4688     END IF;
 4689 
 4690   EXCEPTION
 4691     WHEN OTHERS THEN
 4692       ERR.SETERROR(SQLCODE, 'ReferenceRetailer.FillSecurityArray');
 4693       RETURN ;
 4694   END;
 4695 
 4696 
 4697 
 4698 PROCEDURE MAKEITEM(PDIALOGID IN NUMBER, PITEMNAME IN VARCHAR, PX IN NUMBER, PY IN NUMBER, PWIDTH IN NUMBER, PCAPTION IN VARCHAR, PHINT IN VARCHAR, PLABELLEN IN NUMBER, PUSERROUTINE IN VARCHAR)
 4699   IS
 4700     CEVENTHANDLERMETHODNAME CONSTANT VARCHAR2(64) := CPACKAGENAME || '.MakeItemProc';
 4701   BEGIN
 4702     DIALOG.INPUTCHAR(PDIALOGID, PITEMNAME, PX, PY, PWIDTH, PHINT, NULL, PCAPTION);
 4703       DIALOG.LISTADDFIELD(PDIALOGID, PITEMNAME, 'Code',  'N', 10, 0);
 4704       DIALOG.LISTADDFIELD(PDIALOGID, PITEMNAME, 'Ident', 'C', 20, 1);
 4705       DIALOG.LISTADDFIELD(PDIALOGID, PITEMNAME, 'Name',  'C', 40, 1);
 4706 
 4707       DIALOG.SETREADONLY(PDIALOGID, PITEMNAME, TRUE);
 4708       DIALOG.SETITEMCHANGE(PDIALOGID, PITEMNAME, CEVENTHANDLERMETHODNAME);
 4709       DIALOG.SETITEMPOST(PDIALOGID, PITEMNAME, CEVENTHANDLERMETHODNAME);
 4710 
 4711     DIALOG.TEXTLABEL(PDIALOGID, PITEMNAME || '_LB', PX + PWIDTH + 3, PY, NVL(PLABELLEN, 40));
 4712 
 4713     DIALOG.HIDDENCHAR(PDIALOGID, PITEMNAME || '_UR', PUSERROUTINE);
 4714 
 4715   EXCEPTION
 4716     WHEN OTHERS THEN
 4717       ERROR.SAVE(CPACKAGENAME || '.MakeItem');
 4718       RAISE;
 4719   END;
 4720 
 4721 
 4722 
 4723 PROCEDURE MAKEITEMPROC(PWHAT IN CHAR, PDIALOGID IN NUMBER, PITEMNAME IN VARCHAR, PCMD IN NUMBER)
 4724   IS
 4725     
 4726     PROCEDURE ONNEXTFIELD
 4727       IS
 4728         VNAME        TREFERENCERETAILER.NAME%TYPE;
 4729         VUSERROUTINE VARCHAR2(64);
 4730       BEGIN
 4731         VNAME := DIALOG.GETCURRENTRECORDCHAR(PDIALOGID, PITEMNAME, 'Name');
 4732         DIALOG.PUTCHAR(PDIALOGID, PITEMNAME || '_LB', VNAME);
 4733 
 4734         VUSERROUTINE := DIALOG.GETCHAR(PDIALOGID, PITEMNAME || '_UR');
 4735 
 4736         IF (VUSERROUTINE IS NOT NULL) THEN
 4737           HTOOLS.EXECPROC(VUSERROUTINE || '(''' || PWHAT || ''', ' || TO_CHAR(PDIALOGID) || ', ''' || PITEMNAME || ''', 0);');
 4738         END IF;
 4739 
 4740       EXCEPTION
 4741         WHEN OTHERS THEN
 4742           ERROR.SAVE(CPACKAGENAME || '.MakeItemProc.OnNextField');
 4743           RAISE;
 4744       END;  
 4745     
 4746   BEGIN
 4747     IF (PWHAT = DIALOG.WT_NEXTFIELD) THEN
 4748       ONNEXTFIELD();
 4749     END IF;
 4750   EXCEPTION
 4751     WHEN OTHERS THEN
 4752       ERROR.SAVE(CPACKAGENAME || '.MakeItemProc');
 4753       RAISE;
 4754  END;
 4755 
 4756 
 4757 
 4758 PROCEDURE FILLITEM(PDIALOGID IN NUMBER, PITEMNAME IN VARCHAR, PFICODE IN NUMBER)
 4759   IS
 4760     VBRANCH NUMBER;
 4761     VTEXT   VARCHAR2(128);
 4762   BEGIN
 4763     VBRANCH := SEANCE.GETBRANCH;
 4764 
 4765     DIALOG.LISTCLEAR(PDIALOGID, PITEMNAME);
 4766 
 4767     DIALOG.LISTADDRECORD(PDIALOGID, PITEMNAME, '~~~' , 0, 0);
 4768 
 4769     FOR N IN (SELECT *
 4770                 FROM TREFERENCERETAILER
 4771                 WHERE BRANCH = VBRANCH
 4772                   AND FICODE = PFICODE
 4773                 ORDER BY IDENT)
 4774     LOOP
 4775       IF (N.IDENT = ' ') THEN
 4776         VTEXT := N.CODE || '~' || CFICAPTION || '~~';
 4777       ELSE
 4778         VTEXT := SUBSTR(N.CODE || '~' || N.IDENT || '~' || N.NAME || '~', 1, 128); 
 4779       END IF;
 4780 
 4781       DIALOG.LISTADDRECORD(PDIALOGID, PITEMNAME, VTEXT, 0, 0);
 4782     END LOOP;
 4783 
 4784   EXCEPTION
 4785     WHEN OTHERS THEN
 4786       ERROR.SAVE(CPACKAGENAME || '.FillItem');
 4787       RAISE;
 4788   END;
 4789 
 4790 
 4791 
 4792 PROCEDURE SETITEMDATA(PDIALOGID IN NUMBER, PITEMNAME IN VARCHAR, PCODE IN NUMBER)
 4793   IS
 4794     VNAME TREFERENCERETAILER.NAME%TYPE;
 4795   BEGIN
 4796     DIALOG.SETCURRECBYVALUE(PDIALOGID, PITEMNAME, 'Code', PCODE);
 4797 
 4798     VNAME := DIALOG.GETCURRENTRECORDCHAR(PDIALOGID, PITEMNAME, 'Name');
 4799     DIALOG.PUTCHAR(PDIALOGID, PITEMNAME || '_LB', VNAME);
 4800 
 4801   EXCEPTION
 4802     WHEN OTHERS THEN
 4803       ERROR.SAVE(CPACKAGENAME || '.SetItemData');
 4804       RAISE;
 4805   END;
 4806 
 4807 
 4808 
 4809 PROCEDURE SETITEMATTR(PDIALOGID IN NUMBER, PITEMNAME IN VARCHAR, PATTR IN VARCHAR)
 4810   IS
 4811   BEGIN
 4812     DIALOG.SETITEMATTRIBUTIES(PDIALOGID, PITEMNAME, PATTR);
 4813     DIALOG.SETITEMATTRIBUTIES(PDIALOGID, PITEMNAME||'_LB', PATTR);
 4814   END;
 4815 
 4816 
 4817 
 4818 FUNCTION GETITEMDATA(PDIALOGID IN NUMBER, PITEMNAME IN VARCHAR) RETURN NUMBER
 4819   IS
 4820     VCODE TREFERENCERETAILER.CODE%TYPE;
 4821   BEGIN
 4822     VCODE := DIALOG.GETCURRENTRECORDNUMBER(PDIALOGID, PITEMNAME, 'Code');
 4823 
 4824     RETURN VCODE;
 4825   EXCEPTION
 4826     WHEN OTHERS THEN
 4827       ERROR.SAVE(CPACKAGENAME || '.GetItemData');
 4828       RAISE;
 4829   END;
 4830 
 4831 
 4832 
 4833 PROCEDURE SAVECONTACTSRETAIL(PCODE NUMBER)
 4834   IS
 4835    CBRANCH CONSTANT NUMBER := SEANCE.GETBRANCH();
 4836 
 4837    FUNCTION GETNEWORDERNO RETURN NUMBER  
 4838      IS
 4839        VORDERNO NUMBER;
 4840      BEGIN
 4841        SELECT NVL(MAX(ORDERNO),0)+1 INTO VORDERNO
 4842          FROM TREFERENCERETAILERCONTACTS
 4843          WHERE BRANCH = CBRANCH
 4844            AND RETAILERCODE = PCODE;
 4845 
 4846        RETURN VORDERNO;
 4847      END;
 4848 
 4849   BEGIN
 4850 
 4851     DELETE FROM TREFERENCERETAILERCONTACTS WHERE BRANCH = CBRANCH AND RETAILERCODE = PCODE;
 4852 
 4853     FOR I IN 1..SCONTACTSCOUNT LOOP
 4854       IF SCONTACTS(I).ORDERNO IS NULL THEN
 4855         SCONTACTS(I).ORDERNO := GETNEWORDERNO;
 4856       END IF;
 4857 
 4858       IF SREGIM <> REG_EDIT THEN
 4859         SCONTACTS(I).RETAILERCODE := PCODE;
 4860       END IF;
 4861 
 4862       SROWCONTACT := SCONTACTS(I);
 4863       FORMGEN.EXECSTRUCTOPER(SSTRUCTCONTACT,FORMGEN.OP_INS);
 4864     END LOOP;
 4865   END;
 4866 
 4867 
 4868 FUNCTION  NEWOBJECT
 4869   (
 4870     PCODE IN NUMBER,
 4871     PMOD  IN CHAR
 4872   )
 4873   RETURN NUMBER IS
 4874     USERRAISE    EXCEPTION;
 4875     THIS         NUMBER;
 4876   BEGIN
 4877     ERR.SETERROR(0, 'ReferenceRetailer.NewObject');
 4878 
 4879     IF UPPER(PMOD) = 'W' THEN
 4880       
 4881       IF OBJECT.CAPTURE(OBJECT_NAME, PCODE) != 0 THEN
 4882         IF ERR.GETERRORCODE = ERR.OBJECT_BUSY THEN
 4883           ERR.SETERROR(ERR.REFFI_RETAILER_BUSY, 'ReferenceRetailer.NewObject', OBJECT.CAPTUREDOBJECTINFO(OBJECT_NAME, PCODE) || ' RETAILER/CODE: ' || PCODE);
 4884         END IF;
 4885         RAISE USERRAISE;
 4886       END IF;
 4887       
 4888     END IF;
 4889 
 4890     THIS := GETFREEHANDLE();
 4891 
 4892     RETAILERMOD(THIS) := UPPER(PMOD);
 4893 
 4894     RETURN THIS;
 4895 
 4896   EXCEPTION
 4897     WHEN USERRAISE THEN
 4898       RETURN BAD_THIS;
 4899 
 4900     WHEN OTHERS THEN
 4901       IF UPPER(PMOD) = 'W' THEN
 4902         OBJECT.RELEASE(OBJECT_NAME, PCODE);
 4903       END IF;
 4904 
 4905       RETURN BAD_THIS;
 4906   END;
 4907 
 4908 FUNCTION  GETFREEHANDLE
 4909   RETURN NUMBER IS
 4910     THIS NUMBER;
 4911   BEGIN
 4912     THIS := BAD_THIS;
 4913 
 4914     LOOP
 4915       THIS := THIS + 1;
 4916       EXIT WHEN RETAILERMOD(THIS) = 'N';
 4917     END LOOP;
 4918 
 4919     RETURN THIS;
 4920   EXCEPTION
 4921     WHEN OTHERS THEN
 4922       RETURN THIS;
 4923   END;
 4924 
 4925 PROCEDURE FREEOBJECT
 4926   (
 4927     PCODE IN NUMBER,
 4928     THIS IN NUMBER
 4929   )
 4930   IS
 4931   BEGIN
 4932     IF TESTHANDLE(THIS, 'ReferenceRetailer.FreeObject') = 'W' THEN
 4933       OBJECT.RELEASE(OBJECT_NAME, PCODE);
 4934     END IF;
 4935     RETAILERMOD(THIS) := 'N';
 4936   EXCEPTION
 4937     WHEN OTHERS THEN
 4938       NULL;
 4939   END;
 4940 
 4941 FUNCTION  TESTHANDLE
 4942   (
 4943     THIS  IN NUMBER,
 4944     PFROM IN CHAR
 4945   )
 4946   RETURN CHAR IS
 4947     VMOD CHAR(1);
 4948   BEGIN
 4949     VMOD := RETAILERMOD(THIS);
 4950 
 4951     ERR.SETERROR(0, PFROM);
 4952 
 4953     RETURN VMOD;
 4954   EXCEPTION
 4955     WHEN OTHERS THEN
 4956       RETURN 'N';
 4957   END;
 4958 
 4959 
 4960 
 4961 PROCEDURE SETPOSTALADDRESS(PCODE NUMBER, PADDRESS APITYPES.ADDRESSINFO, PLOG BOOLEAN) 
 4962   IS
 4963     CPROCNAME CONSTANT VARCHAR2(100) := CPACKAGENAME || '.SetPostalAddress';
 4964     VROW      TREFERENCERETAILER%ROWTYPE;
 4965   BEGIN
 4966 
 4967    
 4968 
 4969 
 4970 
 4971 
 4972 
 4973  
 4974     VROW := READOBJECT(PCODE);
 4975 
 4976     VROW.CITY_CODE        := PADDRESS.CITY;
 4977     VROW.COUNTRY_CODE     := PADDRESS.COUNTRY;
 4978     VROW.REGION_CODE      := PADDRESS.REGION;
 4979     VROW.ADDRESS          := PADDRESS.ADDRESS;
 4980     VROW.EXTERNAL_ZIPCODE := PADDRESS.POSTAL;
 4981     VROW.PHONES           := PADDRESS.PHONE;
 4982     VROW.FAX              := PADDRESS.FAX;
 4983     VROW.EMAIL            := PADDRESS.EMAIL;
 4984     VROW.STREET           := PADDRESS.STREET;
 4985     VROW.HOUSE            := PADDRESS.HOUSE;
 4986     VROW.BUILDING         := PADDRESS.BUILDING;
 4987     VROW.FRAME            := PADDRESS.FRAME;
 4988     VROW.FLAT             := PADDRESS.FLAT;
 4989 
 4990     UPDATEOBJECT(VROW, PLOG);  
 4991   EXCEPTION
 4992     WHEN OTHERS THEN
 4993       ERROR.SAVE(CPROCNAME);
 4994       RAISE;
 4995   END;
 4996 
 4997 FUNCTION GETPOSTALADDRESS(PCODE NUMBER) RETURN APITYPES.ADDRESSINFO  
 4998   IS
 4999     VROW     TREFERENCERETAILER%ROWTYPE;
 5000     VADDRESS APITYPES.ADDRESSINFO;
 5001   BEGIN
 5002     VROW := READOBJECT(PCODE);
 5003 
 5004     VADDRESS.CITY     := VROW.CITY_CODE;
 5005     VADDRESS.COUNTRY  := VROW.COUNTRY_CODE;
 5006     VADDRESS.REGION   := VROW.REGION_CODE;
 5007     VADDRESS.ADDRESS  := SUBSTR(RTRIM(VROW.ADDRESS), 1, 200);
 5008     VADDRESS.POSTAL   := VROW.EXTERNAL_ZIPCODE;
 5009     VADDRESS.PHONE    := SUBSTR(RTRIM(VROW.PHONES), 1, 20);
 5010     VADDRESS.FAX      := RTRIM(VROW.FAX);
 5011     VADDRESS.EMAIL    := RTRIM(VROW.EMAIL);
 5012     VADDRESS.STREET   := VROW.STREET;
 5013     VADDRESS.HOUSE    := VROW.HOUSE;
 5014     VADDRESS.BUILDING := VROW.BUILDING;
 5015     VADDRESS.FRAME    := VROW.FRAME;
 5016     VADDRESS.FLAT     := VROW.FLAT;
 5017 
 5018     RETURN VADDRESS;
 5019   END;
 5020 
 5021 
 5022 PROCEDURE FILLCLIENTTYPEITEM(PDIALOG IN NUMBER, PITEM IN VARCHAR, PCMD IN NUMBER, PCLIENTTYPE IN NUMBER := CCLIENTCORPORATE)
 5023   IS
 5024   BEGIN
 5025     DIALOG.LISTCLEAR(PDIALOG,PITEM);
 5026     DIALOG.LISTADDRECORD(PDIALOG, PITEM, CCLIENTCORPORATE || '~Corporate customer~', PCMD, 0);
 5027     DIALOG.LISTADDRECORD(PDIALOG, PITEM, CCLIENTPERSONE || '~Private customer~', PCMD, 0);
 5028     DIALOG.SETCURREC(PDIALOG, PITEM, SERVICE.IIF(PCLIENTTYPE = CLIENT.CT_COMPANY, 1, 2));
 5029     DIALOG.PUTCHAR(PDIALOG,'ClientTypeLabel', DIALOG.GETCURRENTRECORDCHAR(PDIALOG, 'ClientType', 'Name'));
 5030     DIALOG.SETITEMPRE(PDIALOG, PITEM, 'ReferenceRetailer.DialogEditProc');
 5031   END;
 5032 
 5033 
 5034 
 5035 PROCEDURE FILLPROTOTYPEITEM (PDIALOG IN NUMBER, PITEM IN VARCHAR, PCMD IN NUMBER, PFICODE IN NUMBER)
 5036   IS
 5037     CBRANCH CONSTANT NUMBER := SEANCE.GETBRANCH();
 5038     
 5039   BEGIN
 5040     DIALOG.LISTCLEAR(PDIALOG,PITEM);
 5041     DIALOG.LISTADDRECORD(PDIALOG, PITEM, '~~~~' , PCMD, 0);
 5042 
 5043     FOR N IN (SELECT CODE||'~'||FICODE||'~'||IDENT||'~'||NAME||'~' AS TEXT
 5044                 FROM TREFERENCERETAILER
 5045                 WHERE BRANCH = CBRANCH
 5046                   AND FICODE = PFICODE
 5047                   AND CODE <> NVL(SROW.CODE, -1)
 5048                   AND IDENT <> ' '
 5049                   AND ISPROTOTYPE = REFERENCERETAILER.ISPROTOTYPE)
 5050     LOOP
 5051       DIALOG.LISTADDRECORD(PDIALOG, PITEM, N.TEXT , PCMD, 0);
 5052     END LOOP;
 5053   END;
 5054 
 5055 PROCEDURE PROTOTYPEITEM(PDIALOG NUMBER, PITEM CHAR, X NUMBER, Y NUMBER, PLEN NUMBER, PCAPTION VARCHAR, PHINT VARCHAR, PLABLEN NUMBER:=0, PDOFILLITEM BOOLEAN:=TRUE, PDOITEMPRE BOOLEAN:=TRUE, PFICODE NUMBER)
 5056   IS
 5057     VLEN NUMBER := 20;
 5058   BEGIN
 5059     IF VLEN < PLEN THEN VLEN := PLEN; END IF;
 5060       DIALOG.INPUTCHAR(PDIALOG, PITEM, X, Y, VLEN, PHINT, NULL, PCAPTION);
 5061       IF PLABLEN > 0 THEN
 5062         DIALOG.SETITEMCHANGE (PDIALOG, PITEM,'ReferenceRetailer.ProtoTypeItemProc');
 5063         IF PDOITEMPRE THEN
 5064           DIALOG.SETITEMPRE    (PDIALOG, PITEM,'ReferenceRetailer.ProtoTypeItemProc');
 5065           DIALOG.SETITEMPOST   (PDIALOG, PITEM,'ReferenceRetailer.ProtoTypeItemProc');
 5066         END IF;
 5067     DIALOG.TEXTLABEL(PDIALOG, PITEM||'_LB', X+VLEN+3, Y, LEAST(PLABLEN, 40));
 5068     DIALOG.LISTADDFIELD(PDIALOG, PITEM,'Code','N',20,0);
 5069     DIALOG.LISTADDFIELD(PDIALOG, PITEM,'FiCode','N',20,0);
 5070     DIALOG.LISTADDFIELD(PDIALOG, PITEM,'Ident','C',20,1);
 5071     DIALOG.LISTADDFIELD(PDIALOG, PITEM,'Name','C',40,1);
 5072     IF PDOFILLITEM THEN
 5073       FILLPROTOTYPEITEM(PDIALOG, PITEM, 0, PFICODE);
 5074     END IF;
 5075   END IF;
 5076 
 5077   EXCEPTION
 5078   WHEN OTHERS THEN
 5079    S.ERR('ReferenceRetailer.ProtoTypeItem');
 5080    ERROR.SAVE('ReferenceRetailer.ProtoTypeItem');
 5081    RAISE;
 5082  END;
 5083 
 5084 PROCEDURE PROTOTYPEITEMPROC(PWHAT IN CHAR, PDIALOG IN NUMBER, PITEM IN CHAR, PCMD IN NUMBER)
 5085   IS
 5086   BEGIN
 5087     IF PWHAT = DIALOG.WT_NEXTFIELD THEN
 5088       DIALOG.PUTCHAR(PDIALOG, PITEM||'_LB', DIALOG.GETCURRENTRECORDCHAR(PDIALOG, PITEM, 'Name'));
 5089     END IF;
 5090 
 5091   EXCEPTION
 5092     WHEN OTHERS THEN
 5093       S.ERR('ReferenceRetailer.ProtoTypeItemProc');
 5094       ERROR.SAVE('ReferenceRetailer.ProtoTypeItemProc');
 5095       RAISE;
 5096  END;
 5097 
 5098 PROCEDURE SETPROTOTYPEITEMDATA(PDIALOG NUMBER, PITEM CHAR, PDATA NUMBER)
 5099   IS
 5100     
 5101   BEGIN
 5102     DIALOG.PUTCHAR(PDIALOG, PITEM, GETIDENT(PDATA));
 5103     DIALOG.SETCURRECBYVALUE(PDIALOG, PITEM, 'Code', PDATA);
 5104 
 5105     DIALOG.PUTCHAR(PDIALOG, PITEM||'_LB', DIALOG.GETCURRENTRECORDCHAR(PDIALOG, PITEM, 'Name'));
 5106 
 5107   EXCEPTION
 5108     WHEN OTHERS THEN
 5109       S.ERR('ReferenceRetailer.SetProtoTypeItemData');
 5110       ERROR.SAVE('ReferenceRetailer.SetProtoTypeItemData');
 5111       RAISE;
 5112   END;
 5113 
 5114 PROCEDURE DELETEPROTOTYPE (PCODE NUMBER)
 5115   IS
 5116     CBRANCH CONSTANT NUMBER := SEANCE.GETBRANCH();
 5117   BEGIN
 5118     UPDATE TREFERENCERETAILER
 5119       SET PROTOTYPE   = NULL
 5120       WHERE BRANCH    = CBRANCH
 5121         AND PROTOTYPE = PCODE;
 5122   END;
 5123 
 5124 
 5125 
 5126 
 5127 FUNCTION GETCURRENTRECORD RETURN APITYPES.TYPERETAILERRECORD
 5128   IS
 5129   BEGIN
 5130 
 5131     RETURN SCURRENTRETAILERRECORD;
 5132 
 5133   EXCEPTION
 5134     WHEN OTHERS THEN
 5135       S.ERR('ReferenceRetailer.GetCurrentRecord');
 5136       RAISE;
 5137   END;
 5138 
 5139 
 5140 
 5141 PROCEDURE SETCURRENTRECORD (PRETAILERRECORD IN APITYPES.TYPERETAILERRECORD)
 5142   IS
 5143   BEGIN
 5144     SCURRENTRETAILERRECORD := PRETAILERRECORD;
 5145   EXCEPTION
 5146     WHEN OTHERS THEN
 5147       S.ERR('ReferenceRetailer.SetCurrentRecord');
 5148       RAISE;
 5149   END;
 5150 
 5151 
 5152 
 5153 PROCEDURE CONVERTROWTYPETOAPITYPES(PRETAILERROW IN TYPERETAILERROWTYPE,
 5154                                    ORETAILERRECORD IN OUT NOCOPY APITYPES.TYPERETAILERRECORD,
 5155                                    PFILLGUID    IN BOOLEAN := FALSE) 
 5156   IS
 5157 BEGIN
 5158   ORETAILERRECORD.CODE              := PRETAILERROW.CODE            ;
 5159   ORETAILERRECORD.FICODE            := PRETAILERROW.FICODE          ;
 5160   ORETAILERRECORD.IDENT             := PRETAILERROW.IDENT           ;
 5161   ORETAILERRECORD.NAME              := PRETAILERROW.NAME            ;
 5162   ORETAILERRECORD.EXTERNAL_NAME     := PRETAILERROW.EXTERNAL_NAME   ;
 5163   ORETAILERRECORD.EXTERNAL_CITY     := PRETAILERROW.EXTERNAL_CITY   ;
 5164   ORETAILERRECORD.EXTERNAL_COUNTRY  := PRETAILERROW.EXTERNAL_COUNTRY;
 5165   ORETAILERRECORD.EXTERNAL_ZIPCODE  := PRETAILERROW.EXTERNAL_ZIPCODE;
 5166   ORETAILERRECORD.EXTERNAL_SICCODE  := PRETAILERROW.EXTERNAL_SICCODE;
 5167   ORETAILERRECORD.COUNTRY           := PRETAILERROW.COUNTRY         ;
 5168   ORETAILERRECORD.CITY              := PRETAILERROW.CITY            ;
 5169   ORETAILERRECORD.ADDRESS           := PRETAILERROW.ADDRESS         ;
 5170   ORETAILERRECORD.PHONES            := PRETAILERROW.PHONES          ;
 5171   ORETAILERRECORD.FAX               := PRETAILERROW.FAX             ;
 5172   ORETAILERRECORD.EMAIL             := PRETAILERROW.EMAIL           ;
 5173   ORETAILERRECORD.POSTALCODE        := PRETAILERROW.POSTALCODE      ;
 5174   ORETAILERRECORD.COUNTRY_CODE      := PRETAILERROW.COUNTRY_CODE    ;
 5175   ORETAILERRECORD.REGION_CODE       := PRETAILERROW.REGION_CODE     ;
 5176   ORETAILERRECORD.CITY_CODE         := PRETAILERROW.CITY_CODE       ;
 5177   ORETAILERRECORD.IDCLIENT          := PRETAILERROW.CODE_CLIENT     ;
 5178   ORETAILERRECORD.NOTE              := PRETAILERROW.NOTE            ;
 5179   ORETAILERRECORD.PROFILE           := PRETAILERROW.PROFILE         ;
 5180   ORETAILERRECORD.BRANCHPART        := PRETAILERROW.BRANCHPART      ;
 5181   ORETAILERRECORD.CREATEDATE        := PRETAILERROW.CREATEDATE      ;
 5182   ORETAILERRECORD.CREATECLERK       := PRETAILERROW.CREATECLERK     ;
 5183   ORETAILERRECORD.UPDATEDATE        := PRETAILERROW.UPDATEDATE      ;
 5184   ORETAILERRECORD.UPDATECLERK       := PRETAILERROW.UPDATECLERK     ;
 5185   ORETAILERRECORD.STREET            := PRETAILERROW.STREET          ;
 5186   ORETAILERRECORD.HOUSE             := PRETAILERROW.HOUSE           ;
 5187   ORETAILERRECORD.BUILDING          := PRETAILERROW.BUILDING        ;
 5188   ORETAILERRECORD.FRAME             := PRETAILERROW.FRAME           ;
 5189   ORETAILERRECORD.FLAT              := PRETAILERROW.FLAT            ;
 5190   ORETAILERRECORD.ISPROTOTYPE       := PRETAILERROW.ISPROTOTYPE     ;
 5191   ORETAILERRECORD.PROTOTYPE         := PRETAILERROW.PROTOTYPE       ;
 5192   ORETAILERRECORD.INACTIVE          := PRETAILERROW.INACTIVE        ;
 5193   ORETAILERRECORD.LOCATION          := PRETAILERROW.LOCATION        ;  
 5194   ORETAILERRECORD.MERCHANTID        := PRETAILERROW.MERCHANTID      ;  
 5195   
 5196   ORETAILERRECORD.PARENTCODE        := PRETAILERROW.PARENTCODE      ;  
 5197   ORETAILERRECORD.EXTERNAL_IDENT    := PRETAILERROW.EXTERNAL_IDENT  ;  
 5198   ORETAILERRECORD.LIMITGRPFO        := PRETAILERROW.LIMITGRPFO      ;  
 5199   ORETAILERRECORD.LIMITGRP          := PRETAILERROW.LIMITGRP        ;  
 5200   ORETAILERRECORD.LIMITCURRENCY     := PRETAILERROW.LIMITCURRENCY   ;  
 5201   ORETAILERRECORD.REIMBURSEMENT     := NVL(PRETAILERROW.REIMBURSEMENT, 0);  
 5202   ORETAILERRECORD.ANYPOSREFUND      := NVL(PRETAILERROW.ANYPOSREFUND, 0);  
 5203 
 5204   
 5205   IF PFILLGUID THEN
 5206     ORETAILERRECORD.GUID            := OBJECTUID.GETGUID(PRETAILERROW.OBJECTUID);
 5207   END IF;
 5208   
 5209 
 5210 EXCEPTION
 5211   WHEN OTHERS THEN
 5212     S.ERR('ReferenceRetailer.ConvertRowTypeToAPITypes');
 5213     RAISE;
 5214 END;
 5215 
 5216 
 5217 
 5218 PROCEDURE CONVERTAPITYPESTOROWTYPE(PRETAILERRECORD IN APITYPES.TYPERETAILERRECORD,
 5219                                    ORETAILERROW IN OUT NOCOPY TYPERETAILERROWTYPE)
 5220   IS
 5221 BEGIN
 5222 
 5223   ORETAILERROW.CODE              := PRETAILERRECORD.CODE            ;
 5224   ORETAILERROW.FICODE            := PRETAILERRECORD.FICODE          ;
 5225   ORETAILERROW.IDENT             := PRETAILERRECORD.IDENT           ;
 5226   ORETAILERROW.NAME              := PRETAILERRECORD.NAME            ;
 5227   ORETAILERROW.EXTERNAL_NAME     := PRETAILERRECORD.EXTERNAL_NAME   ;
 5228   ORETAILERROW.EXTERNAL_CITY     := PRETAILERRECORD.EXTERNAL_CITY   ;
 5229   ORETAILERROW.EXTERNAL_COUNTRY  := PRETAILERRECORD.EXTERNAL_COUNTRY;
 5230   ORETAILERROW.EXTERNAL_ZIPCODE  := PRETAILERRECORD.EXTERNAL_ZIPCODE;
 5231   ORETAILERROW.EXTERNAL_SICCODE  := PRETAILERRECORD.EXTERNAL_SICCODE;
 5232   ORETAILERROW.COUNTRY           := PRETAILERRECORD.COUNTRY         ;
 5233   ORETAILERROW.CITY              := PRETAILERRECORD.CITY            ;
 5234   ORETAILERROW.ADDRESS           := PRETAILERRECORD.ADDRESS         ;
 5235   ORETAILERROW.PHONES            := PRETAILERRECORD.PHONES          ;
 5236   ORETAILERROW.FAX               := PRETAILERRECORD.FAX             ;
 5237   ORETAILERROW.EMAIL             := PRETAILERRECORD.EMAIL           ;
 5238   ORETAILERROW.POSTALCODE        := PRETAILERRECORD.POSTALCODE      ;
 5239   ORETAILERROW.COUNTRY_CODE      := PRETAILERRECORD.COUNTRY_CODE    ;
 5240   ORETAILERROW.REGION_CODE       := PRETAILERRECORD.REGION_CODE     ;
 5241   ORETAILERROW.CITY_CODE         := PRETAILERRECORD.CITY_CODE       ;
 5242   ORETAILERROW.CODE_CLIENT       := PRETAILERRECORD.IDCLIENT        ;
 5243   ORETAILERROW.NOTE              := PRETAILERRECORD.NOTE            ;
 5244   ORETAILERROW.PROFILE           := PRETAILERRECORD.PROFILE         ;
 5245   ORETAILERROW.BRANCHPART        := PRETAILERRECORD.BRANCHPART      ;
 5246   ORETAILERROW.CREATEDATE        := PRETAILERRECORD.CREATEDATE      ;
 5247   ORETAILERROW.CREATECLERK       := PRETAILERRECORD.CREATECLERK     ;
 5248   ORETAILERROW.UPDATEDATE        := PRETAILERRECORD.UPDATEDATE      ;
 5249   ORETAILERROW.UPDATECLERK       := PRETAILERRECORD.UPDATECLERK     ;
 5250   ORETAILERROW.STREET            := PRETAILERRECORD.STREET          ;
 5251   ORETAILERROW.HOUSE             := PRETAILERRECORD.HOUSE           ;
 5252   ORETAILERROW.BUILDING          := PRETAILERRECORD.BUILDING        ;
 5253   ORETAILERROW.FRAME             := PRETAILERRECORD.FRAME           ;
 5254   ORETAILERROW.FLAT              := PRETAILERRECORD.FLAT            ;
 5255   ORETAILERROW.ISPROTOTYPE       := PRETAILERRECORD.ISPROTOTYPE     ;
 5256   ORETAILERROW.PROTOTYPE         := PRETAILERRECORD.PROTOTYPE       ;
 5257   ORETAILERROW.INACTIVE          := PRETAILERRECORD.INACTIVE        ;
 5258   ORETAILERROW.LOCATION          := PRETAILERRECORD.LOCATION        ;  
 5259   ORETAILERROW.MERCHANTID        := PRETAILERRECORD.MERCHANTID      ;  
 5260   
 5261   ORETAILERROW.PARENTCODE        := PRETAILERRECORD.PARENTCODE      ;  
 5262   ORETAILERROW.EXTERNAL_IDENT    := PRETAILERRECORD.EXTERNAL_IDENT  ;  
 5263   ORETAILERROW.LIMITGRPFO        := PRETAILERRECORD.LIMITGRPFO      ;  
 5264   ORETAILERROW.LIMITGRP          := PRETAILERRECORD.LIMITGRP        ;  
 5265   ORETAILERROW.LIMITCURRENCY     := PRETAILERRECORD.LIMITCURRENCY   ;  
 5266   ORETAILERROW.REIMBURSEMENT     := PRETAILERRECORD.REIMBURSEMENT   ;  
 5267   ORETAILERROW.ANYPOSREFUND      := PRETAILERRECORD.ANYPOSREFUND    ;  
 5268   
 5269   IF ORETAILERROW.OBJECTUID IS NULL AND PRETAILERRECORD.GUID IS NOT NULL THEN
 5270     ORETAILERROW.OBJECTUID := OBJECTUID.GETUIDBYGUID(PRETAILERRECORD.GUID);
 5271   END IF;
 5272   
 5273 EXCEPTION
 5274   WHEN OTHERS THEN
 5275     S.ERR('ReferenceRetailer.ConvertAPITypesToRowType');
 5276     RAISE;
 5277 END;
 5278 
 5279 
 5280 
 5281 PROCEDURE SETACCOUNT(PCODE IN NUMBER, PCURRENCY IN NUMBER, PREALACCOUNT IN VARCHAR, PACTIVEACCOUNT IN VARCHAR := NULL, PPASSIVEACCOUNT IN VARCHAR := NULL, PLOG BOOLEAN := FALSE) 
 5282   IS
 5283     ERR_ERROR            EXCEPTION;
 5284     VCONTEXTREC          ERR.TYPECONTEXTREC;
 5285     VCURRENTRETAILERROW  TREFERENCERETAILER%ROWTYPE;
 5286     VRETAILERROW         TREFERENCERETAILER%ROWTYPE;
 5287     VACCOUNTNO           TACCOUNT.ACCOUNTNO%TYPE;
 5288   BEGIN
 5289 
 5290     VCURRENTRETAILERROW := SROW;
 5291 
 5292     VRETAILERROW := READOBJECT(PCODE);
 5293 
 5294     IF (ERR.GETERRORCODE != 0) THEN
 5295       RAISE ERR_ERROR;
 5296     END IF;
 5297 
 5298     IF (PCURRENCY IS NULL) THEN
 5299       ERROR.RAISEUSER('Invalid currency');
 5300 
 5301     ELSIF (PREALACCOUNT IS NULL) THEN
 5302       ERROR.RAISEUSER('Invalid settlement account');
 5303 
 5304     ELSIF ((PACTIVEACCOUNT IS NULL AND PPASSIVEACCOUNT IS NOT NULL) OR
 5305            (PACTIVEACCOUNT IS NOT NULL AND PPASSIVEACCOUNT IS NULL)) THEN
 5306       ERROR.RAISEUSER('Invalid transit accounts');
 5307 
 5308     END IF;
 5309 
 5310     S.SAY('vRetailerRow.AccountGroupCode: '||VRETAILERROW.ACCOUNTGROUPCODE);
 5311 
 5312     IF (VRETAILERROW.ACCOUNTGROUPCODE IS NULL) THEN
 5313       VRETAILERROW.ACCOUNTGROUPCODE := ACCGROUP.GETNEWACCGROUPID;
 5314       ACCGROUP.CREATEACCOUNT(VRETAILERROW.ACCOUNTGROUPCODE, PREALACCOUNT, PCURRENCY);
 5315 
 5316       IF ((NVL(VRETAILERROW.HAVETRANSIT, 0) = 1 AND PACTIVEACCOUNT IS NULL AND PPASSIVEACCOUNT IS NULL) OR
 5317           (NVL(VRETAILERROW.HAVETRANSIT, 0) != 1 AND PACTIVEACCOUNT IS NOT NULL AND PPASSIVEACCOUNT IS NOT NULL)) THEN
 5318         ERROR.RAISEUSER('Invalid set of accounts');
 5319       END IF;
 5320 
 5321       IF (PACTIVEACCOUNT IS NOT NULL AND PPASSIVEACCOUNT IS NOT NULL) THEN
 5322         VRETAILERROW.ACC_ACT := ACCGROUP.GETNEWACCGROUPID;
 5323         ACCGROUP.CREATEACCOUNT(VRETAILERROW.ACC_ACT, PACTIVEACCOUNT, PCURRENCY);
 5324 
 5325         VRETAILERROW.ACC_PASS := ACCGROUP.GETNEWACCGROUPID;
 5326         ACCGROUP.CREATEACCOUNT(VRETAILERROW.ACC_PASS, PPASSIVEACCOUNT, PCURRENCY);
 5327 
 5328         VRETAILERROW.HAVETRANSIT := 1;
 5329       END IF;
 5330 
 5331       REFERENCERETAILER.UPDATEOBJECT(VRETAILERROW, PLOG); 
 5332 
 5333     ELSE
 5334 
 5335       VCONTEXTREC := ERR.GETCONTEXT;
 5336 
 5337       VACCOUNTNO := GETACCOUNT(PCODE, PCURRENCY, REAL_ACCOUNT);
 5338 
 5339       ERR.PUTCONTEXT(VCONTEXTREC);
 5340 
 5341       IF (VACCOUNTNO IS NOT NULL) THEN
 5342         ERROR.RAISEUSER('Set of accounts for currency '||PCURRENCY||' already defined');
 5343       END IF;
 5344 
 5345       IF ((NVL(VRETAILERROW.HAVETRANSIT, 0) = 1 AND PACTIVEACCOUNT IS NULL AND PPASSIVEACCOUNT IS NULL) OR
 5346           (NVL(VRETAILERROW.HAVETRANSIT, 0) != 1 AND PACTIVEACCOUNT IS NOT NULL AND PPASSIVEACCOUNT IS NOT NULL)) THEN
 5347         ERROR.RAISEUSER('Invalid set of accounts');
 5348       END IF;
 5349 
 5350       ACCGROUP.CREATEACCOUNT(VRETAILERROW.ACCOUNTGROUPCODE, PREALACCOUNT, PCURRENCY);
 5351 
 5352       IF (PACTIVEACCOUNT IS NOT NULL AND PPASSIVEACCOUNT IS NOT NULL) THEN
 5353         ACCGROUP.CREATEACCOUNT(VRETAILERROW.ACC_ACT, PACTIVEACCOUNT, PCURRENCY);
 5354         ACCGROUP.CREATEACCOUNT(VRETAILERROW.ACC_PASS, PPASSIVEACCOUNT, PCURRENCY);
 5355       END IF;
 5356 
 5357     END IF;
 5358 
 5359     SROW := VCURRENTRETAILERROW;
 5360 
 5361   EXCEPTION
 5362     WHEN ERR_ERROR THEN
 5363       S.ERR('ReferenceRetailer.SetAccount');
 5364       SROW := VCURRENTRETAILERROW;
 5365       ERROR.RAISEERROR(ERR.GETERRORCODE, ERR.GETTEXT);
 5366 
 5367     WHEN OTHERS THEN
 5368       S.ERR('ReferenceRetailer.SetAccount');
 5369       SROW := VCURRENTRETAILERROW;
 5370       RAISE;
 5371   END;
 5372 
 5373 
 5374 
 5375 FUNCTION UPDATEOBJECTUID(PCODE NUMBER, PGUID TYPES.GUID) RETURN NUMBER 
 5376   IS
 5377     PRAGMA AUTONOMOUS_TRANSACTION;
 5378 
 5379     CPROCNAME  CONSTANT VARCHAR(80) := 'ReferenceRetailer.UpdateObjectUID';
 5380     CBRANCH    CONSTANT NUMBER := SEANCE.GETBRANCH();
 5381     VOBJECTUID OBJECTUID.TYPEOBJECTUID;                                      
 5382   BEGIN
 5383 
 5384     S.SAY(CPROCNAME||'|Code: '||PCODE);
 5385 
 5386     VOBJECTUID := OBJECTUID.NEWUID(OBJECT_NAME, PCODE, PGUID => PGUID, PNOCOMMIT => TRUE);  
 5387 
 5388     UPDATE TREFERENCERETAILER SET OBJECTUID = VOBJECTUID WHERE BRANCH = CBRANCH AND CODE = PCODE;
 5389     COMMIT;
 5390 
 5391     RETURN VOBJECTUID;
 5392 
 5393   EXCEPTION
 5394     WHEN OTHERS THEN
 5395       ERROR.SAVE(CPROCNAME);
 5396       ROLLBACK;
 5397       RETURN NULL;
 5398   END;
 5399 
 5400 
 5401 
 5402 FUNCTION INTERNALGETUID(PCODE NUMBER, PGUID TYPES.GUID := NULL) RETURN NUMBER
 5403   IS
 5404     CPROCNAME   CONSTANT VARCHAR(80) := 'ReferenceRetailer.InternalGetUID';
 5405     CBRANCH     CONSTANT NUMBER := SEANCE.GETBRANCH();
 5406     VOBJECTUID  OBJECTUID.TYPEOBJECTUID;
 5407   BEGIN
 5408 
 5409     SELECT OBJECTUID INTO VOBJECTUID FROM TREFERENCERETAILER WHERE BRANCH = CBRANCH AND CODE = PCODE;
 5410 
 5411     IF (VOBJECTUID IS NULL) THEN
 5412       VOBJECTUID := UPDATEOBJECTUID(PCODE, PGUID);  
 5413     END IF;
 5414 
 5415     RETURN VOBJECTUID;
 5416 
 5417   EXCEPTION
 5418     WHEN OTHERS THEN
 5419       ERROR.SAVE(CPROCNAME);
 5420       RAISE;
 5421   END;
 5422 
 5423 
 5424 
 5425 FUNCTION GETUID(PCODE NUMBER) RETURN OBJECTUID.TYPEOBJECTUID
 5426   IS
 5427     CPROCNAME   CONSTANT VARCHAR(80) := 'ReferenceRetailer.GetUID';
 5428     VOBJECTUID  OBJECTUID.TYPEOBJECTUID;
 5429   BEGIN
 5430 
 5431     VOBJECTUID := INTERNALGETUID(PCODE);
 5432 
 5433     RETURN VOBJECTUID;
 5434 
 5435   EXCEPTION
 5436     WHEN OTHERS THEN
 5437       ERROR.SAVE(CPROCNAME);
 5438       ROLLBACK;
 5439       RAISE;
 5440   END;
 5441 
 5442 
 5443 
 5444 FUNCTION GETGUID(PCODE NUMBER) RETURN TYPES.GUID
 5445   IS
 5446     CPROCNAME  CONSTANT VARCHAR(80) := 'ReferenceRetailer.GetGUID';
 5447   BEGIN
 5448     RETURN OBJECTUID.GETGUID(GETUID(PCODE));
 5449   EXCEPTION
 5450     WHEN OTHERS THEN
 5451       ERROR.SAVE(CPROCNAME);
 5452       RAISE;
 5453   END;
 5454 
 5455 
 5456 
 5457 FUNCTION GETRETAILERRECORDBYUID(POBJECTUID  OBJECTUID.TYPEOBJECTUID) RETURN APITYPES.TYPERETAILERRECORD
 5458   IS
 5459     CPROCNAME  CONSTANT VARCHAR(80) := 'ReferenceRetailer.GetRetailerRecordByUID';
 5460     VROW       TREFERENCERETAILER%ROWTYPE;
 5461   BEGIN
 5462     S.SAY(CPROCNAME || ': start['||POBJECTUID||']');
 5463     SELECT * INTO VROW
 5464       FROM TREFERENCERETAILER
 5465       WHERE OBJECTUID = POBJECTUID;
 5466 
 5467     RETURN GETRETAILERRECORD(VROW.FICODE, VROW.IDENT);
 5468   EXCEPTION
 5469     WHEN NO_DATA_FOUND THEN
 5470       ERROR.SAVE(CPROCNAME);
 5471       ERROR.RAISEERROR(ERR.REFFI_UNDEFINED_RETAILER, '(ObjectUID: '||TO_CHAR(POBJECTUID)||')');
 5472     WHEN OTHERS THEN
 5473       ERROR.SAVE(CPROCNAME);
 5474       RAISE;
 5475   END;
 5476 
 5477 
 5478 
 5479 FUNCTION GETRETAILERRECORDBYGUID(PGUID  TYPES.GUID) RETURN APITYPES.TYPERETAILERRECORD
 5480   IS
 5481     CPROCNAME   CONSTANT VARCHAR(80) := 'ReferenceRetailer.GetRetailerRecordByGUID';
 5482     VOBJECTUID  OBJECTUID.TYPEOBJECTUID;
 5483     VROW        TREFERENCERETAILER%ROWTYPE;
 5484   BEGIN
 5485     VOBJECTUID := OBJECTUID.GETUIDBYGUID(PGUID);
 5486 
 5487     SELECT * INTO VROW
 5488       FROM TREFERENCERETAILER
 5489       WHERE OBJECTUID = VOBJECTUID;
 5490 
 5491     RETURN GETRETAILERRECORD(VROW.FICODE, VROW.IDENT);
 5492   EXCEPTION
 5493     WHEN NO_DATA_FOUND THEN
 5494       ERROR.SAVE(CPROCNAME);
 5495       ERROR.RAISEERROR(ERR.REFFI_UNDEFINED_RETAILER, '(GUID: '||SERVICE.GUID2STR(PGUID)||', ObjectUID: '||TO_CHAR(VOBJECTUID)||')');
 5496     WHEN OTHERS THEN
 5497       ERROR.SAVE(CPROCNAME);
 5498       RAISE;
 5499   END;
 5500 
 5501 
 5502 
 5503 FUNCTION GETUSERATTRIBUTESLIST (PCODE NUMBER) RETURN APITYPES.TYPEUSERPROPLIST
 5504   IS
 5505   BEGIN
 5506     RETURN OBJUSERPROPERTY.GETRECORD (OBJECT_NAME, GETUID(PCODE));
 5507   END;
 5508 
 5509 
 5510 
 5511 FUNCTION GETUSERATTRIBUTERECORD (PCODE NUMBER, PFIELDNAME VARCHAR) RETURN APITYPES.TYPEUSERPROPRECORD
 5512   IS
 5513   BEGIN
 5514     RETURN OBJUSERPROPERTY.GETFIELD (OBJECT_NAME, GETUID(PCODE), PFIELDNAME);
 5515   END;
 5516 
 5517 
 5518 
 5519 PROCEDURE SAVEUSERATTRIBUTESLIST(PCODE NUMBER, PLIST APITYPES.TYPEUSERPROPLIST, PCLEARPROPNOTINLIST BOOLEAN, PLOG BOOLEAN)  
 5520   IS
 5521     CPROCNAME   CONSTANT VARCHAR(80) := 'ReferenceRetailer.SaveUserAttributesList';
 5522     VROW        TREFERENCERETAILER%ROWTYPE;
 5523     VOBJECTTYPE NUMBER;                      
 5524   BEGIN
 5525 
 5526     VROW := READOBJECT(PCODE);
 5527 
 5528     IF (VROW.CODE IS NOT NULL) THEN
 5529       
 5530       IF (PLOG) THEN
 5531         VOBJECTTYPE := OBJECT.GETTYPE(OBJECT_NAME);
 5532       END IF;
 5533       
 5534 
 5535       OBJUSERPROPERTY.SAVERECORD(OBJECT_NAME, VROW.OBJECTUID, PLIST, PCLEARPROPNOTINLIST, NULL, VOBJECTTYPE, PCODE);  
 5536       UPDATEOBJECT(VROW);
 5537     END IF;
 5538 
 5539   EXCEPTION
 5540     WHEN OTHERS THEN
 5541       ERROR.SAVE(CPROCNAME);
 5542       RAISE;
 5543   END;
 5544 
 5545 
 5546 
 5547 FUNCTION DIALOGCREATEOBJECT(PFICODE IN NUMBER)  
 5548   RETURN NUMBER IS
 5549     CPROCNAME  CONSTANT VARCHAR2(80) := 'ReferenceRetailer.DialogCreateObject';
 5550     VDIALOGID  NUMBER;
 5551   BEGIN
 5552     SROW := NULL;
 5553 
 5554     VDIALOGID := DIALOGEDIT(REG_ADD, TRUE, PFICODE);  
 5555 
 5556     RETURN VDIALOGID;
 5557   EXCEPTION
 5558     WHEN OTHERS THEN
 5559       ERROR.SAVE(CPROCNAME);
 5560       RAISE;
 5561   END;
 5562 
 5563 
 5564 
 5565 FUNCTION DIALOGUPDATEOBJECT(PCODE IN NUMBER, PDIALOGMODE IN TYPEDIALOGMODE)
 5566   RETURN NUMBER IS
 5567     CPROCNAME CONSTANT VARCHAR2(80) := 'ReferenceRetailer.DialogUpdateObject';
 5568     VDIALOGID NUMBER;
 5569     VCANEDIT  BOOLEAN;
 5570   BEGIN
 5571     SROW := READOBJECT(PCODE);
 5572 
 5573     VCANEDIT := CHECKRIGHT(RIGHT_MODIFY);
 5574 
 5575     VDIALOGID := DIALOGEDIT(REG_EDIT, VCANEDIT, SROW.FICODE, PDIALOGMODE);  
 5576 
 5577     RETURN VDIALOGID;
 5578   EXCEPTION
 5579     WHEN OTHERS THEN
 5580       ERROR.SAVE(CPROCNAME);
 5581       RAISE;
 5582   END;
 5583 
 5584 
 5585 
 5586 FUNCTION DIALOGCOPYOBJECT(PCODE IN NUMBER)
 5587   RETURN NUMBER IS
 5588     CPROCNAME  CONSTANT VARCHAR2(80) := 'ReferenceRetailer.DialogCopyObject';
 5589     VDIALOGID  NUMBER;
 5590   BEGIN
 5591     SROW := READOBJECT(PCODE);
 5592 
 5593     VDIALOGID := DIALOGCOPY();
 5594 
 5595     RETURN VDIALOGID;
 5596   EXCEPTION
 5597     WHEN OTHERS THEN
 5598       ERROR.SAVE(CPROCNAME);
 5599       RAISE;
 5600   END;
 5601 
 5602 
 5603 
 5604 FUNCTION HAVECHILDOBJECT(PPARENTCODE IN NUMBER)
 5605   RETURN BOOLEAN IS
 5606     CPROCNAME  CONSTANT VARCHAR2(80) := 'ReferenceRetailer.HaveChildObject';
 5607     VCOUNT     NUMBER;
 5608     VBRANCH    NUMBER;  
 5609   BEGIN
 5610     VBRANCH := SEANCE.GETBRANCH();  
 5611 
 5612     SELECT COUNT(*) INTO VCOUNT
 5613       FROM TREFERENCERETAILER
 5614       WHERE BRANCH = VBRANCH  
 5615       START WITH PARENTCODE = PPARENTCODE
 5616       CONNECT BY PRIOR CODE = PARENTCODE;
 5617 
 5618     RETURN VCOUNT > 0;
 5619 
 5620   EXCEPTION
 5621     WHEN OTHERS THEN
 5622       ERROR.SAVE(CPROCNAME);
 5623       RAISE;
 5624   END;
 5625 
 5626 
 5627 
 5628 FUNCTION ISCHILDOBJECT(PPARENTCODE IN NUMBER,
 5629                        PCODE IN NUMBER)
 5630   RETURN BOOLEAN IS
 5631     CPROCNAME  CONSTANT VARCHAR2(80) := 'ReferenceRetailer.IsChildObject';
 5632     
 5633     VBRANCH    NUMBER;  
 5634   BEGIN
 5635     VBRANCH := SEANCE.GETBRANCH();  
 5636 
 5637     FOR I IN (SELECT *
 5638                 FROM TREFERENCERETAILER
 5639                 WHERE BRANCH = VBRANCH  
 5640                 START WITH PARENTCODE = PPARENTCODE
 5641                 CONNECT BY PRIOR CODE = PARENTCODE) LOOP
 5642 
 5643       IF (I.CODE = PCODE) THEN
 5644         RETURN TRUE;
 5645       END IF;
 5646 
 5647     END LOOP;
 5648 
 5649     RETURN FALSE;
 5650 
 5651   EXCEPTION
 5652     WHEN OTHERS THEN
 5653       ERROR.SAVE(CPROCNAME);
 5654       RAISE;
 5655   END;
 5656 
 5657 
 5658 
 5659 FUNCTION GETACCOUNTLISTOFPARENT(PCODE IN NUMBER)
 5660   RETURN APITYPES.TYPERETAILERACCLIST IS
 5661     CPROCNAME          CONSTANT VARCHAR2(80) := CPACKAGENAME || '.GetAccountListOfParent';
 5662     VEMPTYACCOUNTLIST  APITYPES.TYPERETAILERACCLIST;
 5663     VACCOUNTLIST       APITYPES.TYPERETAILERACCLIST;
 5664     VPARENTCODE        NUMBER;
 5665   BEGIN
 5666     VACCOUNTLIST := GETRETAILERACCLIST(PCODE);
 5667 
 5668     IF (VACCOUNTLIST.COUNT() > 0) THEN
 5669       RETURN VACCOUNTLIST;
 5670     ELSE
 5671       VPARENTCODE := READOBJECT(PCODE).PARENTCODE;
 5672 
 5673       WHILE (VPARENTCODE IS NOT NULL) LOOP
 5674         VACCOUNTLIST := GETRETAILERACCLIST(VPARENTCODE);
 5675 
 5676         IF (VACCOUNTLIST.COUNT() > 0) THEN
 5677           RETURN VACCOUNTLIST;
 5678         END IF;
 5679 
 5680         VPARENTCODE := READOBJECT(VPARENTCODE).PARENTCODE;
 5681       END LOOP;
 5682 
 5683     END IF;
 5684 
 5685     RETURN VEMPTYACCOUNTLIST;
 5686 
 5687   EXCEPTION
 5688     WHEN OTHERS THEN
 5689       ERROR.SAVE(CPROCNAME);
 5690       RETURN VEMPTYACCOUNTLIST;
 5691   END;
 5692 
 5693 
 5694 
 5695 FUNCTION GETACCOUNTOFPARENT(PCODE IN NUMBER,
 5696                             PCURRENCY IN NUMBER,
 5697                             PTYPE IN NUMBER)
 5698   RETURN VARCHAR IS
 5699     CPROCNAME    CONSTANT VARCHAR2(80) := CPACKAGENAME || '.GetAccountOfParent';
 5700     VACCOUNT     VARCHAR2(20);
 5701     VPARENTCODE  NUMBER;
 5702   BEGIN
 5703     VACCOUNT := GETACCOUNT(PCODE, PCURRENCY, PTYPE);
 5704 
 5705     IF (VACCOUNT IS NOT NULL) THEN
 5706       RETURN VACCOUNT;
 5707     ELSE
 5708       VPARENTCODE := READOBJECT(PCODE).PARENTCODE;
 5709 
 5710       WHILE (VPARENTCODE IS NOT NULL) LOOP
 5711         VACCOUNT := GETACCOUNT(VPARENTCODE, PCURRENCY, PTYPE);
 5712 
 5713         IF (VACCOUNT IS NOT NULL) THEN
 5714           RETURN VACCOUNT;
 5715         END IF;
 5716 
 5717         VPARENTCODE := READOBJECT(VPARENTCODE).PARENTCODE;
 5718       END LOOP;
 5719 
 5720     END IF;
 5721 
 5722     RETURN NULL;
 5723 
 5724   EXCEPTION
 5725     WHEN OTHERS THEN
 5726       ERROR.SAVE(CPROCNAME);
 5727       RETURN NULL;
 5728   END;
 5729 
 5730 
 5731 
 5732 FUNCTION GETPROFILEOFPARENT(PCODE IN NUMBER)
 5733   RETURN NUMBER IS
 5734     CPROCNAME    CONSTANT VARCHAR2(80) := CPACKAGENAME || '.GetProfileOfParent';
 5735     VPROFILE     NUMBER;
 5736     VPARENTCODE  NUMBER;
 5737   BEGIN
 5738     VPROFILE := READOBJECT(PCODE).PROFILE;
 5739 
 5740     IF (VPROFILE IS NOT NULL) THEN
 5741       RETURN VPROFILE;
 5742     ELSE
 5743       VPARENTCODE := READOBJECT(PCODE).PARENTCODE;
 5744 
 5745       WHILE (VPARENTCODE IS NOT NULL) LOOP
 5746         VPROFILE := READOBJECT(VPARENTCODE).PROFILE;
 5747 
 5748         IF (VPROFILE IS NOT NULL) THEN
 5749           RETURN VPROFILE;
 5750         END IF;
 5751 
 5752         VPARENTCODE := READOBJECT(VPARENTCODE).PARENTCODE;
 5753       END LOOP;
 5754 
 5755     END IF;
 5756 
 5757     RETURN NULL;
 5758 
 5759   EXCEPTION
 5760     WHEN OTHERS THEN
 5761       ERROR.SAVE(CPROCNAME);
 5762       RETURN NULL;
 5763   END;
 5764 
 5765 
 5766 
 5767 FUNCTION GETBRANCHPARTOFPARENT(PCODE IN NUMBER)
 5768   RETURN NUMBER IS
 5769     CPROCNAME    CONSTANT VARCHAR2(80) := CPACKAGENAME || '.GetBranchpartOfParent';
 5770     VBRANCHPART  NUMBER;
 5771     VPARENTCODE  NUMBER;
 5772   BEGIN
 5773     VBRANCHPART := READOBJECT(PCODE).BRANCHPART;
 5774 
 5775     IF (VBRANCHPART IS NOT NULL) THEN
 5776       RETURN VBRANCHPART;
 5777     ELSE
 5778       VPARENTCODE := READOBJECT(PCODE).PARENTCODE;
 5779 
 5780       WHILE (VPARENTCODE IS NOT NULL) LOOP
 5781         VBRANCHPART := READOBJECT(VPARENTCODE).BRANCHPART;
 5782 
 5783         IF (VBRANCHPART IS NOT NULL) THEN
 5784           RETURN VBRANCHPART;
 5785         END IF;
 5786 
 5787         VPARENTCODE := READOBJECT(VPARENTCODE).PARENTCODE;
 5788       END LOOP;
 5789 
 5790     END IF;
 5791 
 5792     RETURN NULL;
 5793 
 5794   EXCEPTION
 5795     WHEN OTHERS THEN
 5796       ERROR.SAVE(CPROCNAME);
 5797       RETURN NULL;
 5798   END;
 5799 
 5800 
 5801 
 5802 FUNCTION GETIDCLIENTOFPARENT(PCODE IN NUMBER)
 5803   RETURN NUMBER IS
 5804     CPROCNAME     CONSTANT VARCHAR2(80) := CPACKAGENAME || '.GetIdClientOfParent';
 5805     VCODE_CLIENT  NUMBER;
 5806     VPARENTCODE   NUMBER;
 5807   BEGIN
 5808     VCODE_CLIENT := READOBJECT(PCODE).CODE_CLIENT;
 5809 
 5810     IF (VCODE_CLIENT IS NOT NULL) THEN
 5811       RETURN VCODE_CLIENT;
 5812     ELSE
 5813       VPARENTCODE := READOBJECT(PCODE).PARENTCODE;
 5814 
 5815       WHILE (VPARENTCODE IS NOT NULL) LOOP
 5816         VCODE_CLIENT := READOBJECT(VPARENTCODE).CODE_CLIENT;
 5817 
 5818         IF (VCODE_CLIENT IS NOT NULL) THEN
 5819           RETURN VCODE_CLIENT;
 5820         END IF;
 5821 
 5822         VPARENTCODE := READOBJECT(VPARENTCODE).PARENTCODE;
 5823       END LOOP;
 5824 
 5825     END IF;
 5826 
 5827     RETURN NULL;
 5828 
 5829   EXCEPTION
 5830     WHEN OTHERS THEN
 5831       ERROR.SAVE(CPROCNAME);
 5832       RETURN NULL;
 5833   END;
 5834 
 5835 
 5836 
 5837 FUNCTION GETADDRESSINFOOFPARENT(PCODE IN NUMBER)
 5838   RETURN APITYPES.ADDRESSINFO IS
 5839     CPROCNAME          CONSTANT VARCHAR2(80) := CPACKAGENAME || '.GetAddressInfoOfParent';
 5840     VROW               TREFERENCERETAILER%ROWTYPE;
 5841     VADDRESSINFO       APITYPES.ADDRESSINFO;
 5842     VEMPTYADDRESSINFO  APITYPES.ADDRESSINFO;
 5843     VPARENTCODE        NUMBER;
 5844 
 5845     FUNCTION ISEMPTYADDRESSINFO(PROW IN TREFERENCERETAILER%ROWTYPE)
 5846       RETURN BOOLEAN IS
 5847         CPROCNAME  CONSTANT VARCHAR2(256) := CPACKAGENAME || '.GetAddressInfoOfParent.IsEmptyAddressInfo';
 5848       BEGIN
 5849         RETURN PROW.COUNTRY_CODE IS NULL AND
 5850                PROW.REGION_CODE IS NULL AND
 5851                PROW.CITY_CODE IS NULL AND
 5852                TRIM(PROW.ADDRESS) IS NULL AND
 5853                PROW.EXTERNAL_ZIPCODE IS NULL AND
 5854                TRIM(PROW.PHONES) IS NULL AND
 5855                TRIM(PROW.FAX) IS NULL AND
 5856                TRIM(PROW.EMAIL) IS NULL AND
 5857                PROW.STREET IS NULL AND
 5858                PROW.HOUSE IS NULL AND
 5859                PROW.BUILDING IS NULL AND
 5860                PROW.FRAME IS NULL AND
 5861                PROW.FLAT IS NULL;
 5862 
 5863       EXCEPTION
 5864         WHEN OTHERS THEN
 5865           ERROR.SAVE(CPROCNAME);
 5866           RAISE;
 5867       END;
 5868 
 5869     PROCEDURE CONVERTADDRESSINFOTOAPITYPES(PROW IN TREFERENCERETAILER%ROWTYPE,
 5870                                            OADDRESSINFOREC OUT APITYPES.ADDRESSINFO)
 5871       IS
 5872         CPROCNAME  CONSTANT VARCHAR2(256) := CPACKAGENAME || '.GetAddressInfoOfParent.ConvertAddressInfoToAPITypes';
 5873       BEGIN
 5874         OADDRESSINFOREC.CITY     := PROW.CITY_CODE;
 5875         OADDRESSINFOREC.COUNTRY  := PROW.COUNTRY_CODE;
 5876         OADDRESSINFOREC.REGION   := PROW.REGION_CODE;
 5877         OADDRESSINFOREC.ADDRESS  := SUBSTR(RTRIM(PROW.ADDRESS), 1, 200);
 5878         OADDRESSINFOREC.POSTAL   := PROW.EXTERNAL_ZIPCODE;
 5879         OADDRESSINFOREC.PHONE    := SUBSTR(RTRIM(PROW.PHONES), 1, 20);
 5880         OADDRESSINFOREC.FAX      := RTRIM(PROW.FAX);
 5881         OADDRESSINFOREC.EMAIL    := RTRIM(PROW.EMAIL);
 5882         OADDRESSINFOREC.STREET   := PROW.STREET;
 5883         OADDRESSINFOREC.HOUSE    := PROW.HOUSE;
 5884         OADDRESSINFOREC.BUILDING := PROW.BUILDING;
 5885         OADDRESSINFOREC.FRAME    := PROW.FRAME;
 5886         OADDRESSINFOREC.FLAT     := PROW.FLAT;
 5887 
 5888       EXCEPTION
 5889         WHEN OTHERS THEN
 5890           ERROR.SAVE(CPROCNAME);
 5891           RAISE;
 5892       END;
 5893 
 5894 
 5895   BEGIN
 5896     VROW := READOBJECT(PCODE);
 5897 
 5898     IF (NOT ISEMPTYADDRESSINFO(VROW)) THEN
 5899       CONVERTADDRESSINFOTOAPITYPES(VROW, VADDRESSINFO);
 5900       RETURN VADDRESSINFO;
 5901     ELSE
 5902       VPARENTCODE := READOBJECT(PCODE).PARENTCODE;
 5903 
 5904       WHILE (VPARENTCODE IS NOT NULL) LOOP
 5905         VROW := READOBJECT(VPARENTCODE);
 5906 
 5907         IF (NOT ISEMPTYADDRESSINFO(VROW)) THEN
 5908           CONVERTADDRESSINFOTOAPITYPES(VROW, VADDRESSINFO);
 5909           RETURN VADDRESSINFO;
 5910         END IF;
 5911 
 5912         VPARENTCODE := READOBJECT(VPARENTCODE).PARENTCODE;
 5913       END LOOP;
 5914 
 5915     END IF;
 5916 
 5917     RETURN VEMPTYADDRESSINFO;
 5918 
 5919   EXCEPTION
 5920     WHEN OTHERS THEN
 5921       ERROR.SAVE(CPROCNAME);
 5922       RETURN VEMPTYADDRESSINFO;
 5923   END;
 5924 
 5925 
 5926 
 5927 PROCEDURE GETGROUPACCOUNTOFPARENT(PCODE IN NUMBER,
 5928                                   PACCOUNTGROUPCODE OUT NUMBER,
 5929                                   PACC_ACT OUT NUMBER,
 5930                                   PACC_PASS OUT NUMBER,
 5931                                   PHAVETRANSIT OUT NUMBER)
 5932   IS
 5933     CPROCNAME CONSTANT VARCHAR2(128) := CPACKAGENAME || '.GetGroupAccountOfParent';
 5934     VROW      TREFERENCERETAILER%ROWTYPE;
 5935   BEGIN
 5936     ERR.SETERROR(0, CPROCNAME);
 5937 
 5938     VROW := READOBJECT(PCODE);
 5939 
 5940     ERROR.RAISEWHENERR();
 5941 
 5942 
 5943     IF (VROW.ACCOUNTGROUPCODE IS NULL) THEN
 5944       WHILE (VROW.PARENTCODE IS NOT NULL) LOOP
 5945         VROW := READOBJECT(VROW.PARENTCODE);
 5946 
 5947         ERROR.RAISEWHENERR();
 5948 
 5949         IF (VROW.ACCOUNTGROUPCODE IS NOT NULL) THEN
 5950           EXIT;
 5951         END IF;
 5952 
 5953       END LOOP;
 5954     END IF;
 5955 
 5956     PACCOUNTGROUPCODE := VROW.ACCOUNTGROUPCODE;
 5957     PACC_ACT          := VROW.ACC_ACT;
 5958     PACC_PASS         := VROW.ACC_PASS;
 5959     PHAVETRANSIT      := VROW.HAVETRANSIT;
 5960 
 5961   EXCEPTION
 5962     WHEN OTHERS THEN
 5963       ERROR.SAVE(CPROCNAME);
 5964       RAISE;
 5965   END;
 5966 
 5967 
 5968 
 5969 FUNCTION SELECTRETAILER(PFICODE IN NUMBER,
 5970                         PCODE IN NUMBER)
 5971   RETURN NUMBER IS
 5972     CPROCNAME CONSTANT VARCHAR2(80) := CPACKAGENAME || '.SelectRetailer';
 5973     VDIALOGID NUMBER;
 5974     VCODE     NUMBER;
 5975   BEGIN
 5976     VDIALOGID := DIALOGREFERENCE(PFICODE, CDMSELECT, PCODE);
 5977 
 5978     DIALOG.EXECDIALOG(VDIALOGID);
 5979 
 5980     VCODE := DIALOG.GETNUMBER(VDIALOGID, 'Code');
 5981 
 5982     DIALOG.DESTROY(VDIALOGID);
 5983 
 5984     RETURN VCODE;
 5985   EXCEPTION
 5986     WHEN OTHERS THEN
 5987       ERROR.SAVE(CPROCNAME);
 5988       RAISE;
 5989   END;
 5990 
 5991 
 5992 
 5993 FUNCTION GETACTIVE(PCODE IN NUMBER)
 5994   RETURN NUMBER IS
 5995     CPROCNAME CONSTANT VARCHAR2(80) := CPACKAGENAME || '.GetActive';
 5996     VROW      TREFERENCERETAILER%ROWTYPE;  
 5997     VBRANCH   NUMBER;  
 5998   BEGIN
 5999     ERR.SETERROR(0, CPROCNAME);
 6000 
 6001     VBRANCH := SEANCE.GETBRANCH();  
 6002 
 6003     
 6004     BEGIN
 6005       SELECT * INTO VROW
 6006         FROM TREFERENCERETAILER
 6007         WHERE BRANCH = VBRANCH  
 6008           AND CODE   = PCODE;
 6009 
 6010       RETURN SERVICE.IIF(NVL(VROW.INACTIVE, CACTIVE) = CACTIVE AND NVL(VROW.PARENTINACTIVE, CACTIVE) = CACTIVE, CACTIVE, CINACTIVE);
 6011 
 6012     EXCEPTION
 6013       WHEN NO_DATA_FOUND THEN
 6014         ERR.SETERROR(ERR.REFFI_UNDEFINED_RETAILER, CPROCNAME);
 6015         ERROR.RAISEWHENERR();
 6016     END;
 6017     
 6018 
 6019   EXCEPTION
 6020     WHEN OTHERS THEN
 6021       ERROR.SAVE(CPROCNAME);
 6022       RETURN NULL;
 6023   END;
 6024 
 6025 
 6026 
 6027 FUNCTION GETINACTIVEEDIT(PPARENTCODE IN NUMBER)
 6028   RETURN BOOLEAN IS
 6029     CPROCNAME CONSTANT VARCHAR2(80) := CPACKAGENAME || '.GetInactiveEdit';
 6030     VINACTIVE NUMBER;
 6031   BEGIN
 6032     VINACTIVE := GETACTIVE(PPARENTCODE);
 6033 
 6034     ERROR.RAISEWHENERR();
 6035 
 6036     RETURN VINACTIVE = CACTIVE;
 6037   EXCEPTION
 6038     WHEN OTHERS THEN
 6039       ERROR.SAVE(CPROCNAME);
 6040       RAISE;
 6041   END;
 6042 
 6043 
 6044 
 6045 FUNCTION GETACTIVE(PFIID IN VARCHAR,
 6046                    PIDENT IN VARCHAR)
 6047   RETURN NUMBER IS
 6048     CPROCNAME CONSTANT VARCHAR2(80) := CPACKAGENAME || '.GetActive';
 6049     VFICODE   TREFERENCERETAILER.FICODE%TYPE;
 6050     VCODE     TREFERENCERETAILER.CODE%TYPE;
 6051     VBRANCH   NUMBER;  
 6052   BEGIN
 6053     VBRANCH := SEANCE.GETBRANCH();  
 6054 
 6055     VFICODE := REFERENCEFI.GETCODEBYFIID(PFIID);
 6056 
 6057     ERROR.RAISEWHENERR();
 6058 
 6059     SELECT CODE
 6060       INTO VCODE
 6061       FROM TREFERENCERETAILER
 6062       WHERE BRANCH = VBRANCH  
 6063         AND FICODE = VFICODE
 6064         AND IDENT  = PIDENT;
 6065 
 6066      RETURN GETACTIVE(VCODE);
 6067 
 6068   EXCEPTION
 6069     WHEN NO_DATA_FOUND THEN
 6070       ERROR.SAVE(CPROCNAME, ERR.REFFI_UNDEFINED_RETAILER);
 6071       RETURN NULL;
 6072     WHEN OTHERS THEN
 6073       ERROR.SAVE(CPROCNAME);
 6074       RETURN NULL;
 6075   END;
 6076 
 6077 
 6078 
 6079 PROCEDURE SETACTIVE(PCODE IN NUMBER, PINACTIVE IN NUMBER)
 6080   IS
 6081     CPROCNAME   CONSTANT VARCHAR2(80) := CPACKAGENAME || '.SetActive';
 6082     VCURRENTROW TREFERENCERETAILER%ROWTYPE;
 6083     VROW        TREFERENCERETAILER%ROWTYPE;
 6084   BEGIN
 6085     VCURRENTROW := SROW;
 6086 
 6087     VROW := READOBJECT(PCODE);
 6088 
 6089     ERROR.RAISEWHENERR();
 6090 
 6091     IF (VROW.PARENTCODE IS NOT NULL AND
 6092         NOT GETINACTIVEEDIT(VROW.PARENTCODE)) THEN
 6093       ERR.SETERROR(ERR.UE_VALUE_INCORRECT, CPROCNAME);
 6094       ERROR.RAISEWHENERR();
 6095     END IF;
 6096 
 6097     IF (PINACTIVE NOT IN (CACTIVE, CINACTIVE)) THEN
 6098       ERR.SETERROR(ERR.UE_VALUE_INCORRECT, CPROCNAME,
 6099                    '"Inactive retailer" flag');
 6100       ERROR.RAISEWHENERR();
 6101     END IF;
 6102 
 6103     VROW.INACTIVE := PINACTIVE;
 6104 
 6105     UPDATEOBJECT(VROW);
 6106 
 6107     ERROR.RAISEWHENERR();
 6108 
 6109     SROW := VCURRENTROW;
 6110 
 6111   EXCEPTION
 6112     WHEN OTHERS THEN
 6113       ERROR.SAVE(CPROCNAME);
 6114       SROW := VCURRENTROW;
 6115       RAISE;
 6116   END;
 6117 
 6118 
 6119 
 6120 PROCEDURE SETACTIVE(PFIID IN VARCHAR,
 6121                     PIDENT IN VARCHAR,
 6122                     PINACTIVE IN NUMBER)
 6123   IS
 6124     CPROCNAME CONSTANT VARCHAR2(80) := CPACKAGENAME || '.SetActive';
 6125     VFICODE   TREFERENCEFI.CODE%TYPE;
 6126     VCODE     TREFERENCERETAILER.CODE%TYPE;
 6127   BEGIN
 6128     VFICODE := REFERENCEFI.GETCODEBYFIID(PFIID);
 6129 
 6130     ERROR.RAISEWHENERR();
 6131 
 6132     VCODE := GETCODEBYIDENT(VFICODE, PIDENT);
 6133 
 6134     ERROR.RAISEWHENERR();
 6135 
 6136     SETACTIVE(VCODE, PINACTIVE);  
 6137 
 6138   EXCEPTION
 6139     WHEN OTHERS THEN
 6140       ERROR.SAVE(CPROCNAME);
 6141       RAISE;
 6142   END;
 6143 
 6144 
 6145 
 6146 FUNCTION ISDEFAULT(PCODE IN NUMBER)
 6147   RETURN BOOLEAN IS
 6148     CPROCNAME CONSTANT VARCHAR2(80) := CPACKAGENAME || '.IsDefault';
 6149     VIDENT    TREFERENCERETAILER.IDENT%TYPE;
 6150   BEGIN
 6151     ERR.SETERROR(0, CPROCNAME);
 6152 
 6153     VIDENT := GETIDENT(PCODE);
 6154 
 6155     IF (ERR.GETERRORCODE() = 0) THEN
 6156       RETURN VIDENT = ' ';
 6157     ELSE
 6158       ERROR.RAISEWHENERR();
 6159     END IF;
 6160 
 6161   EXCEPTION
 6162     WHEN OTHERS THEN
 6163       ERROR.SAVE(CPROCNAME);
 6164       RAISE;
 6165   END;
 6166 
 6167 
 6168 
 6169 FUNCTION GETACTIVEBYDATE(PCODE IN NUMBER,
 6170                          POPERDATE IN DATE)
 6171   RETURN NUMBER IS
 6172 
 6173     TYPE TYPELOGPARAMSREC IS RECORD
 6174     (
 6175       PROPERTY TOBJECTLOGPARAM.PROPERTY%TYPE,
 6176       VALUE    TOBJECTLOGPARAM.VALUE%TYPE
 6177     );
 6178 
 6179     TYPE TYPEOBJECTINFO IS RECORD
 6180     (
 6181       CODE       TREFERENCERETAILER.PARENTCODE%TYPE,
 6182       PARENTCODE TREFERENCERETAILER.PARENTCODE%TYPE,
 6183       INACTIVE   TREFERENCERETAILER.INACTIVE%TYPE
 6184     );
 6185     TYPE TYPEOBJECTINFOLIST IS TABLE OF TYPEOBJECTINFO INDEX BY BINARY_INTEGER;
 6186 
 6187     SUBTYPE TYPEPROPERTYVALUE IS TOBJECTLOGPARAM.PROPERTY%TYPE;
 6188     CPVINACTIVE   CONSTANT TYPEPROPERTYVALUE := 'INACTIVE';
 6189     CPVPARENTCODE CONSTANT TYPEPROPERTYVALUE := 'PARENTCODE';
 6190 
 6191     CPROCNAME       CONSTANT VARCHAR2(64) := CPACKAGENAME || '.GetActiveByDate';
 6192 
 6193     VBRANCH         NUMBER;
 6194     VOBJECTTYPE     NUMBER;
 6195     VOBJECTINFO     TYPEOBJECTINFO;
 6196     VOBJECTINFOLIST TYPEOBJECTINFOLIST;
 6197     I               PLS_INTEGER;
 6198     VINACTIVE       TREFERENCERETAILER.INACTIVE%TYPE;
 6199   
 6200   FUNCTION GETLOGPARAMS(PCODE IN NUMBER,
 6201                         POPERDATE IN DATE,
 6202                         PPROPERTY IN VARCHAR)
 6203     RETURN TYPELOGPARAMSREC IS
 6204       CSUBPROCNAME  CONSTANT VARCHAR2(128) := CPROCNAME || '.GetLogParams';
 6205       VLOGPARAMSREC TYPELOGPARAMSREC;
 6206       VKEYOBJECT    TOBJECTLOG.KEYOBJECT%TYPE;
 6207       VACTION       TOBJECTLOG.ACTION%TYPE;
 6208 
 6209       CURSOR CRETAILERLOG IS
 6210         SELECT /*+ FIRST_ROWS(1) */ P.*
 6211           FROM TOBJECTLOG L, TOBJECTLOGPARAM P
 6212           WHERE L.BRANCH     = VBRANCH
 6213             AND L.TYPEOBJECT = VOBJECTTYPE
 6214             AND L.KEYOBJECT  = VKEYOBJECT
 6215             AND L.OPERDATE   > POPERDATE
 6216             AND L.ACTION     = VACTION
 6217             AND P.BRANCH     = L.BRANCH
 6218             AND P.SYSTEMDATE = L.SYSTEMDATE
 6219             AND P.NO         = L.NO
 6220             AND UPPER(P.PROPERTY) = PPROPERTY
 6221           ORDER BY  L.NO; 
 6222     BEGIN
 6223 
 6224       VKEYOBJECT := TO_CHAR(PCODE);
 6225       VACTION := A4MLOG.ACT_CHANGE;
 6226 
 6227       FOR I IN CRETAILERLOG LOOP
 6228         VLOGPARAMSREC.PROPERTY := UPPER(I.PROPERTY);
 6229         VLOGPARAMSREC.VALUE    := I.VALUE;
 6230         EXIT;
 6231       END LOOP;
 6232 
 6233       RETURN VLOGPARAMSREC;
 6234 
 6235     EXCEPTION
 6236       WHEN OTHERS THEN
 6237         ERROR.SAVE(CSUBPROCNAME);
 6238         RAISE;
 6239     END;
 6240   
 6241   FUNCTION GETOBJECTINFO(PCODE IN NUMBER,
 6242                          POPERDATE IN DATE)
 6243     RETURN TYPEOBJECTINFO IS
 6244       CSUBPROCNAME  CONSTANT VARCHAR2(128) := CPROCNAME || '.GetObjectInfo';
 6245       VCURRENTROW   TREFERENCERETAILER%ROWTYPE;
 6246       VROW          TREFERENCERETAILER%ROWTYPE;
 6247 
 6248       VOBJECTINFO   TYPEOBJECTINFO;
 6249       VLOGPARAMSREC TYPELOGPARAMSREC;
 6250 
 6251       VINACTIVE     TREFERENCERETAILER.INACTIVE%TYPE;
 6252       VPARENTCODE   TREFERENCERETAILER.PARENTCODE%TYPE;
 6253 
 6254       
 6255       
 6256      FUNCTION GETINACTIVEFROMRETAILERLOG (PCODE IN NUMBER, POPERDATE IN DATE) RETURN NUMBER IS
 6257        CSUB2PROCNAME CONSTANT VARCHAR2(200) := CSUBPROCNAME || '.GetInactiveFromRetailerLog';
 6258        VEVENTINACTIVE TREFERENCERETAILER.INACTIVE%TYPE;  
 6259        VINACTIVE      TREFERENCERETAILER.INACTIVE%TYPE;
 6260      BEGIN
 6261         VEVENTINACTIVE := RETAILEREVENTLOG.GETPREVEVENTDATA(PCODE,
 6262                                                             RETAILEREVENTLOG.CEVUPDATE,
 6263                                                             RETAILEREVENTLOG.CAVINACTIVE,
 6264                                                             POPERDATE,
 6265                                                             TRUE);
 6266         S.SAY(CSUB2PROCNAME || ': PrevEventInactive='||VEVENTINACTIVE);
 6267 
 6268         IF VEVENTINACTIVE IS NOT NULL THEN
 6269           VINACTIVE := VEVENTINACTIVE;
 6270           S.SAY(CSUB2PROCNAME || ': Inactive(by previous event log)='||VINACTIVE);
 6271         ELSE
 6272 
 6273           VEVENTINACTIVE := RETAILEREVENTLOG.GETEVENTDATA(PCODE, RETAILEREVENTLOG.CEVUPDATE, RETAILEREVENTLOG.CAVINACTIVE, POPERDATE);
 6274           S.SAY(CSUB2PROCNAME || ': NextEventInactive='||VEVENTINACTIVE);
 6275 
 6276           IF (VEVENTINACTIVE IS NOT NULL) THEN
 6277             VINACTIVE := SERVICE.IIF(VEVENTINACTIVE = CINACTIVE, CACTIVE, CINACTIVE);                                                    
 6278             S.SAY(CSUB2PROCNAME || ': Inactive(by next event log)='||VINACTIVE);
 6279           END IF;
 6280         END IF;
 6281        RETURN VINACTIVE;
 6282      EXCEPTION
 6283        WHEN OTHERS THEN
 6284          ERROR.SAVE(CSUB2PROCNAME);
 6285          RAISE;
 6286      END;
 6287       
 6288      
 6289     BEGIN
 6290       ERR.SETERROR(0, CSUBPROCNAME);
 6291 
 6292       VCURRENTROW := SROW;
 6293 
 6294       VROW := READOBJECT(PCODE);
 6295 
 6296       SROW := VCURRENTROW;
 6297 
 6298       ERROR.RAISEWHENERR();
 6299 
 6300       S.SAY(CSUBPROCNAME || ': Code: ' || VROW.CODE || ', CreateDate: ' || TO_CHAR(TRUNC(VROW.CREATEDATE), 'dd.mm.yyyy') || ', OperDate: ' || TO_CHAR(POPERDATE, 'dd.mm.yyyy'));
 6301 
 6302       IF (TRUNC(VROW.CREATEDATE) <= POPERDATE) THEN
 6303         VINACTIVE := GETINACTIVEFROMRETAILERLOG (PCODE, POPERDATE); 
 6304         S.SAY(CSUBPROCNAME || ': Inactive (by object log)='||VINACTIVE);
 6305 
 6306         VINACTIVE := COALESCE(VINACTIVE, GETACTIVE(VROW.INACTIVE, VROW.PARENTINACTIVE));
 6307         S.SAY(CSUBPROCNAME || ': Inactive (object log, cuurent, parent)='||VINACTIVE);
 6308 
 6309         IF VINACTIVE IS NULL THEN 
 6310           VLOGPARAMSREC := GETLOGPARAMS(PCODE, POPERDATE, CPVINACTIVE);
 6311 
 6312           IF (VLOGPARAMSREC.PROPERTY = CPVINACTIVE) THEN
 6313             VINACTIVE := SERVICE.IIF(HTOOLS.S2B(VLOGPARAMSREC.VALUE), REFERENCERETAILER.CINACTIVE, REFERENCERETAILER.CACTIVE);
 6314             S.SAY(CSUBPROCNAME || ': Inactive (by systemeventlog)='||VINACTIVE);
 6315           END IF;
 6316 
 6317           VPARENTCODE := VROW.PARENTCODE;
 6318 
 6319           VLOGPARAMSREC := GETLOGPARAMS(PCODE, POPERDATE, CPVPARENTCODE);
 6320 
 6321           IF (VLOGPARAMSREC.PROPERTY = CPVPARENTCODE) THEN
 6322             VPARENTCODE := TO_NUMBER(VLOGPARAMSREC.VALUE);
 6323           END IF;
 6324         END IF;
 6325 
 6326         VOBJECTINFO.CODE       := PCODE;
 6327         VOBJECTINFO.INACTIVE   := VINACTIVE;
 6328         VOBJECTINFO.PARENTCODE := VPARENTCODE;
 6329       ELSE
 6330         ERR.SETERROR(ERR.REFFI_UNDEFINED_RETAILER, CSUBPROCNAME);
 6331         ERROR.RAISEWHENERR();
 6332       END IF;
 6333 
 6334       S.SAY(CSUBPROCNAME || ': return '||VOBJECTINFO.INACTIVE);
 6335       RETURN VOBJECTINFO;
 6336 
 6337     EXCEPTION
 6338       WHEN OTHERS THEN
 6339         ERROR.SAVE(CSUBPROCNAME);
 6340         RAISE;
 6341     END;
 6342 
 6343   
 6344 
 6345   BEGIN
 6346     S.SAY(CPROCNAME || ': start ['||PCODE||', '||TO_CHAR(POPERDATE, 'dd.mm.yyyy')||']');
 6347 
 6348     VBRANCH := SEANCE.GETBRANCH();
 6349     VOBJECTTYPE := OBJECT.GETTYPE(OBJECT_NAME);
 6350 
 6351     VOBJECTINFO := GETOBJECTINFO(PCODE, POPERDATE);
 6352 
 6353     VOBJECTINFOLIST(VOBJECTINFOLIST.COUNT() + 1) := VOBJECTINFO;
 6354 
 6355     I := VOBJECTINFOLIST.FIRST();
 6356 
 6357     WHILE (VOBJECTINFOLIST(I).PARENTCODE IS NOT NULL) LOOP
 6358 
 6359       VOBJECTINFO := GETOBJECTINFO(VOBJECTINFOLIST(I).PARENTCODE, POPERDATE);
 6360 
 6361       VOBJECTINFOLIST(VOBJECTINFOLIST.COUNT() + 1) := VOBJECTINFO;
 6362 
 6363       I := VOBJECTINFOLIST.LAST();
 6364     END LOOP;
 6365 
 6366     I := VOBJECTINFOLIST.LAST();
 6367 
 6368     VINACTIVE := CACTIVE;
 6369 
 6370     WHILE (I IS NOT NULL) LOOP
 6371       S.SAY(CPROCNAME || ': i=' || I || ', Code=' || VOBJECTINFOLIST(I).CODE
 6372                      || ', Inactive='   || VOBJECTINFOLIST(I).INACTIVE
 6373                      || ', ParentCode=' || VOBJECTINFOLIST(I).PARENTCODE);
 6374 
 6375       VINACTIVE := HTOOLS.MAX_(VINACTIVE, VOBJECTINFOLIST(I).INACTIVE);
 6376 
 6377       I := VOBJECTINFOLIST.PRIOR(I);
 6378     END LOOP;
 6379 
 6380     S.SAY(CPROCNAME || ': return '||VINACTIVE);
 6381 
 6382     RETURN VINACTIVE;
 6383 
 6384   EXCEPTION
 6385     WHEN OTHERS THEN
 6386       ERROR.SAVE(CPROCNAME);
 6387       RAISE;
 6388   END;
 6389 
 6390 
 6391 
 6392 FUNCTION GETMERCHANTID (PCODE IN NUMBER) RETURN VARCHAR
 6393   IS
 6394     CPROCNAME   CONSTANT VARCHAR2(64) := CPACKAGENAME || '.GetMerchantId';
 6395     CBRANCH     CONSTANT NUMBER := SEANCE.GETBRANCH();
 6396     VMERCHANTID TREFERENCERETAILER.MERCHANTID%TYPE;
 6397   BEGIN
 6398 
 6399     SELECT MERCHANTID
 6400       INTO VMERCHANTID
 6401       FROM TREFERENCERETAILER
 6402       WHERE BRANCH = CBRANCH
 6403         AND CODE   = PCODE;
 6404 
 6405     RETURN VMERCHANTID;
 6406 
 6407   EXCEPTION
 6408     WHEN NO_DATA_FOUND THEN
 6409       ERR.SETERROR(ERR.REFFI_UNDEFINED_RETAILER, CPROCNAME);
 6410       RETURN NULL;
 6411     WHEN OTHERS THEN
 6412       ERROR.SAVE(CPROCNAME);
 6413       RAISE;
 6414   END;
 6415 
 6416 
 6417 
 6418 PROCEDURE SETMERCHANTID (PCODE IN NUMBER, PMERCHANTID IN VARCHAR)
 6419   IS
 6420     CPROCNAME CONSTANT VARCHAR2(64) := CPACKAGENAME || '.SetMerchantId';
 6421     CBRANCH CONSTANT NUMBER := SEANCE.GETBRANCH();
 6422   BEGIN
 6423 
 6424     UPDATE TREFERENCERETAILER
 6425       SET MERCHANTID = PMERCHANTID
 6426       WHERE BRANCH   = CBRANCH
 6427         AND CODE     = PCODE;
 6428 
 6429   EXCEPTION
 6430     WHEN OTHERS THEN
 6431       ERROR.SAVE(CPROCNAME);
 6432       RAISE;
 6433   END;
 6434 
 6435 
 6436 
 6437 FUNCTION GETCODEBYEXTERNAL_IDENT (PEXTERNAL_IDENT IN VARCHAR) RETURN NUMBER
 6438   IS
 6439     CPROCNAME CONSTANT VARCHAR2(64) := CPACKAGENAME || '.GetCodeByExternal_Ident';
 6440     CBRANCH CONSTANT NUMBER := SEANCE.GETBRANCH();
 6441     VCODE     TREFERENCERETAILER.CODE%TYPE;
 6442   BEGIN
 6443 
 6444     SELECT CODE
 6445       INTO VCODE
 6446       FROM TREFERENCERETAILER
 6447       WHERE BRANCH = CBRANCH
 6448         AND UPPER(EXTERNAL_IDENT) = UPPER(PEXTERNAL_IDENT);
 6449 
 6450     RETURN VCODE;
 6451 
 6452   EXCEPTION
 6453     WHEN NO_DATA_FOUND THEN
 6454       ERR.SETERROR(ERR.REFFI_UNDEFINED_RETAILER, CPROCNAME);
 6455       RETURN NULL;
 6456     WHEN OTHERS THEN
 6457       ERROR.SAVE(CPROCNAME);
 6458       RAISE;
 6459   END;
 6460 
 6461 
 6462 
 6463 FUNCTION GETCHILDRETAILERLIST (PFIID IN NUMBER, PRETIDENT IN VARCHAR) RETURN APITYPES.TYPERETAILERLIST
 6464   IS
 6465     CBRANCH CONSTANT NUMBER := SEANCE.GETBRANCH();
 6466     VCODE   TREFERENCERETAILER.CODE%TYPE;
 6467     VCOUNT  NUMBER;
 6468     VRECORD APITYPES.TYPERETAILERRECORD;
 6469     VLIST   APITYPES.TYPERETAILERLIST;
 6470   BEGIN
 6471 
 6472     VCODE := GETCODEBYIDENT(PFIID, PRETIDENT);
 6473     S.SAY('vCode = ' || VCODE);
 6474 
 6475     IF (VCODE IS NULL) THEN
 6476       ERROR.RAISEWHENERR;
 6477     END IF;
 6478 
 6479     VCOUNT := 0;
 6480     FOR I IN (SELECT *
 6481                 FROM TREFERENCERETAILER
 6482                 WHERE BRANCH = CBRANCH
 6483                 START WITH PARENTCODE = VCODE
 6484                 CONNECT BY PRIOR CODE = PARENTCODE) LOOP
 6485 
 6486       VRECORD := NULL;
 6487       CONVERTROWTYPETOAPITYPES(I, VRECORD);
 6488 
 6489       VCOUNT := VCOUNT + 1;
 6490       VLIST(VCOUNT) := VRECORD;
 6491     END LOOP;
 6492     S.SAY('vCount = ' || VCOUNT);
 6493 
 6494     RETURN VLIST;
 6495 
 6496   EXCEPTION
 6497     WHEN OTHERS THEN
 6498       IF (ERR.GETERRORCODE != 0) THEN
 6499         ERR.SETERROR(SQLCODE, 'ReferenceRetailer.GetChildRetailerList');
 6500       END IF;
 6501       VLIST.DELETE;
 6502       RETURN VLIST;
 6503   END;
 6504 
 6505 
 6506 
 6507 PROCEDURE FILLCHILDLIST(PDIALOGID IN NUMBER, PCODE IN NUMBER)
 6508   IS
 6509     VBRANCH NUMBER;
 6510 
 6511     CURSOR CCHILD IS
 6512       SELECT *
 6513         FROM TREFERENCERETAILER
 6514         WHERE BRANCH = VBRANCH
 6515           AND PARENTCODE = PCODE;
 6516 
 6517   BEGIN
 6518     VBRANCH := SEANCE.GETBRANCH;
 6519 
 6520     DIALOG.LISTCLEAR(PDIALOGID, 'ChildList');
 6521 
 6522     FOR I IN CCHILD LOOP
 6523       DIALOG.LISTADDRECORD(PDIALOGID, 'ChildList', I.CODE || '~' || I.IDENT || '~' || I.NAME || '~');
 6524     END LOOP;
 6525 
 6526   EXCEPTION
 6527     WHEN OTHERS THEN
 6528       ERROR.SAVE(CPACKAGENAME || '.FillChildList');
 6529       RAISE;
 6530   END;  
 6531 
 6532 
 6533 
 6534 FUNCTION DIALOGCHILDLIST(PCODE IN NUMBER) RETURN NUMBER
 6535   IS
 6536     CPROCNAME               CONSTANT VARCHAR2(100) := CPACKAGENAME || '.DialogChildList'; 
 6537     CEVENTHANDLERMETHODNAME CONSTANT VARCHAR2(100) := CPACKAGENAME || '.DialogChildListEH';
 6538     CDIALOGWIDTH            CONSTANT PLS_INTEGER := 80;
 6539     CDIALOGHEIGHT           CONSTANT PLS_INTEGER := 12;
 6540     CBUTTONWIDTH            CONSTANT PLS_INTEGER := 12;
 6541 
 6542     VDIALOGCAPTION          VARCHAR2(64);
 6543     VDIALOGID               NUMBER;
 6544   BEGIN
 6545     VDIALOGCAPTION := 'List of child retailers of retailer '||PCODE;
 6546 
 6547     VDIALOGID := DIALOG.NEW(VDIALOGCAPTION, 0, 0, CDIALOGWIDTH, CDIALOGHEIGHT, PEXTID => CPROCNAME); 
 6548       
 6549 
 6550     DIALOG.LIST(VDIALOGID, 'ChildList', 2, 2, CDIALOGWIDTH - 5, CDIALOGHEIGHT - 5, '');
 6551       DIALOG.LISTADDFIELD(VDIALOGID, 'ChildList', 'Code',  'N', 10, 0);
 6552       DIALOG.LISTADDFIELD(VDIALOGID, 'ChildList', 'Ident', 'C', 20, 1);
 6553       DIALOG.LISTADDFIELD(VDIALOGID, 'ChildList', 'Name',  'C', 40, 1);
 6554 
 6555       DIALOG.SETCAPTION(VDIALOGID, 'ChildList', 'ID~Name~');
 6556       DIALOG.SETITEMPRE(VDIALOGID, 'ChildList', CEVENTHANDLERMETHODNAME);
 6557 
 6558     DIALOG.BUTTON(VDIALOGID, 'btnCancel', (CDIALOGWIDTH-CBUTTONWIDTH)/2, CDIALOGHEIGHT-1, CBUTTONWIDTH, 'Exit', DIALOG.CM_CANCEL);
 6559 
 6560    FILLCHILDLIST(VDIALOGID, PCODE);
 6561 
 6562    RETURN VDIALOGID;
 6563 
 6564   EXCEPTION
 6565     WHEN OTHERS THEN
 6566       ERROR.SAVE(CPROCNAME); 
 6567       RAISE;
 6568   END;
 6569 
 6570 
 6571 
 6572 PROCEDURE DIALOGCHILDLISTEH(PWHAT IN CHAR, PDIALOGID IN NUMBER, PITEMNAME IN VARCHAR, PCMD IN NUMBER)
 6573   IS
 6574     VCODE     TREFERENCERETAILER.CODE%TYPE;
 6575     VDIALOGID NUMBER;
 6576   BEGIN
 6577     IF (PWHAT = DIALOG.WT_ITEMPRE) THEN
 6578       IF (PITEMNAME = UPPER('ChildList')) THEN
 6579         VCODE := DIALOG.GETCURRENTRECORDNUMBER(PDIALOGID, PITEMNAME, 'Code');
 6580         VDIALOGID := GETDIALOG(VCODE);
 6581         DIALOG.EXEC(VDIALOGID);
 6582       END IF;
 6583     END IF;
 6584   EXCEPTION
 6585     WHEN OTHERS THEN
 6586       ERROR.SAVE(CPACKAGENAME || '.DialogChildListEH');
 6587       RAISE;
 6588   END;
 6589 
 6590 
 6591 
 6592 FUNCTION DIALOGADDRESSCOPY(PPARENTDIALOGID IN NUMBER, PFICODE IN NUMBER, PIDCLIENT IN NUMBER, PCLIENTTYPE IN NUMBER) RETURN NUMBER
 6593   IS
 6594     CPROCNAME               CONSTANT VARCHAR2(100) := CPACKAGENAME || '.DialogAddressCopy'; 
 6595     CEVENTHANDLERMETHODNAME CONSTANT VARCHAR2(100) := CPACKAGENAME || '.DialogAddressCopyEH';
 6596     CDIALOGWIDTH            CONSTANT PLS_INTEGER := 60;
 6597     CDIALOGHEIGHT           CONSTANT PLS_INTEGER := 7;
 6598     CBUTTONWIDTH            CONSTANT PLS_INTEGER := 12;
 6599     VISCORPORATE            BOOLEAN := PCLIENTTYPE = CCLIENTCORPORATE; 
 6600     VTEXT                   VARCHAR2(100) := SERVICE.IIF(VISCORPORATE, 'corporate', 'private'); 
 6601     VDIALOGID               NUMBER;
 6602   BEGIN
 6603     VDIALOGID := DIALOG.NEW('Copy address of '||VTEXT||' customer', 0, 0, CDIALOGWIDTH, CDIALOGHEIGHT, PEXTID => CPROCNAME);  
 6604       DIALOG.SETDIALOGVALID(VDIALOGID, CEVENTHANDLERMETHODNAME);
 6605 
 6606     DIALOG.LIST(VDIALOGID, 'AddressList', 1, 1, CDIALOGWIDTH-1, CDIALOGHEIGHT-3, '');
 6607       DIALOG.LISTADDFIELD(VDIALOGID, 'AddressList', 'Code', 'N', 1, 0);
 6608       DIALOG.LISTADDFIELD(VDIALOGID, 'AddressList', 'Name', 'C', 40, 1);
 6609 
 6610     IF (PIDCLIENT IS NOT NULL) THEN
 6611       IF VISCORPORATE THEN
 6612         DIALOG.LISTADDRECORD(VDIALOGID, 'AddressList', CAVLEGAL   || '~' || 'Legal address'||'~', DIALOG.CMOK);
 6613         DIALOG.LISTADDRECORD(VDIALOGID, 'AddressList', CAVCONTACT || '~' || 'Contact address'||'~', DIALOG.CMOK);
 6614         DIALOG.LISTADDRECORD(VDIALOGID, 'AddressList', CAVPOSTAL  || '~' || 'Postal address'||'~', DIALOG.CMOK);
 6615       ELSE 
 6616         DIALOG.LISTADDRECORD(VDIALOGID, 'AddressList', CAVLIVING  || '~' || 'Residence address'||'~', DIALOG.CMOK);
 6617         DIALOG.LISTADDRECORD(VDIALOGID, 'AddressList', CAVCONTACT || '~' || 'Contact address'||'~', DIALOG.CMOK);
 6618         DIALOG.LISTADDRECORD(VDIALOGID, 'AddressList', CAVREGISTER|| '~' || 'Registration address'||'~', DIALOG.CMOK);
 6619       END IF;
 6620     END IF;
 6621 
 6622     IF (PFICODE IS NOT NULL) THEN
 6623       DIALOG.LISTADDRECORD(VDIALOGID, 'AddressList', CAVDEFAULT || '~' || 'By default'||'~', DIALOG.CMOK);
 6624     END IF;
 6625 
 6626     DIALOG.BUTTON(VDIALOGID, 'Cancel', (CDIALOGWIDTH-CBUTTONWIDTH)/2, CDIALOGHEIGHT, CBUTTONWIDTH, 'Exit', DIALOG.CMCANCEL, 0);
 6627 
 6628     DIALOG.HIDDENNUMBER(VDIALOGID, 'ParentDialogId', PPARENTDIALOGID);
 6629     DIALOG.HIDDENNUMBER(VDIALOGID, 'FiCode', PFICODE);
 6630     DIALOG.HIDDENNUMBER(VDIALOGID, 'IdClient', PIDCLIENT);
 6631 
 6632     RETURN VDIALOGID;
 6633   END;
 6634 
 6635 
 6636 
 6637 PROCEDURE DIALOGADDRESSCOPYEH(PWHAT IN CHAR, PDIALOGID IN NUMBER, PITEMNAME IN VARCHAR, PCMD IN NUMBER)
 6638   IS
 6639     CBRANCH CONSTANT NUMBER := SEANCE.GETBRANCH();
 6640     VPARENTDIALOGID    NUMBER;
 6641     VADDRESSTYPE       TYPEADDRESSVALUE;
 6642     VFICODE            NUMBER;
 6643     VIDCLIENT          NUMBER;
 6644     VADDRESSINFO       APITYPES.ADDRESSINFO;
 6645     VCLIENTADDRESSTYPE CLIENT.TADDRESSTYPE;
 6646 
 6647     FUNCTION GETFIADDRESSINFO(PFICODE IN NUMBER) RETURN APITYPES.ADDRESSINFO
 6648       IS
 6649         VFIADDRESSINFO APITYPES.ADDRESSINFO;
 6650       BEGIN
 6651         SELECT COUNTRY_CODE, REGION_CODE, CITY_CODE
 6652           INTO VFIADDRESSINFO.COUNTRY, VFIADDRESSINFO.REGION, VFIADDRESSINFO.CITY
 6653           FROM TREFERENCERETAILER
 6654           WHERE BRANCH = CBRANCH
 6655             AND FICODE = PFICODE
 6656             AND IDENT = ' ';
 6657 
 6658         RETURN VFIADDRESSINFO;
 6659 
 6660       EXCEPTION
 6661         WHEN OTHERS THEN
 6662           RETURN NULL;
 6663       END;
 6664 
 6665   BEGIN
 6666     IF (PWHAT = DIALOG.WT_DIALOGVALID) THEN
 6667       IF (PCMD = DIALOG.CMOK) THEN
 6668         VPARENTDIALOGID := DIALOG.GETNUMBER(PDIALOGID, 'ParentDialogId');
 6669 
 6670         VADDRESSTYPE := DIALOG.GETCURRENTRECORDNUMBER(PDIALOGID, 'AddressList', 'Code');
 6671 
 6672         IF (VADDRESSTYPE = CAVDEFAULT) THEN
 6673           VFICODE := DIALOG.GETNUMBER(PDIALOGID, 'FiCode');
 6674 
 6675           VADDRESSINFO := GETFIADDRESSINFO(VFICODE);
 6676         ELSE
 6677           VIDCLIENT := DIALOG.GETNUMBER(PDIALOGID, 'IdClient');
 6678 
 6679           VCLIENTADDRESSTYPE := CASE VADDRESSTYPE
 6680                                   WHEN CAVLEGAL    THEN CLIENT.AT_LEGAL
 6681                                   WHEN CAVCONTACT  THEN CLIENT.AT_CONTACT
 6682                                   WHEN CAVPOSTAL   THEN CLIENT.AT_POSTAL
 6683                                   WHEN CAVLIVING   THEN CLIENT.AT_LIVING
 6684                                   WHEN CAVREGISTER THEN CLIENT.AT_REGISTER
 6685                                 END;
 6686 
 6687           VADDRESSINFO := CLIENT.GETADDRESSINFO(VIDCLIENT, VCLIENTADDRESSTYPE);
 6688         END IF;
 6689 
 6690         REFERENCECOUNTRY.SETDATA(VPARENTDIALOGID, VADDRESSINFO);
 6691       END IF;
 6692     END IF;
 6693   EXCEPTION
 6694     WHEN OTHERS THEN
 6695       ERROR.SAVE(CPACKAGENAME || '.DialogAddressCopyEH');
 6696       RAISE;
 6697   END;
 6698 
 6699 
 6700 
 6701 PROCEDURE DISABLEREIMBURSEMENT(PCODE NUMBER, PREIMBURSEMENT BOOLEAN)
 6702   IS
 6703     CPROCNAME   CONSTANT VARCHAR2(80) := CPACKAGENAME || '.DisableReimbursement';
 6704     VCURRENTROW TREFERENCERETAILER%ROWTYPE;
 6705     VROW        TREFERENCERETAILER%ROWTYPE;
 6706   BEGIN
 6707     VCURRENTROW := SROW;
 6708 
 6709     VROW := READOBJECT(PCODE);
 6710     ERROR.RAISEWHENERR();
 6711 
 6712     VROW.REIMBURSEMENT := HTOOLS.B2I(PREIMBURSEMENT);
 6713 
 6714     UPDATEOBJECT(VROW);
 6715     ERROR.RAISEWHENERR();
 6716 
 6717     SROW := VCURRENTROW;
 6718 
 6719   EXCEPTION
 6720     WHEN OTHERS THEN
 6721       ERROR.SAVE(CPROCNAME);
 6722       SROW := VCURRENTROW;
 6723       RAISE;
 6724   END;
 6725 
 6726 
 6727 FUNCTION GETCURRENTDLGUSERATTRIBUTES RETURN APITYPES.TYPEUSERPROPLIST IS
 6728   CPROCNAME CONSTANT VARCHAR2(80) := CPACKAGENAME || '.GetCurrentDlgUserAttributes';
 6729 BEGIN
 6730   S.SAY(CPROCNAME || ': start');
 6731   RETURN SCURRENTDLGUSERATTRIBUTES; 
 6732 EXCEPTION
 6733   WHEN OTHERS THEN
 6734     ERROR.SAVE(CPROCNAME);
 6735     RAISE;
 6736 END;
 6737 
 6738 PROCEDURE SETCURRENTDLGUSERATTRIBUTES (PAUSERPROPLIST APITYPES.TYPEUSERPROPLIST)
 6739  IS
 6740   CPROCNAME CONSTANT VARCHAR2(100) := CPACKAGENAME || '.SetCurrentDlgUserAttributes';
 6741  BEGIN
 6742    S.SAY(CPROCNAME || ': start');
 6743    SCURRENTDLGUSERATTRIBUTES :=  PAUSERPROPLIST;
 6744  END;
 6745 
 6746 
 6747 PROCEDURE SETUPDATED(PCODE NUMBER, PLOG BOOLEAN:=FALSE)
 6748   IS
 6749     CPROCNAME  CONSTANT VARCHAR2(80) := CPACKAGENAME || '.SetUpdated';
 6750     CBRANCH    CONSTANT NUMBER := SEANCE.GETBRANCH();
 6751     CCLERKCODE CONSTANT NUMBER := CLERK.GETCODE();
 6752   BEGIN
 6753     
 6754     SAVEPOINT SP_UPDATEOBJECT;
 6755     FOR VROW IN (SELECT * 
 6756               FROM TREFERENCERETAILER 
 6757               WHERE BRANCH = CBRANCH 
 6758               START WITH CODE = PCODE
 6759               CONNECT BY PRIOR CODE = PARENTCODE) LOOP
 6760       UPDATE TREFERENCERETAILER 
 6761          SET UPDATEDATE = SYSDATE(),
 6762              UPDATECLERK = CCLERKCODE
 6763       WHERE BRANCH = CBRANCH
 6764       AND CODE = VROW.CODE;
 6765       IF (PLOG) THEN
 6766         LOGCHANGES(A4MLOG.ACT_CHANGE, VROW, VROW, PONLYMAINPARAMS => TRUE);
 6767       END IF;
 6768       REFERENCETERMINAL.SETUPDATED(VROW.CODE);
 6769     END LOOP;   
 6770     
 6771     
 6772 
 6773 
 6774 
 6775 
 6776 
 6777 
 6778 
 6779  
 6780     
 6781   EXCEPTION
 6782     WHEN OTHERS THEN
 6783       ROLLBACK TO SP_UPDATEOBJECT;
 6784       ERROR.SAVE(CPROCNAME);
 6785       
 6786       RAISE;
 6787   END;
 6788 
 6789 
 6790 FUNCTION GETRETAILERCONTACTLIST (PCODE NUMBER) RETURN APITYPES.TYPERETAILERCONTACTLIST
 6791   IS
 6792     CPROCNAME CONSTANT VARCHAR2(80) := CPACKAGENAME || '.GetRetailerContactList';
 6793     CBRANCH   CONSTANT NUMBER := SEANCE.GETBRANCH();
 6794     VARETCONTACTLIST   APITYPES.TYPERETAILERCONTACTLIST;
 6795   BEGIN
 6796     S.SAY(CPROCNAME || ': start ['|| PCODE|| ']');
 6797 
 6798     SELECT ORDERNO, CLIENTIDLINK, FIO, POST, NOTE
 6799       BULK COLLECT INTO VARETCONTACTLIST FROM TREFERENCERETAILERCONTACTS
 6800      WHERE BRANCH = CBRANCH
 6801        AND RETAILERCODE = PCODE
 6802     ORDER BY ORDERNO;
 6803     RETURN VARETCONTACTLIST;
 6804   EXCEPTION
 6805     WHEN OTHERS THEN
 6806       ERROR.SAVE(CPROCNAME);
 6807       RAISE;
 6808   END;
 6809 
 6810 
 6811 
 6812 FUNCTION GETRETAILERRECORDBYDOCNO(PDOCNO IN NUMBER, PNO IN NUMBER) RETURN APITYPES.TYPERETAILERRECORD
 6813   IS
 6814     CPROCNAME CONSTANT VARCHAR2(80) := CPACKAGENAME || '.GetRetailerRecordByDocNo';
 6815     VENTRYREC    APITYPES.TYPEENTRYRECORD;
 6816     VRETAILERREC APITYPES.TYPERETAILERRECORD;
 6817     VERRCONTEXT  ERR.TYPECONTEXTREC;
 6818   BEGIN
 6819     S.SAY(CPROCNAME || ': start ['||PDOCNO||', '||PNO||']');
 6820     VERRCONTEXT := ERR.GETCONTEXT;
 6821     VENTRYREC := ENTRY.GETENTRYRECORD(PDOCNO, PNO);
 6822     ERROR.RAISEWHENERR();
 6823 
 6824     VRETAILERREC := REFERENCERETAILER.GETRETAILERRECORD(VENTRYREC.ACQUIRERCODE, VENTRYREC.RETAILERID);
 6825     ERROR.RAISEWHENERR();
 6826 
 6827     S.SAY(CPROCNAME || ': return record for '||VRETAILERREC.CODE);
 6828     ERR.PUTCONTEXT (VERRCONTEXT);
 6829     RETURN VRETAILERREC;
 6830   EXCEPTION
 6831     WHEN OTHERS THEN
 6832       ERROR.SAVE('GetRetailerRecordByDocNo');
 6833       RETURN NULL;
 6834   END;
 6835 
 6836 
 6837 
 6838 FUNCTION GETRETAILERRECORDBYCODE(PCODE IN NUMBER) RETURN APITYPES.TYPERETAILERRECORD
 6839   IS
 6840     CPROCNAME  CONSTANT VARCHAR(80) := 'ReferenceRetailer.GetRetailerRecordByCode';
 6841     VROW       TREFERENCERETAILER%ROWTYPE;
 6842   BEGIN
 6843     SELECT * INTO VROW
 6844       FROM TREFERENCERETAILER
 6845       WHERE CODE = PCODE;
 6846 
 6847     RETURN GETRETAILERRECORD(VROW.FICODE, VROW.IDENT);
 6848   EXCEPTION
 6849     WHEN NO_DATA_FOUND THEN
 6850       ERROR.SAVE(CPROCNAME);
 6851       ERROR.RAISEERROR(ERR.REFFI_UNDEFINED_RETAILER, '(Code: '||TO_CHAR(PCODE)||')');
 6852     WHEN OTHERS THEN
 6853       ERROR.SAVE(CPROCNAME);
 6854       RAISE;
 6855   END;
 6856 
 6857 
 6858 
 6859 
 6860 FUNCTION  GETACCOUNTFROMGROUPS(PCODE IN NUMBER, PCURRENCY IN NUMBER, PEXRACTROW IN APITYPES.TYPEEXTRACTRECORD) RETURN VARCHAR
 6861   IS
 6862     CPROCNAME CONSTANT VARCHAR(300):= CPACKAGENAME||'.GetAccountFromGroups';
 6863     CBRANCH   CONSTANT NUMBER := SEANCE.GETBRANCH();
 6864     VTYPE            NUMBER := NULL;
 6865     VCODE            NUMBER;
 6866     VOBJMODULE       NUMBER;
 6867     VRET             NUMBER;
 6868     VAGROUPS         TYPES.ARRNUM;  
 6869     VNAME            VARCHAR2(100); 
 6870   BEGIN
 6871     ERR.SETERROR(0, CPROCNAME);
 6872     VOBJMODULE  := RETAILERSQLTOOL.CBTACCOUNTGROUP; 
 6873 
 6874     VAGROUPS := ADDACCGROUP.GETADDACCGROUPLIST(ADDACCGROUP.C_OBJ_RET); 
 6875     FOR I IN 1..VAGROUPS.COUNT LOOP
 6876 
 6877       VCODE := DYNASQL.GETCODEBYIDENT(OBJECT.GETTYPE(OBJECT_NAME), VOBJMODULE, VAGROUPS(I));
 6878       VNAME := ADDACCGROUP.GETACCGROUPNAME(VAGROUPS(I));
 6879 
 6880       S.SAY(CPROCNAME||': pre-execute pl/sql script for '||VNAME||', vCode: '||VCODE, 12);
 6881 
 6882       IF (VCODE IS NOT NULL) THEN
 6883         DYNASQL.SETVALUENUM(VCODE, ':RET', 0);
 6884         REFERENCEFI.SETEXTRACTROW(PEXRACTROW);
 6885 
 6886         BEGIN
 6887           DYNASQL.RUNBATCH(VCODE, TRUE);
 6888         EXCEPTION
 6889           WHEN OTHERS THEN
 6890             S.SAY(CPROCNAME||': Error pl/sql script for '||VNAME,12);
 6891             ERR.SETERROR(ERR.UE_DATA_NOT_FOUND, CPROCNAME); 
 6892             RETURN NULL;
 6893         END;
 6894         VRET := DYNASQL.GETVALUENUM(VCODE, ':RET');
 6895         S.SAY(CPROCNAME||': post-execute pl/sql script for '||VNAME||', vRet: '||VRET,12);
 6896 
 6897         IF VRET = 1 THEN
 6898           S.SAY(CPROCNAME||': appropriate '||VNAME,12);
 6899           VTYPE := VAGROUPS(I);
 6900           EXIT;
 6901         END IF;
 6902       END IF;
 6903     END LOOP;
 6904 
 6905     S.SAY(CPROCNAME||': pre get account, vType: '||VTYPE, 12);
 6906 
 6907     IF (VTYPE IS NULL) THEN
 6908       RETURN NULL;
 6909     END IF;
 6910     FOR I IN (SELECT * FROM TACCTYPE2RET
 6911                WHERE BRANCH    = CBRANCH
 6912                  AND RET_CODE  = PCODE
 6913                  AND TYPE_CODE = VTYPE) LOOP
 6914       S.SAY(CPROCNAME||': get account for currency = '||PCURRENCY, 12);
 6915       RETURN RETAILERACCOUNTGROUP.GETACCOUNT(I.CODE, PCURRENCY);
 6916     END LOOP;
 6917 
 6918     ERR.SETERROR(ERR.REFFI_UNDEFINED_ACCOUNT, CPROCNAME);
 6919     RETURN NULL;
 6920  EXCEPTION
 6921   WHEN OTHERS THEN
 6922    ERR.SETERROR(ERR.REFFI_UNDEFINED_ACCOUNT, CPROCNAME);
 6923    RETURN NULL;
 6924   END;
 6925 
 6926 
 6927 PROCEDURE DELETERETAILER (PRETAILERROW TYPERETAILERROW, PLOG BOOLEAN) IS
 6928   CPROCNAME  CONSTANT VARCHAR2(100) := CPACKAGENAME || '.DeleteRetailer2';
 6929   CBRANCH    CONSTANT NUMBER := SEANCE.GETBRANCH();
 6930   VOBJECTUID        OBJECTUID.TYPEOBJECTUID;        
 6931   VIDENT            TREFERENCERETAILER.IDENT%TYPE;  
 6932   VOBJINFO          EXCHANGE.TYPEOBJECTINFORECORD; 
 6933   
 6934   
 6935   
 6936   
 6937   
 6938   
 6939   
 6940 BEGIN
 6941   
 6942   DELETE FROM TREFERENCERETAILER
 6943    WHERE BRANCH = CBRANCH
 6944      AND CODE   = PRETAILERROW.CODE
 6945    RETURNING OBJECTUID, IDENT
 6946         INTO VOBJECTUID, VIDENT
 6947    ;
 6948   
 6949   S.SAY('ReferenceRetailer.DeleteObject | ObjectUID: '||TO_CHAR(VOBJECTUID));
 6950   IF (VOBJECTUID IS NOT NULL) THEN
 6951     OBJUSERPROPERTY.DELETERECORD(OBJECT_NAME, VOBJECTUID);  
 6952     OBJECTUID.FREEUID(VOBJECTUID);
 6953   END IF;
 6954 
 6955   IF VIDENT != ' ' THEN
 6956     
 6957     VOBJINFO.LOCATOR     := TO_CHAR(PRETAILERROW.CODE);
 6958     VOBJINFO.OBJECTTYPE  := OBJECT.GETTYPE(OBJECT_NAME);
 6959     VOBJINFO.OPERTYPE    := EXCHANGE.COP_DELETE;
 6960     VOBJINFO.SYSTEMDATE  := SYSDATE;
 6961     VOBJINFO.OPERDATE    := SEANCE.GETOPERDATE;
 6962 
 6963     EXCHANGE.SETOBJECTINFO(VOBJINFO);
 6964 
 6965     
 6966     IF PLOG THEN
 6967       
 6968       
 6969 
 6970 
 6971 
 6972 
 6973 
 6974 
 6975 
 6976 
 6977 
 6978 
 6979 
 6980       LOGCHANGES(A4MLOG.ACT_DEL, PRETAILERROW);
 6981       
 6982 
 6983     END IF;
 6984 
 6985   END IF;
 6986 EXCEPTION
 6987   WHEN OTHERS THEN
 6988     ERROR.SAVE(CPROCNAME);
 6989     
 6990     
 6991 
 6992 
 6993 
 6994 
 6995 
 6996 
 6997 
 6998 
 6999 
 7000     
 7001     RAISE;
 7002 END;
 7003 
 7004 
 7005 PROCEDURE DELETERETAILER (PCODE NUMBER, PLOG BOOLEAN) IS
 7006   CPROCNAME  CONSTANT VARCHAR2(100) := CPACKAGENAME || '.DeleteRetailer';
 7007   CBRANCH    CONSTANT NUMBER := SEANCE.GETBRANCH();
 7008   VOLDROW           TYPERETAILERROW; 
 7009 BEGIN
 7010   S.SAY(CPROCNAME || ': start ['||PCODE || ', '||HTOOLS.B2S(PLOG)||']');
 7011   
 7012   IF PLOG THEN
 7013     SELECT * INTO VOLDROW FROM TREFERENCERETAILER
 7014      WHERE BRANCH = CBRANCH
 7015        AND CODE   = PCODE;
 7016   ELSE
 7017     VOLDROW.CODE  := PCODE;
 7018   END IF;
 7019 
 7020   DELETERETAILER(VOLDROW, PLOG);
 7021   
 7022   S.SAY(CPROCNAME || ': complete');
 7023 EXCEPTION
 7024   WHEN OTHERS THEN
 7025     ERROR.SAVE(CPROCNAME);
 7026     RAISE;
 7027 END;
 7028 
 7029 
 7030 FUNCTION GETLEGALCORPORATENAME (PCODE NUMBER, PNETWORKID NETWORK.TYPENETWORK) RETURN VARCHAR2
 7031   IS
 7032   BEGIN
 7033     RETURN RETAILEREXTPSNAME.GETLEGALCORPORATENAME(PCODE, PNETWORKID);
 7034   END;
 7035 
 7036 FUNCTION GETTIERNUMBERS (PCODE NUMBER, PNETWORKID NETWORK.TYPENETWORK) RETURN VARCHAR2
 7037   IS
 7038   BEGIN
 7039     RETURN RETAILEREXTPSNAME.GETTIERNUMBERS(PCODE, PNETWORKID);
 7040   END;
 7041 
 7042 FUNCTION GETTIERNUMBERLIST (PCODE NUMBER, PNETWORKID NETWORK.TYPENETWORK) RETURN NETWORKFIELDTYPE.TYPECOLLECTIONLIST
 7043   IS
 7044   BEGIN
 7045     RETURN RETAILEREXTPSNAME.GETTIERNUMBERLIST(PCODE, PNETWORKID);
 7046   END;
 7047 
 7048 
 7049 
 7050 
 7051 PROCEDURE RUNUPDATEVALUESBLOCK (PMODE TYPEMODE, PALTERATIONMODE TYPEALTERATIONMODE)
 7052   IS
 7053     CPROCNAME CONSTANT VARCHAR2(100) := CPACKAGENAME || '.RunUpdateValuesBlock';
 7054     VRES        NUMBER;
 7055   BEGIN
 7056     S.SAY(CPROCNAME || ': start ['||PMODE||', '||PALTERATIONMODE||']');
 7057     CONVERTROWTYPETOAPITYPES(SROW, SCURRENTRETAILERRECORD);
 7058     VRES := RETAILERSQLTOOL.RUNONE(RETAILERSQLTOOL.CBTUPDATEVALUES, RETAILERSQLTOOL.COIDENT, TRUE, PMODE, PALTERATIONMODE);
 7059     S.SAY(CPROCNAME || ': result='||VRES);
 7060     CONVERTAPITYPESTOROWTYPE(SCURRENTRETAILERRECORD, SROW);
 7061     SCURRENTRETAILERRECORD := EMPTYRETAILERRECORD;
 7062   EXCEPTION
 7063     WHEN OTHERS THEN
 7064       CONVERTAPITYPESTOROWTYPE(SCURRENTRETAILERRECORD, SROW);
 7065       SETCURRENTRECORD(EMPTYRETAILERRECORD);
 7066       CLEARCURRENTUSERPROPLIST;
 7067       ERROR.SAVE(CPROCNAME);
 7068       RAISE;
 7069   END;
 7070 
 7071 PROCEDURE RUNSAVECONTROLBLOCK (PMODE TYPEMODE, PALTERATIONMODE TYPEALTERATIONMODE)
 7072   IS
 7073     CPROCNAME CONSTANT VARCHAR2(100) := CPACKAGENAME || '.RunSaveControlBlock';
 7074     VRES      NUMBER;
 7075   BEGIN
 7076     S.SAY(CPROCNAME || ': start');
 7077     CONVERTROWTYPETOAPITYPES(SROW, SCURRENTRETAILERRECORD);
 7078 
 7079     VRES := RETAILERSQLTOOL.RUNONE(RETAILERSQLTOOL.CBTSAVE, RETAILERSQLTOOL.COIDENT, TRUE, PMODE, PALTERATIONMODE); 
 7080     
 7081     CONVERTAPITYPESTOROWTYPE(SCURRENTRETAILERRECORD, SROW);
 7082     
 7083     SETCURRENTRECORD(EMPTYRETAILERRECORD);
 7084     S.SAY(CPROCNAME || ': result='||VRES);
 7085   EXCEPTION
 7086     WHEN OTHERS THEN
 7087       
 7088       CONVERTAPITYPESTOROWTYPE(SCURRENTRETAILERRECORD, SROW);
 7089       
 7090       SETCURRENTRECORD(EMPTYRETAILERRECORD);
 7091       CLEARCURRENTUSERPROPLIST;
 7092       ERROR.SAVE(CPROCNAME);
 7093       RAISE;
 7094   END;
 7095 
 7096  PROCEDURE SETCURRENTUSERPROPLIST (PAUSERPROPLIST APITYPES.TYPEUSERPROPLIST)
 7097    IS
 7098     CPROCNAME CONSTANT VARCHAR2(100) := CPACKAGENAME || '.SetCurrentUserPropList';
 7099    BEGIN
 7100      S.SAY(CPROCNAME || ': start');
 7101      SCURRENTUSERPROPLIST :=  PAUSERPROPLIST;
 7102    END;
 7103 
 7104  PROCEDURE CLEARCURRENTUSERPROPLIST
 7105    IS
 7106     CPROCNAME CONSTANT VARCHAR2(100) := CPACKAGENAME || '.ClearCurrentUserPropList';
 7107    BEGIN
 7108      S.SAY(CPROCNAME || ': start');
 7109      SCURRENTUSERPROPLIST.DELETE;
 7110      SCURRENTDLGUSERATTRIBUTES.DELETE;
 7111    END;
 7112 
 7113 FUNCTION GETCURRENTUSERPROPLIST RETURN APITYPES.TYPEUSERPROPLIST
 7114   IS
 7115     CPROCNAME CONSTANT VARCHAR2(80) := CPACKAGENAME || '.GetCurrentUserPropList';
 7116   BEGIN
 7117     S.SAY(CPROCNAME || ': start');
 7118     RETURN SCURRENTUSERPROPLIST;
 7119   EXCEPTION
 7120     WHEN OTHERS THEN
 7121       ERROR.SAVE(CPROCNAME);
 7122       RAISE;
 7123   END;
 7124 
 7125  PROCEDURE SETCURRENTEXTATTRIBUTELIST (PAEXTPSNAMELIST APITYPES.TYPERETAILEREXTATTRIBUTELIST)
 7126    IS
 7127     CPROCNAME CONSTANT VARCHAR2(100) := CPACKAGENAME || '.SetCurrentExtAttributeList';
 7128    BEGIN
 7129      S.SAY(CPROCNAME || ': start ['||PAEXTPSNAMELIST.COUNT||']');
 7130      SCURRENTEXTATTRIBUTELIST :=  PAEXTPSNAMELIST;
 7131    END;
 7132 
 7133  PROCEDURE CLEARCURRENTEXTATTRIBUTELIST
 7134    IS
 7135     CPROCNAME CONSTANT VARCHAR2(100) := CPACKAGENAME || '.ClearCurrentExtAttributeList';
 7136    BEGIN
 7137      S.SAY(CPROCNAME || ': start');
 7138      SCURRENTEXTATTRIBUTELIST.DELETE;
 7139    END;
 7140 
 7141 FUNCTION GETCURRENTEXTATTRIBUTELIST RETURN APITYPES.TYPERETAILEREXTATTRIBUTELIST
 7142   IS
 7143     CPROCNAME CONSTANT VARCHAR2(80) := CPACKAGENAME || '.GetCurrentExtAttributeList';
 7144   BEGIN
 7145     S.SAY(CPROCNAME || ': return '||SCURRENTEXTATTRIBUTELIST.COUNT);
 7146     RETURN SCURRENTEXTATTRIBUTELIST;
 7147   EXCEPTION
 7148     WHEN OTHERS THEN
 7149       ERROR.SAVE(CPROCNAME);
 7150       RAISE;
 7151   END;
 7152 
 7153 
 7154 
 7155 PROCEDURE CHECKOPTIONNAME(POPTIONNAME IN VARCHAR2)
 7156   IS
 7157 BEGIN
 7158   IF(POPTIONNAME NOT IN (CBONALLOWSAMERETACC)) THEN
 7159     ERROR.RAISEERROR(ERR.UE_VALUE_INCORRECT, 'Unknown parameter: '||POPTIONNAME);
 7160   END IF;
 7161 EXCEPTION
 7162   WHEN OTHERS THEN
 7163     ERROR.SAVE(CPACKAGENAME || '.CheckOptionName');
 7164     RAISE;
 7165 END;
 7166 
 7167 FUNCTION GETOPTION(POPTIONNAME IN VARCHAR2)
 7168   RETURN BOOLEAN IS
 7169   VOBJECTTYPE  NUMBER;
 7170   VOPTIONVALUE NUMBER;
 7171 BEGIN
 7172   ERR.SETERROR(0, CPACKAGENAME || '.GetOption');
 7173 
 7174   CHECKOPTIONNAME(POPTIONNAME);
 7175 
 7176   VOBJECTTYPE := OBJECT.GETTYPE(OBJECT_NAME);
 7177 
 7178   VOPTIONVALUE := DATAMEMBER.GETNUMBER(VOBJECTTYPE, 0, POPTIONNAME);
 7179   ERROR.RAISEWHENERR();
 7180 
 7181   IF(VOPTIONVALUE > 0) THEN
 7182     RETURN TRUE;
 7183   END IF;
 7184 
 7185   RETURN FALSE;
 7186 EXCEPTION
 7187   WHEN OTHERS THEN
 7188     ERROR.SAVE(CPACKAGENAME || '.GetOption');
 7189     RAISE;
 7190 END;
 7191 
 7192 PROCEDURE SETOPTION(POPTIONNAME IN VARCHAR2, POPTIONVALUE IN BOOLEAN)
 7193   IS
 7194   VOBJECTTYPE  NUMBER;
 7195   VOPTIONVALUE NUMBER;
 7196   VRESULT      NUMBER;
 7197 BEGIN
 7198   ERR.SETERROR(0, CPACKAGENAME || '.SetOption');
 7199 
 7200   CHECKOPTIONNAME(POPTIONNAME);
 7201 
 7202   IF(POPTIONVALUE) THEN
 7203     VOPTIONVALUE := 1;
 7204   ELSE
 7205     VOPTIONVALUE := 0;
 7206   END IF;
 7207 
 7208   VOBJECTTYPE := OBJECT.GETTYPE(OBJECT_NAME);
 7209 
 7210   VRESULT := DATAMEMBER.SETNUMBER(VOBJECTTYPE, 0, POPTIONNAME, VOPTIONVALUE,
 7211                                   'Indicator of whether it is allowed to use coinciding retailer accounts');
 7212   ERROR.RAISEWHENERR();
 7213 EXCEPTION
 7214   WHEN OTHERS THEN
 7215     ERROR.SAVE(CPACKAGENAME || '.SetOption');
 7216     RAISE;
 7217 END;
 7218 
 7219 
 7220 
 7221 PROCEDURE PUTPARAMLIST(PLOGLISTNO NUMBER, POLDROW TYPERETAILERROW := CEMPTYROW, PNEWROW TYPERETAILERROW := CEMPTYROW, PONLYMAINPARAMS BOOLEAN := FALSE) IS
 7222   CWHERE   CONSTANT VARCHAR2(100) := CPACKAGENAME || '.PutParamList';
 7223   VOLDFIID VARCHAR2(100);
 7224   VNEWFIID VARCHAR2(100);
 7225 BEGIN
 7226   
 7227   IF POLDROW.FICODE IS NOT NULL THEN
 7228     VOLDFIID := REFERENCEFI.GETFIID(POLDROW.FICODE);
 7229   END IF;
 7230   IF PNEWROW.FICODE IS NOT NULL THEN
 7231     VNEWFIID := REFERENCEFI.GETFIID(PNEWROW.FICODE);
 7232   END IF;
 7233   
 7234   A4MLOG.ADDPARAMREC('FIID',             VOLDFIID,                                               VNEWFIID,                                                   PLOGLISTNO, FALSE);  
 7235   A4MLOG.ADDPARAMREC('Ident',            POLDROW.IDENT,                                          PNEWROW.IDENT,                                              PLOGLISTNO, FALSE);  
 7236   IF NOT PONLYMAINPARAMS THEN
 7237     A4MLOG.ADDPARAMREC('External_Ident',   POLDROW.EXTERNAL_IDENT,                                 PNEWROW.EXTERNAL_IDENT,                                     PLOGLISTNO);  
 7238     A4MLOG.ADDPARAMREC('Name',             POLDROW.NAME,                                           PNEWROW.NAME,                                               PLOGLISTNO);  
 7239     A4MLOG.ADDPARAMREC('MCC',              POLDROW.EXTERNAL_SICCODE,                               PNEWROW.EXTERNAL_SICCODE,                                   PLOGLISTNO);
 7240     A4MLOG.ADDPARAMREC('BranchPart',       POLDROW.BRANCHPART,                                     PNEWROW.BRANCHPART,                                         PLOGLISTNO);
 7241     A4MLOG.ADDPARAMREC('Code_Client',      POLDROW.CODE_CLIENT,                                    PNEWROW.CODE_CLIENT,                                        PLOGLISTNO);
 7242     A4MLOG.ADDPARAMREC('Country_Code',     POLDROW.COUNTRY_CODE,                                   PNEWROW.COUNTRY_CODE,                                       PLOGLISTNO);
 7243     A4MLOG.ADDPARAMREC('Region_Code',      POLDROW.REGION_CODE,                                    PNEWROW.REGION_CODE,                                        PLOGLISTNO);
 7244     A4MLOG.ADDPARAMREC('Address',          POLDROW.ADDRESS,                                        PNEWROW.ADDRESS,                                            PLOGLISTNO);
 7245     A4MLOG.ADDPARAMREC('External_ZIpcode', POLDROW.EXTERNAL_ZIPCODE,                               PNEWROW.EXTERNAL_ZIPCODE,                                   PLOGLISTNO);
 7246     A4MLOG.ADDPARAMREC('House',            POLDROW.HOUSE,                                          PNEWROW.HOUSE,                                              PLOGLISTNO);
 7247     A4MLOG.ADDPARAMREC('Building',         POLDROW.BUILDING,                                       PNEWROW.BUILDING,                                           PLOGLISTNO);
 7248     A4MLOG.ADDPARAMREC('Frame',            POLDROW.FRAME,                                          PNEWROW.FRAME,                                              PLOGLISTNO);
 7249     A4MLOG.ADDPARAMREC('Flat',             POLDROW.FLAT,                                           PNEWROW.FLAT,                                               PLOGLISTNO);
 7250     A4MLOG.ADDPARAMREC('MerchantID',       POLDROW.MERCHANTID,                                     PNEWROW.MERCHANTID,                                         PLOGLISTNO);
 7251     A4MLOG.ADDPARAMREC('ParentCode',       POLDROW.PARENTCODE,                                     PNEWROW.PARENTCODE,                                         PLOGLISTNO);
 7252     A4MLOG.ADDPARAMREC('Reimbursement',    HTOOLS.B2S(HTOOLS.I2B(NVL(POLDROW.REIMBURSEMENT, 0))),  HTOOLS.B2S(HTOOLS.I2B(NVL(PNEWROW.REIMBURSEMENT, 0))),      PLOGLISTNO);
 7253     A4MLOG.ADDPARAMREC('AnyPOSRefund',     HTOOLS.B2S(HTOOLS.I2B(NVL(POLDROW.ANYPOSREFUND, 0))),   HTOOLS.B2S(HTOOLS.I2B(NVL(PNEWROW.ANYPOSREFUND, 0))),       PLOGLISTNO); 
 7254 
 7255 
 7256 
 7257     A4MLOG.ADDPARAMREC('Branch',           POLDROW.BRANCH,                                         PNEWROW.BRANCH,                                            PLOGLISTNO);
 7258     A4MLOG.ADDPARAMREC('Code',             POLDROW.CODE,                                           PNEWROW.CODE,                                              PLOGLISTNO);
 7259     A4MLOG.ADDPARAMREC('AccountGroupCode', POLDROW.ACCOUNTGROUPCODE,                               PNEWROW.ACCOUNTGROUPCODE,                                  PLOGLISTNO);
 7260 
 7261     A4MLOG.ADDPARAMREC('ExternalCity',     POLDROW.EXTERNAL_CITY,                                  PNEWROW.EXTERNAL_CITY,                                     PLOGLISTNO);
 7262     A4MLOG.ADDPARAMREC('ExternalCountry',  POLDROW.EXTERNAL_COUNTRY,                               PNEWROW.EXTERNAL_COUNTRY,                                  PLOGLISTNO);
 7263     A4MLOG.ADDPARAMREC('ExternalIdent',    POLDROW.EXTERNAL_IDENT,                                 PNEWROW.EXTERNAL_IDENT,                                    PLOGLISTNO);
 7264     A4MLOG.ADDPARAMREC('ExternalName',     POLDROW.EXTERNAL_NAME,                                  PNEWROW.EXTERNAL_NAME,                                     PLOGLISTNO);
 7265     A4MLOG.ADDPARAMREC('ExternalCpsCode',  POLDROW.EXTERNAL_CPSCODE,                               PNEWROW.EXTERNAL_CPSCODE,                                  PLOGLISTNO);
 7266 
 7267     A4MLOG.ADDPARAMREC('PanEntryType',     POLDROW.PANENTRYTYPE,                                   PNEWROW.PANENTRYTYPE,                                      PLOGLISTNO);
 7268     A4MLOG.ADDPARAMREC('HolderAuthType',   POLDROW.HOLDERAUTHTYPE,                                 PNEWROW.HOLDERAUTHTYPE,                                    PLOGLISTNO);
 7269     A4MLOG.ADDPARAMREC('BankName',         POLDROW.BANKNAME,                                       PNEWROW.BANKNAME,                                          PLOGLISTNO);
 7270     A4MLOG.ADDPARAMREC('BankAccount',      POLDROW.BANKACCOUNT,                                    PNEWROW.BANKACCOUNT,                                       PLOGLISTNO);
 7271     A4MLOG.ADDPARAMREC('BIC',              POLDROW.BIC,                                            PNEWROW.BIC,                                               PLOGLISTNO);
 7272     A4MLOG.ADDPARAMREC('ExternalAccount',  POLDROW.EXTERNALACCOUNT,                                PNEWROW.EXTERNALACCOUNT,                                   PLOGLISTNO);
 7273     A4MLOG.ADDPARAMREC('Inn',              POLDROW.INN,                                            PNEWROW.INN,                                               PLOGLISTNO);
 7274     A4MLOG.ADDPARAMREC('Country',          POLDROW.COUNTRY,                                        PNEWROW.COUNTRY,                                           PLOGLISTNO);
 7275     A4MLOG.ADDPARAMREC('City',             POLDROW.CITY,                                           PNEWROW.CITY,                                              PLOGLISTNO);
 7276     A4MLOG.ADDPARAMREC('Phones',           POLDROW.PHONES,                                         PNEWROW.PHONES,                                            PLOGLISTNO);
 7277     A4MLOG.ADDPARAMREC('Email',            POLDROW.EMAIL,                                          PNEWROW.EMAIL,                                             PLOGLISTNO);
 7278     A4MLOG.ADDPARAMREC('HaveTransit',      HTOOLS.B2S(POLDROW.HAVETRANSIT IS NOT NULL),            HTOOLS.B2S(PNEWROW.HAVETRANSIT IS NOT NULL),               PLOGLISTNO);
 7279     A4MLOG.ADDPARAMREC('ActiveAccount',    POLDROW.ACC_ACT,                                        PNEWROW.ACC_ACT,                                           PLOGLISTNO);
 7280     A4MLOG.ADDPARAMREC('PassiveAccount',   POLDROW.ACC_PASS,                                       PNEWROW.ACC_PASS,                                          PLOGLISTNO);
 7281     A4MLOG.ADDPARAMREC('PostalCode',       POLDROW.POSTALCODE,                                     PNEWROW.POSTALCODE,                                        PLOGLISTNO);
 7282     A4MLOG.ADDPARAMREC('Region',           POLDROW.REGION_CODE,                                    PNEWROW.REGION_CODE,                                       PLOGLISTNO);
 7283     A4MLOG.ADDPARAMREC('Fax',              POLDROW.FAX,                                            PNEWROW.FAX,                                               PLOGLISTNO);
 7284     A4MLOG.ADDPARAMREC('Profile',          POLDROW.PROFILE,                                        PNEWROW.PROFILE,                                           PLOGLISTNO);
 7285     A4MLOG.ADDPARAMREC('Street',           POLDROW.STREET,                                         PNEWROW.STREET,                                            PLOGLISTNO);
 7286 
 7287     A4MLOG.ADDPARAMREC('IsPrototype',
 7288                         SERVICE.IIF(POLDROW.ISPROTOTYPE=2,
 7289                                     'true',
 7290                                     SERVICE.IIF(POLDROW.ISPROTOTYPE IN (0, 1), 'false', NULL)),
 7291                         SERVICE.IIF(PNEWROW.ISPROTOTYPE=2,
 7292                                     'true',
 7293                                     SERVICE.IIF(PNEWROW.ISPROTOTYPE IN (0, 1), 'false', NULL)),
 7294                         PLOGLISTNO);
 7295 
 7296     A4MLOG.ADDPARAMREC('Prototype',        POLDROW.PROTOTYPE,                                      PNEWROW.PROTOTYPE,                                         PLOGLISTNO);
 7297     A4MLOG.ADDPARAMREC('Note',             POLDROW.NOTE,                                           PNEWROW.NOTE,                                              PLOGLISTNO);
 7298     A4MLOG.ADDPARAMREC('Inactive',         HTOOLS.B2S(NVL(POLDROW.INACTIVE, CACTIVE) = CINACTIVE), HTOOLS.B2S(NVL(PNEWROW.INACTIVE, CACTIVE) = CINACTIVE),    PLOGLISTNO);
 7299     A4MLOG.ADDPARAMREC('Location',         POLDROW.LOCATION,                                       PNEWROW.LOCATION,                                          PLOGLISTNO);
 7300     A4MLOG.ADDPARAMREC('Merchantid',       POLDROW.MERCHANTID,                                     PNEWROW.MERCHANTID,                                        PLOGLISTNO);
 7301     A4MLOG.ADDPARAMREC('ObjectUID',        POLDROW.OBJECTUID,                                      PNEWROW.OBJECTUID,                                         PLOGLISTNO);
 7302     A4MLOG.ADDPARAMREC('ParentInActive',
 7303                         HTOOLS.B2S(NVL(POLDROW.PARENTINACTIVE, CACTIVE) = CINACTIVE),
 7304                         HTOOLS.B2S(NVL(PNEWROW.PARENTINACTIVE, CACTIVE) = CINACTIVE),
 7305                         PLOGLISTNO);
 7306 
 7307     A4MLOG.ADDPARAMREC('LimitGRP',         POLDROW.LIMITGRP,                                       PNEWROW.LIMITGRP,                                          PLOGLISTNO);
 7308     A4MLOG.ADDPARAMREC('LimitCyrrency',    POLDROW.LIMITCURRENCY,                                  PNEWROW.LIMITCURRENCY,                                     PLOGLISTNO);
 7309   END IF;
 7310 EXCEPTION
 7311   WHEN OTHERS THEN
 7312     ERROR.SAVE(CWHERE);
 7313     RAISE;
 7314 END;
 7315 
 7316 
 7317 
 7318 FUNCTION GETDYNASQLLOCATOR RETURN VARCHAR2 IS
 7319 BEGIN
 7320   RETURN OBJECT_NAME;
 7321 END;
 7322 
 7323 FUNCTION DESCRIBESCRIPT(PLOCATOR VARCHAR2) RETURN VARCHAR2 IS
 7324   CWHERE     CONSTANT VARCHAR2(100) := CPACKAGENAME || '.DescribeScript';
 7325   CROOTDESCR CONSTANT VARCHAR2(100) := 'Retailers';
 7326   VRET                VARCHAR2(1000);
 7327   VROOTLOCATOR        VARCHAR2(1000);
 7328   VLASTPART           VARCHAR2(1000);
 7329 BEGIN
 7330   VROOTLOCATOR := GETDYNASQLLOCATOR || '/';
 7331   IF INSTR(PLOCATOR, VROOTLOCATOR, 1, 1) = 1 THEN
 7332     VLASTPART := SUBSTR(PLOCATOR, LENGTH(VROOTLOCATOR)+1);
 7333     VRET := CROOTDESCR || '/' || RETAILERSQLTOOL.DESCRIBESCRIPT(VLASTPART);
 7334   ELSE
 7335     ERROR.RAISEERROR(ERR.UE_VALUE_INCORRECT, 'Invalid object');
 7336   END IF;
 7337 
 7338   RETURN VRET;
 7339 EXCEPTION
 7340   WHEN OTHERS THEN
 7341      ERROR.SAVE(CWHERE || ' ['||PLOCATOR||']');
 7342     RETURN PLOCATOR;
 7343 END;
 7344 
 7345 
 7346 
 7347 FUNCTION GETLOGREMARK (POLDROW TYPERETAILERROW := CEMPTYROW, PNEWROW TYPERETAILERROW := CEMPTYROW) RETURN VARCHAR2 IS
 7348   CWHERE CONSTANT VARCHAR2(100) := CPACKAGENAME || '.GetLogRemark';
 7349   VTEXT  VARCHAR2(32767);
 7350   
 7351   PROCEDURE PUTTEXT(PTEXT IN VARCHAR) IS
 7352     BEGIN
 7353       IF VTEXT IS NOT NULL THEN
 7354         VTEXT := VTEXT || ', ';
 7355       END IF;
 7356       VTEXT := VTEXT || PTEXT;
 7357     END;
 7358   
 7359   BEGIN
 7360     IF NOT HTOOLS.EQUAL(POLDROW.IDENT, PNEWROW.IDENT) THEN
 7361       PUTTEXT('ID ('||POLDROW.IDENT||'->'||PNEWROW.IDENT||')');
 7362     ELSE
 7363       PUTTEXT('ID ('||POLDROW.IDENT||')' );
 7364     END IF;
 7365 
 7366     IF NOT HTOOLS.EQUAL(POLDROW.EXTERNAL_SICCODE, PNEWROW.EXTERNAL_SICCODE) THEN
 7367       PUTTEXT('MCC ('||POLDROW.EXTERNAL_SICCODE ||'->'|| PNEWROW.EXTERNAL_SICCODE||')');
 7368     END IF;
 7369 
 7370     IF NOT HTOOLS.EQUAL(POLDROW.BRANCHPART, PNEWROW.BRANCHPART) THEN
 7371       PUTTEXT('Branch ('||POLDROW.BRANCHPART||'->'||PNEWROW.BRANCHPART||')');
 7372     END IF;
 7373 
 7374     IF NOT HTOOLS.EQUAL(POLDROW.CODE_CLIENT, PNEWROW.CODE_CLIENT) THEN
 7375       PUTTEXT('Customer ID ('||POLDROW.CODE_CLIENT||'->'||PNEWROW.CODE_CLIENT||')');
 7376     END IF;
 7377 
 7378     IF NOT HTOOLS.EQUAL(POLDROW.COUNTRY_CODE, PNEWROW.COUNTRY_CODE) THEN
 7379       PUTTEXT('Country ('||POLDROW.COUNTRY_CODE||'->'||PNEWROW.COUNTRY_CODE||')');
 7380     END IF;
 7381 
 7382     IF NOT HTOOLS.EQUAL(POLDROW.REGION_CODE, PNEWROW.REGION_CODE) THEN
 7383       PUTTEXT('Region ('||POLDROW.REGION_CODE||'->'||PNEWROW.REGION_CODE||')');
 7384     END IF;
 7385 
 7386     IF NOT HTOOLS.EQUAL(POLDROW.CITY_CODE, PNEWROW.CITY_CODE) THEN
 7387       PUTTEXT('City ('||POLDROW.CITY_CODE||'->'||PNEWROW.CITY_CODE||')');
 7388     END IF;
 7389 
 7390     IF NOT HTOOLS.EQUAL(POLDROW.ADDRESS, PNEWROW.ADDRESS) THEN
 7391       PUTTEXT('Address ('||POLDROW.ADDRESS||'->'||PNEWROW.ADDRESS||')');
 7392     END IF;
 7393 
 7394     IF NOT HTOOLS.EQUAL(POLDROW.EXTERNAL_ZIPCODE, PNEWROW.EXTERNAL_ZIPCODE) THEN
 7395       PUTTEXT('Postal code ('||POLDROW.EXTERNAL_ZIPCODE||'->'||PNEWROW.EXTERNAL_ZIPCODE||')');
 7396     END IF;
 7397 
 7398     IF NOT HTOOLS.EQUAL(POLDROW.STREET, PNEWROW.STREET) THEN
 7399       PUTTEXT('Street ('||POLDROW.STREET||'->'||PNEWROW.STREET||')');
 7400     END IF;
 7401 
 7402     IF NOT HTOOLS.EQUAL(POLDROW.HOUSE, PNEWROW.HOUSE) THEN
 7403       PUTTEXT('House ('||POLDROW.HOUSE||'->'||PNEWROW.HOUSE||')');
 7404     END IF;
 7405 
 7406     IF NOT HTOOLS.EQUAL(POLDROW.BUILDING, PNEWROW.BUILDING) THEN
 7407       PUTTEXT('Building ('||POLDROW.BUILDING||'->'||PNEWROW.BUILDING||')');
 7408     END IF;
 7409 
 7410     IF NOT HTOOLS.EQUAL(POLDROW.FRAME, PNEWROW.FRAME) THEN
 7411       PUTTEXT('Frame ('||POLDROW.FRAME||'->'||PNEWROW.FRAME||')');
 7412     END IF;
 7413 
 7414     IF NOT HTOOLS.EQUAL(POLDROW.FLAT, PNEWROW.FLAT) THEN
 7415       PUTTEXT('Flat ('||POLDROW.FLAT||'->'||PNEWROW.FLAT||')');
 7416     END IF;
 7417 
 7418     
 7419     IF NVL(POLDROW.INACTIVE,0) != NVL(PNEWROW.INACTIVE, 0) THEN
 7420       PUTTEXT('Inactive ('||HTOOLS.IIF(NVL(POLDROW.INACTIVE,0)=CINACTIVE,'true','false')||'->'||HTOOLS.IIF(NVL(PNEWROW.INACTIVE,0)=CINACTIVE,'true','false')||')');
 7421     END IF;
 7422     
 7423     
 7424     IF (POLDROW.MERCHANTID IS NULL AND PNEWROW.MERCHANTID IS NOT NULL) OR (POLDROW.MERCHANTID IS NOT NULL AND PNEWROW.MERCHANTID IS NULL) OR (RTRIM(POLDROW.MERCHANTID) != RTRIM(PNEWROW.MERCHANTID)) THEN
 7425       PUTTEXT('Merchant ID ('||POLDROW.MERCHANTID ||'->'|| PNEWROW.MERCHANTID||')');
 7426     END IF;
 7427     
 7428 
 7429     
 7430     IF (POLDROW.PARENTCODE IS NULL AND PNEWROW.PARENTCODE IS NOT NULL) OR (POLDROW.PARENTCODE != PNEWROW.PARENTCODE) OR (POLDROW.PARENTCODE IS NOT NULL AND PNEWROW.PARENTCODE IS NULL) THEN
 7431       PUTTEXT('Parent retailer code ('||POLDROW.PARENTCODE||'->'||PNEWROW.PARENTCODE||')');
 7432     END IF;
 7433     
 7434 
 7435     
 7436     IF (POLDROW.EXTERNAL_IDENT IS NULL AND PNEWROW.EXTERNAL_IDENT IS NOT NULL) OR (POLDROW.EXTERNAL_IDENT != PNEWROW.EXTERNAL_IDENT) OR (POLDROW.EXTERNAL_IDENT IS NOT NULL AND PNEWROW.EXTERNAL_IDENT IS NULL) THEN
 7437       PUTTEXT('External identifier ('||POLDROW.EXTERNAL_IDENT||'->'||PNEWROW.EXTERNAL_IDENT||')');
 7438     END IF;
 7439     
 7440 
 7441     
 7442     IF NVL(POLDROW.REIMBURSEMENT, 0) != NVL(PNEWROW.REIMBURSEMENT, 0) THEN
 7443       PUTTEXT('Indicator of suspending reimbursement ('||HTOOLS.B2S(HTOOLS.I2B(NVL(POLDROW.REIMBURSEMENT,0)))||'->'||HTOOLS.B2S(HTOOLS.I2B(NVL(PNEWROW.REIMBURSEMENT,0)))||')');
 7444     END IF;
 7445     
 7446     
 7447     IF NVL(POLDROW.ANYPOSREFUND, 0) != NVL(PNEWROW.ANYPOSREFUND, 0) THEN
 7448       PUTTEXT('Indicator of whether to permit refund/adjustment on different POS terminals ('||HTOOLS.B2S(HTOOLS.I2B(NVL(POLDROW.ANYPOSREFUND,0)))||'->'||HTOOLS.B2S(HTOOLS.I2B(NVL(PNEWROW.ANYPOSREFUND,0)))||')');
 7449     END IF;
 7450     
 7451 
 7452     RETURN VTEXT;
 7453 EXCEPTION
 7454   WHEN OTHERS THEN
 7455     ERROR.SAVE(CWHERE);
 7456     RAISE;
 7457 END;
 7458 
 7459 PROCEDURE LOGCHANGES (PACTION A4MLOG.TYPEACTION,  POLDROW TYPERETAILERROW := CEMPTYROW, PNEWROW TYPERETAILERROW := CEMPTYROW, PREMARK VARCHAR2 := NULL, PONLYMAINPARAMS IN BOOLEAN := FALSE) IS
 7460   CWHERE CONSTANT VARCHAR2(100) := CPACKAGENAME || '.LogChanges';
 7461   VLISTNO NUMBER;
 7462   VREMARK VARCHAR2(32767) := PREMARK;
 7463   VERRCONTEXT ERR.TYPECONTEXTREC := ERR.GETCONTEXT; 
 7464 BEGIN
 7465   S.SAY(CWHERE||'start with pAction='||PACTION); 
 7466   VLISTNO := A4MLOG.GETFREEPLISTNO();
 7467   A4MLOG.CLEANPLIST(VLISTNO);
 7468   PUTPARAMLIST(VLISTNO, POLDROW, PNEWROW, PONLYMAINPARAMS);
 7469   IF VREMARK IS NULL THEN
 7470     CASE PACTION
 7471       WHEN A4MLOG.ACT_CHANGE THEN
 7472         VREMARK := SUBSTR('Modify retailer '||TO_CHAR(PNEWROW.CODE)||' ('||GETLOGREMARK(POLDROW,PNEWROW)||')', 1, 4000);
 7473       WHEN A4MLOG.ACT_ADD THEN
 7474         VREMARK := 'Add retailer '||TO_CHAR(PNEWROW.CODE) ;
 7475       WHEN A4MLOG.ACT_DEL THEN
 7476         VREMARK := 'Delete retailer '||TO_CHAR(POLDROW.CODE);
 7477       ELSE
 7478        ERROR.RAISEERROR(ERR.UE_VALUE_INCORRECT, 'Unknown action');
 7479     END CASE;
 7480   END IF;
 7481 
 7482   TOLOG(SROW.CODE, VREMARK, PACTION, VLISTNO); 
 7483   A4MLOG.CLEANPLIST(VLISTNO);
 7484   ERR.PUTCONTEXT(VERRCONTEXT);
 7485 EXCEPTION
 7486   WHEN OTHERS THEN
 7487     ERROR.SAVE(CWHERE);
 7488     RAISE;
 7489 END;
 7490 
 7491 
 7492 
 7493 BEGIN
 7494   SARRACCINFO(1):='Active';
 7495   SARRACCINFO(2):='Liability';
 7496   
 7497 END;